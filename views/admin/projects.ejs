<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Projects - Morti Projects</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0a1628; --bg-primary: #0f1d32; --bg-card: #142640;
            --bg-glass: rgba(15, 29, 50, 0.6); --border-glass: rgba(255, 255, 255, 0.08);
            --border-glass-hover: rgba(255, 255, 255, 0.15); --accent: #1199fa;
            --accent-glow: rgba(17, 153, 250, 0.4); --accent-dim: rgba(17, 153, 250, 0.12);
            --accent-secondary: #009e7e; --accent-purple: #8b5cf6;
            --text-primary: #f0f4f8; --text-secondary: rgba(240, 244, 248, 0.7);
            --text-muted: rgba(240, 244, 248, 0.4); --radius: 16px; --radius-pill: 50px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-deep); color: var(--text-primary); line-height: 1.6; -webkit-font-smoothing: antialiased; }
        a { text-decoration: none; color: inherit; }
        .main { max-width: 1200px; margin: 0 auto; padding: 24px; min-height: calc(100vh - 200px); }
        .card { background: var(--bg-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-glass); border-radius: var(--radius); padding: 24px; margin-bottom: 20px; transition: border-color 0.3s; }
        .card:hover { border-color: var(--border-glass-hover); }
        .card h2 { margin-bottom: 16px; color: var(--text-primary); font-size: 1.3rem; font-weight: 700; }
        .card h3 { margin-bottom: 12px; color: var(--text-secondary); font-size: 1.1rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 10px 24px; border-radius: var(--radius-pill); font-size: 0.88rem; font-weight: 600; cursor: pointer; transition: all 0.3s; border: none; color: #fff; text-decoration: none; }
        .btn { background: var(--accent); box-shadow: 0 0 20px var(--accent-glow); }
        .btn:hover { background: #2aa8ff; transform: translateY(-2px); }
        .btn-sm { padding: 6px 14px; font-size: 0.78rem; }
        .btn-success { background: var(--accent-secondary); box-shadow: 0 0 16px rgba(0,158,126,0.3); }
        .btn-danger { background: #ef4444; box-shadow: 0 0 16px rgba(239,68,68,0.3); }
        .btn-secondary { background: rgba(255,255,255,0.1); box-shadow: none; border: 1px solid var(--border-glass); }
        .btn-secondary:hover { background: rgba(255,255,255,0.15); }
        .table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        .table th, .table td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border-glass); }
        .table th { background: rgba(15,29,50,0.4); font-weight: 600; color: var(--text-muted); font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.06em; }
        .table tbody tr:hover { background: rgba(17,153,250,0.05); }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state .emoji { font-size: 48px; margin-bottom: 16px; display: block; }
        .empty-state h3 { margin-bottom: 8px; color: var(--text-secondary); }
        @media (max-width: 768px) { .main { padding: 16px; } .card { padding: 16px; } }
    </style>
</head>
<body>
    <%- include('../partials/admin-nav', { currentPage: 'projects', user: user }) %>

    <main class="main">
        <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>üìä All Projects</h2>
        <div style="display:flex;gap:8px;align-items:center">
            <a href="/admin/projects/archived" style="color:var(--accent);text-decoration:none;font-size:14px;margin-right:8px;">üì¶ View Archived</a>
            <span style="color: var(--text-muted); font-size: 14px; margin-right: 8px;"><%= projects.length %> total projects</span>
            <button onclick="document.getElementById('importModal').style.display='flex'" class="btn btn-sm">üì• Import Project</button>
        </div>
    </div>

    <% if (projects.length > 0) { %>
        <table class="table">
            <thead>
                <tr>
                    <th>Project Details</th>
                    <th>Customer</th>
                    <th>Activity</th>
                    <th>Status</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <% projects.forEach(project => { %>
                    <tr>
                        <td>
                            <strong><%= project.name %></strong><br>
                            <% if (project.description) { %>
                                <small style="color: var(--text-muted);"><%= project.description.substring(0, 60) %><%= project.description.length > 60 ? '...' : '' %></small>
                            <% } else { %>
                                <small style="color: var(--text-muted); font-style: italic;">No description</small>
                            <% } %>
                        </td>
                        <td>
                            <strong><%= project.company %></strong><br>
                            <small style="color: var(--text-muted);"><%= project.user_name %></small><br>
                            <small style="color: var(--text-muted);"><%= project.email %></small>
                        </td>
                        <td style="font-size: 13px; color: var(--text-secondary);">
                            <div>üí¨ <%= project.session_count || 0 %> sessions</div>
                            <div>üìé <%= project.file_count || 0 %> files</div>
                            <% 
                            const createdDays = Math.floor((Date.now() - new Date(project.created_at)) / (1000 * 60 * 60 * 24));
                            const updatedDays = Math.floor((Date.now() - new Date(project.updated_at)) / (1000 * 60 * 60 * 24));
                            %>
                            <div style="color: var(--text-muted);">Created <%= createdDays %>d ago</div>
                        </td>
                        <td>
                            <% if (project.status === 'active') { %>
                                <span style="background: rgba(0,158,126,0.12); color: var(--accent-secondary); padding: 4px 12px; border-radius: 50px; font-size: 12px; font-weight: 600;">‚óè Active</span>
                            <% } else if (project.status === 'completed') { %>
                                <span style="background: var(--accent-dim); color: var(--accent); padding: 4px 12px; border-radius: 50px; font-size: 12px; font-weight: 600;">‚óè Completed</span>
                                <% if (project.design_review_requested) { %>
                                    <span style="background:rgba(245,158,11,0.15);color:#f59e0b;font-size:10px;padding:2px 8px;border-radius:50px;margin-left:4px;font-weight:600;">üîî Needs Review</span>
                                <% } %>
                            <% } else { %>
                                <span style="background: rgba(239,68,68,0.12); color: #ef4444; padding: 4px 12px; border-radius: 50px; font-size: 12px; font-weight: 600;">‚óè Archived</span>
                            <% } %>
                        </td>
                        <td style="color: var(--text-secondary);">
                            <%= melbDate(project.updated_at) %><br>
                            <small style="color: var(--text-muted);"><%= new Date(project.updated_at).toLocaleTimeString() %></small>
                        </td>
                        <td>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <a href="/admin/projects/<%= encodeId(project.id) %>" class="btn btn-sm">üëÅÔ∏è View</a>
                                <% if (project.session_count > 0) { %>
                                    <button onclick="exportProject("<%= encodeId(project.id) %>")" class="btn btn-sm btn-secondary">üì¶ Export</button>
                                <% } %>
                                <form method="POST" action="/admin/projects/<%= encodeId(project.id) %>/delete" onsubmit="return confirm('Delete this project? This cannot be undone.')" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    <% } else { %>
        <div class="empty-state">
            <span class="emoji">üìä</span>
            <h3>No projects yet</h3>
            <p>Customer projects will appear here when they start creating them</p>
        </div>
    <% } %>
</div>

<% if (projects.filter(p => p.status === 'active').length > 0) { %>
<div class="card" style="margin-top: 20px;">
    <h3>üìà Project Activity Summary</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
        <div style="text-align: center; padding: 16px; background: rgba(0,158,126,0.08); border: 1px solid rgba(0,158,126,0.15); border-radius: var(--radius);">
            <div style="font-size: 20px; font-weight: bold; color: var(--accent-secondary);"><%= projects.filter(p => p.status === 'active').length %></div>
            <div style="font-size: 12px; color: var(--text-muted);">Active Projects</div>
        </div>
        <div style="text-align: center; padding: 16px; background: var(--accent-dim); border: 1px solid rgba(17,153,250,0.15); border-radius: var(--radius);">
            <div style="font-size: 20px; font-weight: bold; color: var(--accent);"><%= projects.reduce((sum, p) => sum + (p.session_count || 0), 0) %></div>
            <div style="font-size: 12px; color: var(--text-muted);">Total Sessions</div>
        </div>
        <div style="text-align: center; padding: 16px; background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.15); border-radius: var(--radius);">
            <div style="font-size: 20px; font-weight: bold; color: #f59e0b;"><%= projects.reduce((sum, p) => sum + (p.file_count || 0), 0) %></div>
            <div style="font-size: 12px; color: var(--text-muted);">Files Uploaded</div>
        </div>
        <div style="text-align: center; padding: 16px; background: rgba(139,92,246,0.08); border: 1px solid rgba(139,92,246,0.15); border-radius: var(--radius);">
            <div style="font-size: 20px; font-weight: bold; color: var(--accent-purple);"><%= projects.filter(p => p.status === 'completed').length %></div>
            <div style="font-size: 12px; color: var(--text-muted);">Completed</div>
        </div>
    </div>
</div>
<% } %>

<script>
async function exportProject(projectId) {
    try {
        const response = await fetch(`/api/projects/${projectId}/export`);
        if (!response.ok) throw new Error('Export failed');
        const blob = await response.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `project-${projectId}-export-${new Date().toISOString().split('T')[0]}.zip`;
        a.click();
    } catch (e) {
        alert('Export failed: ' + e.message);
    }
}
</script>
    </main>

<!-- Import Modal -->
<div id="importModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(4px)" onclick="if(event.target===this)this.style.display='none'">
  <div style="background:var(--bg-card);border:1px solid var(--border-glass);border-radius:var(--radius);padding:28px;max-width:500px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.4)">
    <h3 style="margin-bottom:16px;color:var(--text-primary)">üì• Import Project from ZIP</h3>
    <p style="color:var(--text-muted);font-size:13px;margin-bottom:16px">Upload a project ZIP file (from the Export feature). It will create a new project with the requirements, transcript, and any asset files included.</p>
    <form method="POST" action="/admin/import-project" enctype="multipart/form-data">
      <div style="margin-bottom:12px">
        <label style="font-weight:600;font-size:13px;color:var(--text-secondary);display:block;margin-bottom:4px">Project Name (optional ‚Äî auto-detected from ZIP)</label>
        <input type="text" name="projectName" placeholder="Leave blank to auto-detect" style="width:100%;padding:10px;border:1px solid var(--border-glass);border-radius:12px;font-size:14px;background:rgba(5,13,26,0.6);color:var(--text-primary)" />
      </div>
      <div style="margin-bottom:12px">
        <label style="font-weight:600;font-size:13px;color:var(--text-secondary);display:block;margin-bottom:4px">Description (optional)</label>
        <input type="text" name="projectDescription" placeholder="Leave blank to auto-detect" style="width:100%;padding:10px;border:1px solid var(--border-glass);border-radius:12px;font-size:14px;background:rgba(5,13,26,0.6);color:var(--text-primary)" />
      </div>
      <div style="margin-bottom:16px">
        <label style="font-weight:600;font-size:13px;color:var(--text-secondary);display:block;margin-bottom:4px">ZIP File</label>
        <input type="file" name="zipfile" accept=".zip" required style="width:100%;padding:8px;font-size:14px;color:var(--text-secondary)" />
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button type="button" onclick="document.getElementById('importModal').style.display='none'" class="btn btn-sm btn-secondary">Cancel</button>
        <button type="submit" class="btn btn-sm">üì• Import</button>
      </div>
    </form>
  </div>
</div>
</body>
</html>
