<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Projects - Morti Projects</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; line-height: 1.6; }
        
        
        .main { max-width: 1200px; margin: 0 auto; padding: 20px; min-height: calc(100vh - 200px); }
        
        .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card h2 { margin-bottom: 16px; color: #333; font-size: 24px; }
        .card h3 { margin-bottom: 12px; color: #555; font-size: 18px; }
        
        .btn { display: inline-block; padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; font-size: 14px; }
        .btn:hover { background: #5a6fd8; transform: translateY(-1px); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        
        .table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        .table th, .table td { text-align: left; padding: 12px; border-bottom: 1px solid #e0e0e0; }
        .table th { background: #f8f9fa; font-weight: 600; color: #555; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        .table tbody tr:hover { background: #f8f9ff; }
        
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state .emoji { font-size: 48px; margin-bottom: 16px; display: block; }
        .empty-state h3 { margin-bottom: 8px; color: #666; }
        
        @media (max-width: 768px) {
            .main { padding: 16px; }
            .card { padding: 16px; }
        }
    </style>
</head>
<body>
    <%- include('../partials/admin-nav', { currentPage: 'projects', user: user }) %>

    <main class="main">
        <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>üìä All Projects</h2>
        <div style="display:flex;gap:8px;align-items:center">
            <a href="/admin/projects/archived" style="color:#667eea;text-decoration:none;font-size:14px;margin-right:8px;">üì¶ View Archived</a>
            <span style="color: #666; font-size: 14px; margin-right: 8px;"><%= projects.length %> total projects</span>
            <button onclick="document.getElementById('importModal').style.display='flex'" class="btn" style="background:#667eea;color:white;padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px">üì• Import Project</button>
        </div>
    </div>

    <% if (projects.length > 0) { %>
        <table class="table">
            <thead>
                <tr>
                    <th>Project Details</th>
                    <th>Customer</th>
                    <th>Activity</th>
                    <th>Status</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <% projects.forEach(project => { %>
                    <tr>
                        <td>
                            <strong><%= project.name %></strong><br>
                            <% if (project.description) { %>
                                <small style="color: #666;"><%= project.description.substring(0, 60) %><%= project.description.length > 60 ? '...' : '' %></small>
                            <% } else { %>
                                <small style="color: #999; font-style: italic;">No description</small>
                            <% } %>
                        </td>
                        <td>
                            <strong><%= project.company %></strong><br>
                            <small style="color: #666;"><%= project.user_name %></small><br>
                            <small style="color: #888;"><%= project.email %></small>
                        </td>
                        <td style="font-size: 13px;">
                            <div>üí¨ <%= project.session_count || 0 %> sessions</div>
                            <div>üìé <%= project.file_count || 0 %> files</div>
                            <% 
                            const createdDays = Math.floor((Date.now() - new Date(project.created_at)) / (1000 * 60 * 60 * 24));
                            const updatedDays = Math.floor((Date.now() - new Date(project.updated_at)) / (1000 * 60 * 60 * 24));
                            %>
                            <div style="color: #666;">Created <%= createdDays %>d ago</div>
                        </td>
                        <td>
                            <% if (project.status === 'active') { %>
                                <span style="background: #d4edda; color: #155724; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">‚óè Active</span>
                            <% } else if (project.status === 'completed') { %>
                                <span style="background: #d1ecf1; color: #0c5460; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">‚óè Completed</span>
                                <% if (project.design_review_requested) { %>
                                    <span style="background:#f59e0b;color:white;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:4px;font-weight:600;">üîî Needs Review</span>
                                <% } %>
                            <% } else { %>
                                <span style="background: #f8d7da; color: #721c24; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">‚óè Archived</span>
                            <% } %>
                        </td>
                        <td>
                            <%= melbDate(project.updated_at) %><br>
                            <small style="color: #666;"><%= new Date(project.updated_at).toLocaleTimeString() %></small>
                        </td>
                        <td>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <a href="/admin/projects/<%= encodeId(project.id) %>" class="btn btn-sm">üëÅÔ∏è View</a>
                                <% if (project.session_count > 0) { %>
                                    <button onclick="exportProject("<%= encodeId(project.id) %>")" class="btn btn-sm btn-secondary">üì¶ Export</button>
                                <% } %>
                                <form method="POST" action="/admin/projects/<%= encodeId(project.id) %>/delete" onsubmit="return confirm('Delete this project? This cannot be undone.')" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    <% } else { %>
        <div class="empty-state">
            <span class="emoji">üìä</span>
            <h3>No projects yet</h3>
            <p>Customer projects will appear here when they start creating them</p>
        </div>
    <% } %>
</div>

<% if (projects.filter(p => p.status === 'active').length > 0) { %>
<div class="card" style="margin-top: 20px;">
    <h3>üìà Project Activity Summary</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
        <div style="text-align: center; padding: 16px; background: #f8f9ff; border-radius: 8px;">
            <div style="font-size: 20px; font-weight: bold; color: #28a745;"><%= projects.filter(p => p.status === 'active').length %></div>
            <div style="font-size: 12px; color: #666;">Active Projects</div>
        </div>
        <div style="text-align: center; padding: 16px; background: #f8f9ff; border-radius: 8px;">
            <div style="font-size: 20px; font-weight: bold; color: #667eea;"><%= projects.reduce((sum, p) => sum + (p.session_count || 0), 0) %></div>
            <div style="font-size: 12px; color: #666;">Total Sessions</div>
        </div>
        <div style="text-align: center; padding: 16px; background: #f8f9ff; border-radius: 8px;">
            <div style="font-size: 20px; font-weight: bold; color: #ff9800;"><%= projects.reduce((sum, p) => sum + (p.file_count || 0), 0) %></div>
            <div style="font-size: 12px; color: #666;">Files Uploaded</div>
        </div>
        <div style="text-align: center; padding: 16px; background: #f8f9ff; border-radius: 8px;">
            <div style="font-size: 20px; font-weight: bold; color: #6c757d;"><%= projects.filter(p => p.status === 'completed').length %></div>
            <div style="font-size: 12px; color: #666;">Completed</div>
        </div>
    </div>
</div>
<% } %>

<script>
async function exportProject(projectId) {
    try {
        // This would need to be implemented similar to the project detail export functionality
        const response = await fetch(`/api/projects/${projectId}/export`);
        if (!response.ok) throw new Error('Export failed');
        
        const blob = await response.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `project-${projectId}-export-${new Date().toISOString().split('T')[0]}.zip`;
        a.click();
    } catch (e) {
        alert('Export failed: ' + e.message);
    }
}
</script>
    </main>

<!-- Import Modal -->
<div id="importModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center" onclick="if(event.target===this)this.style.display='none'">
  <div style="background:white;border-radius:12px;padding:28px;max-width:500px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.2)">
    <h3 style="margin-bottom:16px;color:#333">üì• Import Project from ZIP</h3>
    <p style="color:#666;font-size:13px;margin-bottom:16px">Upload a project ZIP file (from the Export feature). It will create a new project with the requirements, transcript, and any asset files included.</p>
    <form method="POST" action="/admin/import-project" enctype="multipart/form-data">
      <div style="margin-bottom:12px">
        <label style="font-weight:600;font-size:13px;color:#333;display:block;margin-bottom:4px">Project Name (optional ‚Äî auto-detected from ZIP)</label>
        <input type="text" name="projectName" placeholder="Leave blank to auto-detect" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:14px" />
      </div>
      <div style="margin-bottom:12px">
        <label style="font-weight:600;font-size:13px;color:#333;display:block;margin-bottom:4px">Description (optional)</label>
        <input type="text" name="projectDescription" placeholder="Leave blank to auto-detect" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:14px" />
      </div>
      <div style="margin-bottom:16px">
        <label style="font-weight:600;font-size:13px;color:#333;display:block;margin-bottom:4px">ZIP File</label>
        <input type="file" name="zipfile" accept=".zip" required style="width:100%;padding:8px;font-size:14px" />
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button type="button" onclick="document.getElementById('importModal').style.display='none'" style="padding:10px 20px;border:1px solid #ddd;border-radius:8px;background:white;cursor:pointer;font-size:14px">Cancel</button>
        <button type="submit" style="padding:10px 20px;border:none;border-radius:8px;background:#667eea;color:white;cursor:pointer;font-weight:600;font-size:14px">üì• Import</button>
      </div>
    </form>
  </div>
</div>
</body>
</html>