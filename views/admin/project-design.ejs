<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Morti Projects</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #0a1628;
      --bg-primary: #0f1d32;
      --bg-card: #142640;
      --bg-glass: rgba(15, 29, 50, 0.6);
      --border-glass: rgba(255, 255, 255, 0.08);
      --border-glass-hover: rgba(255, 255, 255, 0.15);
      --accent: #1199fa;
      --accent-glow: rgba(17, 153, 250, 0.4);
      --accent-dim: rgba(17, 153, 250, 0.12);
      --accent-secondary: #009e7e;
      --accent-purple: #8b5cf6;
      --text-primary: #f0f4f8;
      --text-secondary: rgba(240, 244, 248, 0.7);
      --text-muted: rgba(240, 244, 248, 0.4);
      --radius: 16px;
      --radius-pill: 50px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-deep); line-height:1.6; color: var(--text-primary); -webkit-font-smoothing: antialiased; }
    a { text-decoration: none; color: inherit; }
    .main { max-width:1100px; margin:0 auto; padding:24px 20px; }
    .back-link { font-size:13px; color: var(--text-muted); margin-bottom:16px; }
    .back-link a { color: var(--accent); text-decoration:none; display:inline-flex; align-items:center; gap:6px; }
    .back-link a:hover { text-decoration:underline; }
    .card { background: var(--bg-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-glass); border-radius: var(--radius); padding:24px; margin-bottom:20px; transition: border-color 0.3s; }
    .card:hover { border-color: var(--border-glass-hover); }
    .card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap; gap:12px; }
    .card-header h2 { font-size:20px; color: var(--text-primary); font-weight: 700; }
    .badge { display:inline-block; padding:4px 12px; border-radius: var(--radius-pill); font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
    .badge-draft { background: rgba(245,158,11,0.15); color: #f59e0b; border: 1px solid rgba(245,158,11,0.2); }
    .badge-final { background: rgba(0,158,126,0.12); color: var(--accent-secondary); border: 1px solid rgba(0,158,126,0.2); }
    .meta-row { display:flex; gap:24px; font-size:13px; color: var(--text-muted); margin-bottom:4px; }
    .btn { display:inline-flex; align-items:center; gap:6px; padding:8px 18px; border:none; border-radius: var(--radius-pill); font-weight:600; font-size:13px; cursor:pointer; transition:all 0.3s; text-decoration:none; color: #fff; }
    .btn:hover { transform:translateY(-1px); }
    .btn-primary { background: var(--accent); box-shadow: 0 0 16px var(--accent-glow); }
    .btn-primary:hover { background: #2aa8ff; box-shadow: 0 0 24px var(--accent-glow); }
    .btn-amber { background: #f59e0b; box-shadow: 0 0 12px rgba(245,158,11,0.3); }
    .btn-cyan { background: #06b6d4; box-shadow: 0 0 12px rgba(6,182,212,0.3); }
    .btn-sm { padding:6px 14px; font-size:12px; }
    .empty-state { text-align:center; padding:24px; color: var(--text-muted); font-size:14px; }

    /* Tabs */
    .tabs { display:flex; gap:0; border-bottom:1px solid var(--border-glass); margin-bottom:20px; }
    .tab { padding:12px 24px; font-size:14px; font-weight:600; color: var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; margin-bottom:-1px; transition:all 0.2s; user-select:none; }
    .tab:hover { color: var(--text-secondary); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-content { display:none; }
    .tab-content.active { display:block; }

    /* Customer View Cards */
    .section-card { background: var(--bg-card); border:1px solid var(--border-glass); border-radius:12px; padding:20px 24px; margin-bottom:16px; transition: border-color 0.3s; }
    .section-card:hover { border-color: var(--border-glass-hover); }
    .section-card h3 { font-size:15px; font-weight:700; color: var(--text-primary); margin-bottom:12px; display:flex; align-items:center; gap:8px; }
    .section-card h3 .icon { font-size:18px; }
    .section-body { font-size:14px; color: var(--text-secondary); line-height:1.7; }
    .section-body p { margin-bottom:8px; }
    .section-body strong { color: var(--text-primary); }

    /* Step Flow for HowItWorks */
    .step-flow { display:flex; flex-direction:column; gap:0; position:relative; padding-left:40px; }
    .step-flow::before { content:''; position:absolute; left:18px; top:20px; bottom:20px; width:2px; background:linear-gradient(to bottom, var(--accent), var(--accent-purple)); }
    .step-item { position:relative; padding:12px 16px 12px 20px; }
    .step-num { position:absolute; left:-40px; top:12px; width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg, var(--accent), #0077cc); color:#fff; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:700; box-shadow:0 2px 12px var(--accent-glow); z-index:1; }
    .step-title { font-weight:700; color: var(--text-primary); font-size:14px; margin-bottom:4px; }
    .step-desc { color: var(--text-muted); font-size:13px; line-height:1.5; }

    /* Build Spec (engine) items */
    .engine-section { background: var(--bg-card); border:1px solid var(--border-glass); border-radius:10px; padding:18px 22px; margin-bottom:14px; }
    .engine-section h4 { font-size:13px; text-transform:uppercase; letter-spacing:0.5px; color: var(--accent); margin-bottom:10px; font-weight:700; }
    .engine-section .section-body { font-size:13px; color: var(--text-secondary); }

    /* Questions */
    .question-card { padding:12px 16px; border-radius:10px; background: var(--bg-card); border:1px solid var(--border-glass); margin-bottom:10px; }
    .question-card .q-id { display:inline-block; background: var(--accent); color:white; width:24px; height:24px; border-radius:50%; text-align:center; line-height:24px; font-size:12px; font-weight:700; margin-right:8px; }
    .question-card .q-text { font-weight:600; color: var(--text-primary); font-size:14px; }
    .question-card .q-assumption { font-size:12px; color: var(--text-muted); margin-top:4px; font-style:italic; }
    .question-card .q-answer { margin-top:8px; padding:8px 12px; background: rgba(0,158,126,0.1); border:1px solid rgba(0,158,126,0.15); border-radius:8px; color: var(--accent-secondary); font-size:13px; }
    .answer-form { display:flex; gap:8px; margin-top:8px; }
    .answer-form input[type="text"] { flex:1; padding:8px 12px; border:1px solid var(--border-glass); border-radius:8px; font-size:13px; background: var(--bg-primary); color: var(--text-primary); }
    .answer-form input[type="text"]:focus { outline: none; border-color: var(--accent); }

    /* Chat */
    .chat-bubble { margin-bottom:10px; padding:10px 14px; border-radius:10px; background: var(--bg-card); border: 1px solid var(--border-glass); }
    .chat-bubble .chat-meta { font-size:12px; color: var(--text-muted); margin-bottom:4px; }
    .chat-bubble .chat-meta strong { color: var(--text-primary); }
    .chat-bubble .chat-text { font-size:14px; color: var(--text-secondary); }
    .chat-input { display:flex; gap:8px; margin-top:12px; }
    .chat-input textarea { flex:1; padding:10px; border:1px solid var(--border-glass); border-radius:10px; font-size:13px; font-family:inherit; resize:vertical; min-height:60px; background: var(--bg-primary); color: var(--text-primary); }
    .chat-input textarea:focus { outline: none; border-color: var(--accent); }

    /* Flowchart */
    #flowchartContainer { margin-top:16px; padding:24px; border:1px solid var(--border-glass); border-radius: var(--radius); background: var(--bg-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
    #flowchartRender { height:50vh; overflow:auto; padding:16px; border:1px solid var(--border-glass); border-radius:10px; background: #1a2d47; position:relative; display:flex; }
    #flowchartRender svg { display:block; margin:auto; flex-shrink:0; }
    .flowchart-zoom { display:flex; gap:6px; margin-bottom:12px; }
    .flowchart-zoom button { padding:4px 12px; border:1px solid var(--border-glass); border-radius:8px; background: var(--bg-card); cursor:pointer; font-size:14px; color: var(--text-secondary); transition: all 0.2s; }
    .flowchart-zoom button:hover { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
    .flowchart-error { color:#f87171; padding:16px; background: rgba(239,68,68,0.08); border:1px solid rgba(239,68,68,0.2); border-radius:10px; }
    .flowchart-error pre { font-size:11px; background: var(--bg-primary); padding:8px; border-radius:6px; overflow-x:auto; margin-top:8px; white-space:pre-wrap; color: var(--text-muted); }

    @media (max-width:768px) {
      .card-header { flex-direction:column; align-items:flex-start; }
      .step-flow { padding-left:36px; }
    }
  </style>
</head>
<body>
  <%- include('../partials/admin-nav', { currentPage: 'projects', user: user }) %>

  <main class="main">
    <div class="back-link">
      <a href="/admin/projects/<%= encodeId(projectId) %>">‚Üê Back to project</a>
    </div>

    <% if (locals.generating && !design) { %>
    <div class="card" style="text-align: center; padding: 60px;" id="genCard">
      <div style="font-size: 3rem; margin-bottom: 16px;" id="genSpinner">‚è≥</div>
      <h3 style="color: var(--accent); margin-bottom: 8px;" id="genTitle">Extracting Design...</h3>
      <p style="color: var(--text-muted);" id="genMsg">AI is analysing your project requirements and building a solution design. This usually takes 20-40 seconds.</p>
      <div style="margin-top: 16px; width: 200px; height: 4px; background: var(--bg-card); border-radius: 2px; margin-left: auto; margin-right: auto; overflow: hidden;">
        <div style="width: 30%; height: 100%; background: var(--accent); border-radius: 2px; animation: designProgress 2s ease-in-out infinite;"></div>
      </div>
    </div>
    <style>@keyframes designProgress { 0% { width: 10%; margin-left: 0; } 50% { width: 60%; margin-left: 20%; } 100% { width: 10%; margin-left: 90%; } }</style>
    <script>
    (function pollDesignStatus() {
      const projectId = '<%= projectId %>';
      let elapsed = 0;
      const interval = setInterval(async () => {
        elapsed += 2;
        try {
          const res = await fetch(`/admin/projects/${projectId}/generation-status`);
          const data = await res.json();
          if (data.status === 'done') { clearInterval(interval); window.location.reload(); }
          else if (data.status === 'error') {
            clearInterval(interval);
            document.getElementById('genSpinner').textContent = '‚ùå';
            document.getElementById('genTitle').textContent = 'Extraction Failed';
            document.getElementById('genTitle').style.color = '#f87171';
            document.getElementById('genMsg').textContent = data.error || 'Unknown error. Try again.';
          } else if (elapsed > 120) {
            clearInterval(interval);
            document.getElementById('genMsg').textContent = 'Taking longer than expected. Try refreshing the page.';
          }
        } catch(e) {}
      }, 2000);
    })();
    </script>
    <% } else if (locals.genError) { %>
    <div class="card" style="text-align: center; padding: 60px;">
      <div style="font-size: 3rem; margin-bottom: 16px;">‚ùå</div>
      <h3 style="color: #f87171; margin-bottom: 8px;">Design Extraction Failed</h3>
      <p style="color: var(--text-muted);"><%= locals.genError %></p>
      <a href="/admin/projects/<%= encodeId(projectId) %>" class="btn btn-primary" style="margin-top: 16px;">‚Üê Back to Project</a>
    </div>
    <% } else if (design) { %>
    <%
      // Detect new format vs old format
      const hasNewFormat = !!(design.customerDesign || design.engineDesign);
      const customerDesign = design.customerDesign || null;
      const engineDesign = design.engineDesign || null;
      // Fallback: old format sections
      let designSections = design.sections || null;
      let designSummary = design.summary || '';
      if (!designSections && !hasNewFormat) {
        try {
          if (design.designMarkdown && design.designMarkdown.trim().startsWith('```json')) {
            const jsonText = design.designMarkdown.replace(/```json\s*|```/g, '').trim();
            const parsed = JSON.parse(jsonText);
            if (parsed.design) designSections = parsed.design;
            if (parsed.summary) designSummary = parsed.summary;
          }
        } catch(e) {}
      }
    %>

    <% if (locals.generating) { %>
    <div style="background: var(--accent-dim); border:1px solid rgba(17,153,250,0.2); border-radius:12px; padding:12px 16px; margin-bottom:16px; display:flex; align-items:center; gap:12px;" id="refreshBanner">
      <div style="animation: spin 1s linear infinite; font-size:1.2rem;">‚è≥</div>
      <div style="flex:1;">
        <strong style="color: var(--accent);">Refreshing design...</strong>
        <span style="color: var(--text-secondary); font-size:0.9rem;"> AI is updating the design with new information.</span>
      </div>
    </div>
    <style>@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>
    <script>
    (function pollRefresh() {
      const projectId = '<%= projectId %>';
      const interval = setInterval(async () => {
        try {
          const res = await fetch(`/admin/projects/${projectId}/generation-status`);
          const data = await res.json();
          if (data.status === 'done' || data.status === 'error') { clearInterval(interval); window.location.reload(); }
        } catch(e) {}
      }, 2000);
    })();
    </script>
    <% } %>

    <!-- Header Card -->
    <div class="card">
      <div class="card-header">
        <div>
          <h2>üìê <%= projectName %> ‚Äî Solution Design</h2>
          <div class="meta-row" style="margin-top:8px;">
            <span>üë§ <%= design.owner %></span>
            <span>üìÖ <%= melb(design.createdAt) %></span>
            <% if (design.version) { %><span>v<%= design.version %></span><% } %>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <span class="badge <%= (design.status === 'final') ? 'badge-final' : 'badge-draft' %>"><%= design.status || 'draft' %></span>
          <form method="POST" action="/admin/projects/<%= encodeId(projectId) %>/extract-design" style="margin:0">
            <button type="submit" class="btn btn-amber btn-sm">üîÑ Refresh</button>
          </form>
          <button id="generateFlowchart" class="btn btn-cyan btn-sm">üó∫Ô∏è Flowchart</button>
          <% if (design.published) { %>
            <form method="POST" action="/admin/projects/<%= encodeId(projectId) %>/design/unpublish" style="margin:0">
              <button type="submit" class="btn btn-sm" style="background:#ef4444;color:white;">üîí Unpublish</button>
            </form>
            <span class="badge badge-final" style="font-size:10px;">Published <%= design.publishedAt ? melbDate(design.publishedAt) : '' %></span>
          <% } else { %>
            <form method="POST" action="/admin/projects/<%= encodeId(projectId) %>/design/publish" style="margin:0">
              <button type="submit" class="btn btn-sm" style="background: var(--accent-secondary);color:white;">üì§ Publish to Customer</button>
            </form>
          <% } %>
          <% if (design.approvedAt) { %>
            <span class="badge badge-final" style="font-size:10px;">‚úÖ Approved</span>
          <% } %>
          <% if (design.sentToEngineAt) { %>
            <span class="badge badge-final" style="font-size:10px;">‚úÖ Sent to Engine <%= melbDate(design.sentToEngineAt) %></span>
            <% if (design.enginePlanId) { %>
              <a href="<%= (process.env.ENGINE_API_URL || 'http://localhost:3100') %>/builds/<%= design.enginePlanId %>" target="_blank" class="btn btn-sm" style="background:#06b6d4;color:white;font-size:11px;">üîó View Build</a>
            <% } %>
          <% } else { %>
            <button id="sendToEngineBtn" onclick="toggleEnginePanel()" class="btn btn-sm" style="background: var(--accent-secondary);color:white;">üöÄ Send to Engine</button>
          <% } %>
        </div>
      </div>

      <!-- Send to Engine panel (hidden until button clicked) -->
      <div id="enginePanel" style="display:none;margin-bottom:16px;">
        <div class="card" style="border-color:rgba(0,158,126,0.3);">
          <h4 style="font-size:0.9rem;font-weight:700;margin-bottom:8px;">üöÄ Send to Morti Engine</h4>
          <p style="font-size:0.82rem;color:var(--text-muted);margin-bottom:12px;">Optional: add build guidance for the engine planner. Admin notes from the project are included automatically.</p>
          <textarea id="engineGuidance" rows="3" placeholder="e.g. Use Gemini not OpenAI for cost reasons, Customer is on Xero free tier..." style="width:100%;padding:10px 12px;background:rgba(5,13,26,0.6);border:1px solid var(--border-glass);border-radius:8px;color:var(--text-primary);font-family:inherit;font-size:0.85rem;line-height:1.6;resize:vertical;margin-bottom:10px;"></textarea>
          <div style="display:flex;gap:8px;align-items:center;">
            <button id="engineSendBtn" onclick="sendToEngine()" class="btn btn-sm" style="background:var(--accent-secondary);color:white;">üöÄ Confirm & Send</button>
            <button onclick="document.getElementById('enginePanel').style.display='none'" class="btn btn-sm" style="background:transparent;border:1px solid var(--border-glass);color:var(--text-secondary);">Cancel</button>
            <% if (!design.dataStore) { %>
              <span style="font-size:0.78rem;color:#f5c542;">‚ö†Ô∏è No dataStore in design ‚Äî engine will use defaults</span>
            <% } %>
          </div>
        </div>
      </div>

      <% if (hasNewFormat) { %>
        <!-- NEW FORMAT: Tabbed layout -->
        <div class="tabs">
          <div class="tab active" data-tab="customer">üìã Design Overview</div>
          <div class="tab" data-tab="workflows">üîÑ Workflows</div>
          <div class="tab" data-tab="assets">üì¶ Assets</div>
          <div class="tab" data-tab="engine">‚öôÔ∏è Build Spec</div>
        </div>

        <!-- Customer View Tab -->
        <div class="tab-content active" id="tab-customer">
          <% if (customerDesign) { %>
            <%
              const custSections = [
                { key: 'HowItWorks', label: 'How It Works', icon: '‚ö°' },
                { key: 'WhatYouGet', label: 'What You Get', icon: 'üéØ' },
                { key: 'WhatWeNeedFromYou', label: 'What We Need From You', icon: 'ü§ù' },
                { key: 'TimelineAndInvestment', label: 'Timeline & Investment', icon: 'üìÖ' },
                { key: 'AutomatedVsManual', label: 'Automated vs Manual', icon: 'ü§ñ' }
              ];
              const custKeys = Object.keys(customerDesign);
              const extraCustKeys = custKeys.filter(k => k !== 'ExecutiveSummary' && !custSections.find(s => s.key === k));
            %>
            <!-- Executive Summary first -->
            <% if (customerDesign.ExecutiveSummary) { %>
              <div class="section-card">
                <h3><span class="icon">üìã</span> Executive Summary</h3>
                <div class="section-body"><%- renderText(customerDesign.ExecutiveSummary) %></div>
              </div>
            <% } %>
            <!-- Flowchart right after Executive Summary -->
            <div id="flowchartContainer" style="<%= design.flowchart ? '' : 'display:none;' %>" class="card">
              <h3 style="margin-bottom:12px; color: var(--text-primary);">üó∫Ô∏è User Journey</h3>
              <div class="flowchart-zoom">
                <button onclick="zoomFlowchart(0.2)" title="Zoom In">‚ûï</button>
                <button onclick="zoomFlowchart(-0.2)" title="Zoom Out">‚ûñ</button>
                <button onclick="zoomFlowchart(0)" title="Reset Zoom">‚Ü∫ Reset</button>
                <button onclick="popOutFlowchart()" title="Open in new window">‚ßâ Pop Out</button>
              </div>
              <div id="flowchartRender"></div>
            </div>
            <!-- Remaining sections -->
            <% custSections.forEach(sec => { %>
              <% if (customerDesign[sec.key]) { %>
                <div class="section-card">
                  <h3><span class="icon"><%= sec.icon %></span> <%= sec.label %></h3>
                  <% if (sec.key === 'HowItWorks') { %>
                    <div class="step-flow" id="howItWorksFlow"></div>
                    <noscript><div class="section-body"><%- renderText(customerDesign[sec.key]) %></div></noscript>
                  <% } else { %>
                    <div class="section-body"><%- renderText(customerDesign[sec.key]) %></div>
                  <% } %>
                </div>
              <% } %>
            <% }) %>
            <% extraCustKeys.forEach(key => { %>
              <% if (customerDesign[key]) { %>
                <div class="section-card">
                  <h3><%= key.replace(/([A-Z])/g, ' $1').trim() %></h3>
                  <div class="section-body"><%- renderText(customerDesign[key]) %></div>
                </div>
              <% } %>
            <% }) %>
          <% } else { %>
            <div class="empty-state">No customer design sections generated yet.</div>
          <% } %>
        </div>

        <!-- Workflows Tab -->
        <div class="tab-content" id="tab-workflows">
          <% const workflows = design.workflows || []; %>
          <% if (workflows.length > 0) { %>
            <div style="display:grid;gap:16px;">
              <% workflows.forEach((wf, i) => { %>
                <div style="padding:20px;border-radius:12px;background:var(--bg-card);border:1px solid var(--border-glass);border-left:4px solid var(--accent);">
                  <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                    <span style="background:var(--accent);color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;"><%- wf.id ? wf.id.replace('wf-','') : (i+1) %></span>
                    <h4 style="margin:0;color:var(--text-primary);font-size:1rem;"><%= wf.name %></h4>
                  </div>
                  <div style="display:grid;gap:8px;font-size:0.88rem;">
                    <div><strong style="color:var(--accent);">Trigger:</strong> <span style="color:var(--text-secondary);"><%= wf.trigger %></span></div>
                    <div style="color:var(--text-secondary);"><%- renderText(wf.summary || '') %></div>
                    <% if (wf.steps) { %><div style="margin-top:8px;"><%- renderText(wf.steps) %></div><% } %>
                    <% if (wf.outputsTo) { %><div style="margin-top:4px;"><strong style="color:#8b5cf6;">‚Üí Outputs to:</strong> <span style="color:var(--text-secondary);"><%= wf.outputsTo %></span></div><% } %>
                  </div>
                </div>
              <% }) %>
            </div>
          <% } else { %>
            <div class="empty-state">No workflows identified yet. Re-extract the design to generate workflow analysis.</div>
          <% } %>
        </div>

        <!-- Assets Tab -->
        <div class="tab-content" id="tab-assets">
          <% const assets = design.assets || []; %>
          <% if (assets.length > 0) { %>
            <div style="display:grid;gap:16px;">
              <% assets.forEach(asset => { %>
                <div style="padding:20px;border-radius:12px;background:var(--bg-card);border:1px solid var(--border-glass);border-left:4px solid <%= asset.buildOrIntegrate === 'question' ? '#f59e0b' : (asset.buildOrIntegrate === 'build' ? '#009e7e' : '#8b5cf6') %>;">
                  <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                    <h4 style="margin:0;color:var(--text-primary);font-size:0.95rem;"><%= asset.name %></h4>
                    <span style="font-size:0.72rem;padding:2px 10px;border-radius:20px;background:rgba(17,153,250,0.12);color:var(--accent);font-weight:600;"><%= asset.type %></span>
                    <% if (asset.buildOrIntegrate === 'question') { %>
                      <span style="font-size:0.72rem;padding:2px 10px;border-radius:20px;background:rgba(245,158,11,0.12);color:#f59e0b;font-weight:600;">‚ùì Needs Clarification</span>
                    <% } else if (asset.buildOrIntegrate === 'build') { %>
                      <span style="font-size:0.72rem;padding:2px 10px;border-radius:20px;background:rgba(0,158,126,0.12);color:#009e7e;font-weight:600;">üî® Build New</span>
                    <% } else { %>
                      <span style="font-size:0.72rem;padding:2px 10px;border-radius:20px;background:rgba(139,92,246,0.12);color:#8b5cf6;font-weight:600;">üîó Integrate</span>
                    <% } %>
                  </div>
                  <div style="font-size:0.88rem;color:var(--text-secondary);margin-bottom:8px;"><%= asset.purpose %></div>
                  <% if (asset.buildNotes) { %><div style="font-size:0.82rem;color:var(--text-muted);padding:10px;background:rgba(5,13,26,0.4);border-radius:8px;margin-bottom:8px;"><%- renderText(asset.buildNotes) %></div><% } %>
                  <% if (asset.integrationNotes) { %><div style="font-size:0.82rem;color:#f59e0b;font-style:italic;">üí° <%= asset.integrationNotes %></div><% } %>
                  <% if (asset.linkedToWorkflows && asset.linkedToWorkflows.length) { %><div style="font-size:0.78rem;color:var(--text-muted);margin-top:6px;">Linked to: <%= asset.linkedToWorkflows.join(', ') %></div><% } %>
                </div>
              <% }) %>
            </div>
          <% } else { %>
            <div class="empty-state">No assets identified yet. Re-extract the design to generate asset analysis.</div>
          <% } %>
        </div>

        <!-- Build Spec Tab -->
        <div class="tab-content" id="tab-engine">
          <% if (engineDesign) { %>
            <%
              const engSections = [
                { key: 'TechnicalArchitecture', label: 'Technical Architecture', icon: 'üèóÔ∏è' },
                { key: 'DataModel', label: 'Data Model', icon: 'üóÑÔ∏è' },
                { key: 'IntegrationsAndAPIs', label: 'Integrations & APIs', icon: 'üîå' },
                { key: 'BuildSpecification', label: 'Build Specification', icon: 'üìê' },
                { key: 'RiskRegister', label: 'Risk Register', icon: '‚ö†Ô∏è' }
              ];
              const engKeys = Object.keys(engineDesign);
              const extraEngKeys = engKeys.filter(k => !engSections.find(s => s.key === k));
            %>
            <% engSections.forEach(sec => { %>
              <% if (engineDesign[sec.key]) { %>
                <div class="engine-section">
                  <h4><%= sec.icon %> <%= sec.label %></h4>
                  <div class="section-body"><%- renderText(engineDesign[sec.key]) %></div>
                </div>
              <% } %>
            <% }) %>
            <% extraEngKeys.forEach(key => { %>
              <% if (engineDesign[key]) { %>
                <div class="engine-section">
                  <h4><%= key.replace(/([A-Z])/g, ' $1').trim() %></h4>
                  <div class="section-body"><%- renderText(engineDesign[key]) %></div>
                </div>
              <% } %>
            <% }) %>
          <% } else { %>
            <div class="empty-state">No engine design sections generated yet.</div>
          <% } %>
        </div>

      <% } else if (designSections) { %>
        <!-- OLD FORMAT: Flat sections (backward compat) -->
        <%
          const sectionOrder = ['ExecutiveSummary','CoreWorkflow','SimplifiedArchitecture','MinimalDataModel','ManualVsAutomated','Assumptions','Dependencies','Phase2Enhancements','RisksAndMitigations','BuildEffortEstimate','CostBenefitAnalysis','TechnicalReadiness','TechnicalReference'];
          const sectionLabels = { ExecutiveSummary:'Executive Summary', CoreWorkflow:'Core Workflow', SimplifiedArchitecture:'Simplified Architecture', MinimalDataModel:'Minimal Data Model', ManualVsAutomated:'Manual vs Automated', Assumptions:'Assumptions', Dependencies:'Dependencies', Phase2Enhancements:'Phase 2 Enhancements (Out of Scope)', RisksAndMitigations:'Risks & Mitigations', BuildEffortEstimate:'Build Effort Estimate', CostBenefitAnalysis:'Cost / Benefit Analysis', TechnicalReadiness:'Technical Readiness', TechnicalReference:'Technical Reference' };
          const fullWidthSections = ['ExecutiveSummary','CoreWorkflow','SimplifiedArchitecture','MinimalDataModel','ManualVsAutomated','Phase2Enhancements','TechnicalReference'];
          const allKeys = Object.keys(designSections);
          const orderedKeys = sectionOrder.filter(k => designSections[k]);
          const extraKeys = allKeys.filter(k => !sectionOrder.includes(k));
          const renderKeys = orderedKeys.concat(extraKeys);
        %>
        <!-- Executive Summary first -->
        <% if (designSections.ExecutiveSummary) { %>
          <div style="padding:16px;border-radius:10px;background: var(--bg-card);border:1px solid var(--border-glass);margin-top:12px;">
            <h4 style="font-size:13px;text-transform:uppercase;letter-spacing:0.5px;color: var(--accent);margin-bottom:6px;">Executive Summary</h4>
            <div class="section-body"><%- renderText(designSections.ExecutiveSummary) %></div>
          </div>
        <% } %>
        <!-- Flowchart after Executive Summary (old format) -->
        <% if (!hasNewFormat) { %>
          <div id="flowchartContainer" style="<%= design.flowchart ? '' : 'display:none;' %>" class="card">
            <h3 style="margin-bottom:12px; color: var(--text-primary);">üó∫Ô∏è User Journey</h3>
            <div class="flowchart-zoom">
              <button onclick="zoomFlowchart(0.2)" title="Zoom In">‚ûï</button>
              <button onclick="zoomFlowchart(-0.2)" title="Zoom Out">‚ûñ</button>
              <button onclick="zoomFlowchart(0)" title="Reset Zoom">‚Ü∫ Reset</button>
              <button onclick="popOutFlowchart()" title="Open in new window">‚ßâ Pop Out</button>
            </div>
            <div id="flowchartRender"></div>
          </div>
        <% } %>
        <!-- Remaining sections -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px;">
          <% renderKeys.filter(k => k !== 'ExecutiveSummary').forEach(key => { %>
            <% if (designSections[key]) { %>
              <div style="padding:16px;border-radius:10px;background: var(--bg-card);border:1px solid var(--border-glass);<%= fullWidthSections.includes(key) ? 'grid-column:1/-1;' : '' %>">
                <h4 style="font-size:13px;text-transform:uppercase;letter-spacing:0.5px;color: var(--accent);margin-bottom:6px;"><%= sectionLabels[key] || key.replace(/([A-Z])/g, ' $1').trim() %></h4>
                <div class="section-body"><%- renderText(designSections[key]) %></div>
              </div>
            <% } %>
          <% }) %>
        </div>
      <% } else { %>
        <div class="empty-state">No design content generated yet. Click Refresh to generate.</div>
      <% } %>
    </div>

    <!-- Questions -->
    <div class="card">
      <h3 style="margin-bottom:12px; color: var(--text-primary);">‚ùì Outstanding Questions</h3>
      <% if (!design.questions || design.questions.length === 0) { %>
        <div class="empty-state">‚úÖ No outstanding questions ‚Äî design is complete based on available requirements.</div>
      <% } else { %>
        <% design.questions.forEach(function(q, i) { %>
          <%
            const isObj = (typeof q === 'object' && q !== null);
            const qText = isObj ? q.text : String(q);
            const qId = isObj ? q.id : (i+1);
            const qAssumption = isObj ? q.assumption : '';
            const answered = (design.answers || []).find(a => a.question === qText);
            const customerAnswered = (design.customerAnswers || []).find(a => a.question === qText);
            const assignedTo = isObj && q.assignedTo ? q.assignedTo : 'admin';
          %>
          <div class="question-card">
            <div>
              <span class="q-id"><%= qId %></span>
              <span class="q-text"><%= qText %></span>
            </div>
            <% if (qAssumption) { %>
              <div class="q-assumption">üí° <%= qAssumption %></div>
            <% } %>
            <% if (answered) { %>
              <div class="q-answer">‚úÖ <strong>Answer:</strong> <%= answered.answer %> <span style="font-size:11px;color: var(--text-muted);">‚Äî <%= answered.from %>, <%= melb(answered.ts) %></span></div>
            <% } else if (customerAnswered) { %>
              <div class="q-answer">‚úÖ <strong>Customer Answer:</strong> <%= customerAnswered.answer %> <span style="font-size:11px;color: var(--text-muted);">‚Äî <%= customerAnswered.from %>, <%= melb(customerAnswered.ts) %></span></div>
            <% } else { %>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <form method="POST" action="/admin/projects/<%= encodeId(projectId) %>/design/answer" class="answer-form" style="flex:1;margin-top:0;">
                  <input type="hidden" name="designId" value="<%= design.id %>" />
                  <input type="hidden" name="question" value="<%= qText %>" />
                  <input type="text" name="answer" placeholder="Type your answer‚Ä¶" />
                  <button type="submit" class="btn btn-primary btn-sm">Save</button>
                </form>
                <button onclick="assignQuestion(this, '<%= qText.replace(/'/g, "\\'") %>')" class="btn btn-sm" style="background:<%= assignedTo === 'customer' ? '#f59e0b' : 'rgba(255,255,255,0.08)' %>;color:white;white-space:nowrap;font-size:11px;">
                  üë§ <%= assignedTo === 'customer' ? 'Customer ‚úì' : 'Assign to Customer' %>
                </button>
                <% if (qAssumption) { %>
                <button onclick="acceptAssumption(this, '<%= qText.replace(/'/g, "\\'") %>', '<%= qAssumption.replace(/'/g, "\\'") %>')" class="btn btn-sm" style="background: var(--accent-purple);color:white;white-space:nowrap;font-size:11px;">
                  üí° Accept Assumption
                </button>
                <% } %>
              </div>
            <% } %>
          </div>
        <% }) %>
      <% } %>
    </div>

    <!-- Accepted Assumptions -->
    <% if (design.acceptedAssumptions && design.acceptedAssumptions.length > 0) { %>
    <div class="card" style="border-left: 4px solid var(--accent-purple);">
      <h3 style="margin-bottom:12px; color: var(--text-primary);">üí° Accepted Assumptions</h3>
      <p style="color: var(--text-muted); font-size:12px; margin-bottom:12px;">These assumptions were accepted in place of asking more questions. They are incorporated into the design on refresh.</p>
      <% design.acceptedAssumptions.forEach(function(a) { %>
        <div style="padding:10px 14px;background: rgba(139,92,246,0.08);border-left:3px solid var(--accent-purple);border-radius:0 10px 10px 0;margin-bottom:8px;">
          <div style="font-size:13px;color: var(--text-muted);">‚ùì <%= a.question %></div>
          <div style="font-size:14px;color: var(--text-primary);margin-top:4px;">üí° <strong>Assumption:</strong> <%= a.assumption %></div>
          <div style="font-size:11px;color: var(--text-muted);margin-top:4px;">Accepted by <%= a.acceptedBy %> ¬∑ <%= melb(a.ts) %></div>
        </div>
      <% }) %>
    </div>
    <% } %>

    <!-- AI Chat -->
    <div class="card">
      <h3 style="margin-bottom:12px; color: var(--text-primary);">ü§ñ AI Design Chat</h3>
      <div id="chatMessages" style="max-height:400px;overflow-y:auto;">
        <% if (!design.chat || design.chat.length === 0) { %>
          <div class="empty-state" id="chatEmpty">Ask the AI anything about this design ‚Äî refine sections, explore alternatives, or prepare for customer review.</div>
        <% } else { %>
          <% design.chat.forEach(function(c) { %>
            <div class="chat-bubble" style="<%= c.from === 'AI Assistant' ? 'background: var(--accent-dim); border-left:3px solid var(--accent);' : '' %>">
              <div class="chat-meta"><strong><%= c.from === 'AI Assistant' ? 'ü§ñ AI' : 'üë§ ' + c.from %></strong> ‚Äî <%= melb(c.ts) %></div>
              <div class="chat-text" style="white-space:pre-wrap;"><%= c.text %></div>
            </div>
          <% }) %>
        <% } %>
      </div>
      <div class="chat-input">
        <textarea id="chatInput" placeholder="Ask about the design, request changes, or discuss before publishing‚Ä¶" rows="2"></textarea>
        <button id="chatSendBtn" onclick="sendChat()" class="btn btn-primary" style="align-self:flex-end;">Send</button>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({
      startOnLoad: false,
      theme: 'dark',
      themeVariables: {
        primaryColor: '#1e3a5f', primaryTextColor: '#f0f4f8', primaryBorderColor: '#3399ff',
        lineColor: '#3399ff', secondaryColor: '#1a3352', tertiaryColor: '#1e3a5f',
        fontFamily: 'Inter, system-ui, -apple-system, sans-serif', fontSize: '14px',
        nodeBorder: '#3399ff', mainBkg: '#1e3a5f', clusterBkg: '#142640',
        clusterBorder: 'rgba(255,255,255,0.15)', edgeLabelBackground: '#1a3352',
        nodeTextColor: '#f0f4f8'
      }
    });

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
      });
    });

    // HowItWorks step flow rendering
    <% if (hasNewFormat && customerDesign && customerDesign.HowItWorks) { %>
    (function() {
      const text = `<%- (customerDesign.HowItWorks || '').replace(/`/g, '\\`').replace(/\\/g, '\\\\') %>`;
      const container = document.getElementById('howItWorksFlow');
      if (!container || !text) return;
      const lines = text.split('\n');
      const steps = [];
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        const m = line.match(/^(\d+)\.\s+\*\*(.+?)\*\*\s*[-‚Äî:]*\s*(.*)/);
        if (m) {
          let desc = m[3].trim();
          if (!desc) {
            for (let j = i+1; j < Math.min(i+4, lines.length); j++) {
              const next = lines[j].trim();
              if (next && !next.match(/^\d+\./)) { desc = next.replace(/^[-‚Ä¢]\s*/, ''); break; }
            }
          }
          steps.push({ num: m[1], title: m[2], desc: desc.substring(0, 200) });
        }
      }
      if (steps.length === 0) {
        // Fallback: just render as formatted text
        container.style.paddingLeft = '0';
        container.className = 'section-body';
        container.innerHTML = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        return;
      }
      container.innerHTML = steps.map(s =>
        '<div class="step-item">' +
          '<div class="step-num">' + s.num + '</div>' +
          '<div class="step-title">' + s.title + '</div>' +
          (s.desc ? '<div class="step-desc">' + s.desc + '</div>' : '') +
        '</div>'
      ).join('');
    })();
    <% } %>

    // Flowchart viewer ‚Äî native scroll with SVG resize
    let fcNaturalW = 0, fcNaturalH = 0, fcScale = 1, fcFitScale = 1;

    function fcApplyScale(newScale, clientX, clientY) {
      const el = document.getElementById('flowchartRender');
      const svg = el && el.querySelector('svg');
      if (!svg || !el) return;
      const oldScale = fcScale;
      fcScale = Math.max(0.1, Math.min(10, newScale));
      let svgX, svgY;
      if (clientX !== undefined) {
        const svgRect = svg.getBoundingClientRect();
        svgX = (clientX - svgRect.left) / oldScale;
        svgY = (clientY - svgRect.top) / oldScale;
      }
      svg.style.width = (fcNaturalW * fcScale) + 'px';
      svg.style.height = (fcNaturalH * fcScale) + 'px';
      if (clientX !== undefined) {
        const newSvgRect = svg.getBoundingClientRect();
        el.scrollLeft += (newSvgRect.left + svgX * fcScale) - clientX;
        el.scrollTop += (newSvgRect.top + svgY * fcScale) - clientY;
      }
    }

    function fitFlowchartToContainer() {
      const el = document.getElementById('flowchartRender');
      const svg = el && el.querySelector('svg');
      if (!svg || !el || !fcNaturalW) return;
      const pad = 32;
      if (svg.getAttribute('data-snake-reflow')) {
        // Snake-reflowed: viewBox AR matches container, so Math.min fills nearly 100%
        const sPad = 4;
        fcFitScale = Math.min((el.clientWidth - sPad) / fcNaturalW, (el.clientHeight - sPad) / fcNaturalH, 2);
        fcScale = fcFitScale;
        const renderedH = fcNaturalH * fcScale;
        svg.style.width = (fcNaturalW * fcScale) + 'px';
        svg.style.height = renderedH + 'px';
        // Center vertically if shorter than container
        if (renderedH < el.clientHeight - pad) {
          svg.style.marginTop = ((el.clientHeight - renderedH) / 2) + 'px';
          svg.style.marginLeft = 'auto';
          svg.style.marginRight = 'auto';
          svg.style.marginBottom = '0';
        } else {
          svg.style.margin = 'auto';
        }
      } else {
        fcFitScale = Math.min((el.clientWidth - pad) / fcNaturalW, (el.clientHeight - pad) / fcNaturalH, 2);
        fcScale = fcFitScale;
        svg.style.width = (fcNaturalW * fcScale) + 'px';
        svg.style.height = (fcNaturalH * fcScale) + 'px';
        svg.style.margin = 'auto';
      }
      el.scrollLeft = 0;
      el.scrollTop = 0;
    }

    function zoomFlowchart(delta) {
      if (delta === 0) { fitFlowchartToContainer(); return; }
      const el = document.getElementById('flowchartRender');
      if (!el) return;
      const rect = el.getBoundingClientRect();
      fcApplyScale(fcScale * (delta > 0 ? 1.25 : 0.8), rect.left + rect.width / 2, rect.top + rect.height / 2);
    }

    function initFlowchartSvg() {
      const el = document.getElementById('flowchartRender');
      const svg = el && el.querySelector('svg');
      if (!svg) return;
      const vb = svg.getAttribute('viewBox');
      if (vb) {
        const parts = vb.split(/[\s,]+/).map(Number);
        fcNaturalW = parts[2] || 800;
        fcNaturalH = parts[3] || 600;
      } else {
        const w = svg.getAttribute('width'), h = svg.getAttribute('height');
        if (w && !String(w).includes('%')) fcNaturalW = parseFloat(w);
        if (h && !String(h).includes('%')) fcNaturalH = parseFloat(h);
        if (!fcNaturalW || !fcNaturalH) {
          const r = svg.getBoundingClientRect();
          fcNaturalW = fcNaturalW || r.width || 800;
          fcNaturalH = fcNaturalH || r.height || 600;
        }
      }
      svg.removeAttribute('width');
      svg.removeAttribute('height');
      svg.style.maxWidth = 'none';
      svg.style.display = 'block';
      svg.style.margin = 'auto';
      svg.style.flexShrink = '0';
      fitFlowchartToContainer();
    }

    function popOutFlowchart() {
      const svg = document.querySelector('#flowchartRender svg');
      if (!svg) return;
      const clone = svg.cloneNode(true);
      clone.style.width = '';
      clone.style.height = '';
      clone.style.margin = '';
      clone.style.maxWidth = '100%';
      clone.style.flexShrink = '';
      const svgHtml = clone.outerHTML;
      const projectName = document.title || 'Flowchart';
      const win = window.open('', '_blank', 'width=1200,height=700');
      win.document.write('<!DOCTYPE html><html><head><title>' + projectName + ' ‚Äî User Journey</title><style>*{margin:0;padding:0;box-sizing:border-box}body{background:#0a1628;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:24px;font-family:Inter,-apple-system,sans-serif}svg{max-width:100%;height:auto}</style></head><body>' + svgHtml + '</body></html>');
      win.document.close();
    }

    function reflowFlowchartToSnake(code) {
      try {
        const el = document.getElementById('flowchartRender');
        const svg = el && el.querySelector('svg');
        if (!svg || !code || !/^(flowchart|graph)\s+LR/im.test(code.trim())) return;

        const palette = {
          action:   { fill: '#234b73', stroke: '#5cb3ff', text: '#e8f0fe' },
          decision: { fill: '#3b2466', stroke: '#b49aff', text: '#ede4ff' },
          terminal: { fill: '#1e5a3a', stroke: '#4ade80', text: '#dcfce7' },
        };
        const ns = 'http://www.w3.org/2000/svg';
        const FONT = 15, LINE_H = 20, PAD_H = 22, PAD_V = 16;

        // --- Text measurement via canvas ---
        const measureCanvas = document.createElement('canvas').getContext('2d');
        measureCanvas.font = '600 ' + FONT + 'px Inter, system-ui, sans-serif';
        function measureText(str) { return measureCanvas.measureText(str).width; }

        // --- Word-wrap into lines that fit maxW ---
        function wrapText(str, maxW) {
          const words = str.split(' ');
          const lines = []; let line = '';
          for (const w of words) {
            const test = line ? line + ' ' + w : w;
            if (measureText(test) > maxW && line) { lines.push(line); line = w; }
            else line = test;
          }
          if (line) lines.push(line);
          return lines;
        }

        // --- Parse edges + node shape hints from mermaid code ---
        const mLines = code.trim().split('\n');
        const edgeList = [], nodeShapeHint = {};
        for (let i = 1; i < mLines.length; i++) {
          const t = mLines[i].trim();
          if (!t || t.startsWith('%%')) continue;
          const defMatch = t.match(/^([A-Za-z]\w*)\s*(\{|(\(\[)|\[|\(\(|\()/);
          if (defMatch) {
            const nid = defMatch[1], opener = defMatch[2];
            if (opener === '{') nodeShapeHint[nid] = 'decision';
            else if (opener === '([') nodeShapeHint[nid] = 'terminal';
            else if (opener === '((' || opener === '(') nodeShapeHint[nid] = 'terminal';
            else nodeShapeHint[nid] = 'action';
          }
          if (!t.includes('-->')) continue;
          const segs = t.split(/(-->(?:\|[^|]*\|)?)/);
          const nds = [], arrs = [];
          for (let j = 0; j < segs.length; j++) {
            const s = segs[j].trim();
            if (!s) continue;
            if (s.startsWith('-->')) { arrs.push(s); continue; }
            const m = s.match(/^([A-Za-z]\w*)/);
            if (m) nds.push(m[1]);
          }
          for (let j = 0; j < arrs.length; j++) {
            if (nds[j] && nds[j+1]) {
              const lm = arrs[j].match(/\|([^|]*)\|/);
              edgeList.push({ from: nds[j], to: nds[j+1], label: lm ? lm[1].replace(/"/g, '') : '' });
            }
          }
        }
        if (edgeList.length < 4) return;

        // --- Build adjacency + ordered chain ---
        const adj = {}, inDeg = {}, allIds = [], seen = {};
        edgeList.forEach(e => {
          [e.from, e.to].forEach(id => { if (!seen[id]) { allIds.push(id); seen[id] = true; } });
          if (!adj[e.from]) adj[e.from] = [];
          adj[e.from].push(e);
          inDeg[e.to] = (inDeg[e.to] || 0) + 1;
          if (!(e.from in inDeg)) inDeg[e.from] = 0;
        });
        const start = allIds.find(id => !inDeg[id]) || allIds[0];
        const chain = [], vis = {};
        let cur = start;
        while (cur && !vis[cur]) { vis[cur] = true; chain.push(cur); cur = adj[cur]?.[0]?.to; }
        allIds.forEach(id => { if (!vis[id]) chain.push(id); });
        if (chain.length <= 4) return;

        // --- Extract labels + types from mermaid rendered SVG ---
        const nodeEls = {};
        svg.querySelectorAll('g[id]').forEach(g => {
          const m = g.id.match(/^flowchart-(\w+)-\d+$/);
          if (m) nodeEls[m[1]] = g;
        });
        if (chain.filter(id => nodeEls[id]).length < chain.length * 0.5) return;

        const nodeType = {}, nodeLabel = {};
        chain.forEach(id => {
          // Shape type
          if (nodeShapeHint[id]) nodeType[id] = nodeShapeHint[id];
          else if (nodeEls[id] && nodeEls[id].querySelector('polygon')) nodeType[id] = 'decision';
          else if (nodeEls[id] && nodeEls[id].querySelector('circle')) nodeType[id] = 'terminal';
          else {
            const r = nodeEls[id] && nodeEls[id].querySelector('rect');
            nodeType[id] = (r && parseFloat(r.getAttribute('rx') || 0) > 15) ? 'terminal' : 'action';
          }
          // Label text from foreignObject or SVG text
          if (nodeEls[id]) {
            const fo = nodeEls[id].querySelector('foreignObject');
            nodeLabel[id] = fo ? fo.textContent.trim() : (nodeEls[id].querySelector('text') || {}).textContent || id;
          } else { nodeLabel[id] = id; }
        });

        // --- Layout: compute cell sizes, pick perRow ---
        const containerW = el.clientWidth || 800;
        const containerH = el.clientHeight || 400;
        const containerAR = containerW / containerH;
        const gapX = 48, gapY = 60;

        // Target max node width: fill ~5 nodes across container
        const maxTextW = (containerW / 4.5) - PAD_H * 2 - gapX;

        // Compute per-node dimensions (wrap text, size shape)
        const nodeDim = {}; // { w, h, lines }
        let maxNodeW = 0, maxNodeH = 0;
        chain.forEach(id => {
          const lines = wrapText(nodeLabel[id], maxTextW);
          const textBlockW = Math.max(...lines.map(l => measureText(l)));
          const textBlockH = lines.length * LINE_H;
          let w, h;
          if (nodeType[id] === 'decision') {
            // Diamond needs extra space for rotated shape
            w = (textBlockW + PAD_H * 2) * 1.35;
            h = (textBlockH + PAD_V * 2) * 1.35;
          } else {
            w = textBlockW + PAD_H * 2;
            h = textBlockH + PAD_V * 2;
          }
          nodeDim[id] = { w, h, lines };
          maxNodeW = Math.max(maxNodeW, w);
          maxNodeH = Math.max(maxNodeH, h);
        });

        const cellW = maxNodeW + gapX, cellH = maxNodeH + gapY;
        let perRow = 4, bestDiff = Infinity;
        for (let pr = 3; pr <= 8; pr++) {
          const nr = Math.ceil(chain.length / pr);
          const gridAR = (pr * cellW) / (nr * cellH);
          if (Math.abs(gridAR - containerAR) < bestDiff) { bestDiff = Math.abs(gridAR - containerAR); perRow = pr; }
        }

        // --- Snake rows + row-stretch to fill height ---
        const rows = [];
        for (let i = 0; i < chain.length; i += perRow) rows.push(chain.slice(i, i + perRow));
        const numRows = rows.length;
        const padX = maxNodeW / 2 + 30, padY = maxNodeH / 2 + 30;
        const gridW = perRow * cellW + padX * 2;
        const naturalH = numRows * cellH + padY * 2;
        const targetH = gridW / containerAR;
        const finalCellH = (targetH > naturalH && numRows > 1)
          ? cellH + (targetH - naturalH) / numRows : cellH;
        const vbW = gridW, vbH = numRows * finalCellH + padY * 2;

        // Per-node connection points (use uniform cell-based sizing for clean edges)
        const nodeHW = {}, nodeHH = {};
        chain.forEach(id => {
          nodeHW[id] = (nodeDim[id] ? nodeDim[id].w : maxNodeW) / 2 + 2;
          nodeHH[id] = (nodeDim[id] ? nodeDim[id].h : maxNodeH) / 2 + 2;
        });

        const pos = {};
        rows.forEach((row, ri) => {
          const isLastPartial = (ri === rows.length - 1 && row.length < perRow);
          row.forEach((id, ci) => {
            const col = (ri % 2 === 0 || isLastPartial) ? ci : (perRow - 1 - ci);
            pos[id] = { x: padX + col * cellW, y: padY + ri * finalCellH };
          });
        });

        // --- Build SVG ---
        const newSvg = document.createElementNS(ns, 'svg');
        newSvg.setAttribute('xmlns', ns);
        const defs = document.createElementNS(ns, 'defs');
        // Color-coded arrow markers for decision branches
        const arrowColors = { blue: '#3399ff', green: '#4ade80', red: '#ff7b72' };
        Object.keys(arrowColors).forEach(name => {
          const m = document.createElementNS(ns, 'marker');
          m.id = 'snake-arrow-' + name;
          m.setAttribute('viewBox', '0 0 10 10');
          m.setAttribute('refX', '9'); m.setAttribute('refY', '5');
          m.setAttribute('markerWidth', '8'); m.setAttribute('markerHeight', '8');
          m.setAttribute('orient', 'auto');
          const p = document.createElementNS(ns, 'path');
          p.setAttribute('d', 'M0 1 L8 5 L0 9z'); p.setAttribute('fill', arrowColors[name]);
          m.appendChild(p); defs.appendChild(m);
        });
        newSvg.appendChild(defs);
        const mainG = document.createElementNS(ns, 'g');
        newSvg.appendChild(mainG);

        const gridCenterX = chain.reduce((s, id) => s + (pos[id] ? pos[id].x : 0), 0) / chain.length;

        // Pre-compute edge routing, colors, and connection point offsets
        const edgeInfo = edgeList.map(e => {
          const f = pos[e.from], t = pos[e.to];
          if (!f || !t) return null;
          const sameRow = Math.abs(f.y - t.y) < 5, sameCol = Math.abs(f.x - t.x) < 5;
          let exitSide, enterSide;
          if (sameRow) {
            exitSide = f.x < t.x ? 'right' : 'left';
            enterSide = f.x < t.x ? 'left' : 'right';
          } else {
            exitSide = f.y < t.y ? 'bottom' : 'top';
            enterSide = f.y < t.y ? 'top' : 'bottom';
          }
          let color = 'blue', colorHex = '#3399ff';
          if (e.label && nodeType[e.from] === 'decision') {
            const ll = e.label.toLowerCase().trim();
            if (/^(yes|true|approv)/.test(ll)) { color = 'green'; colorHex = '#4ade80'; }
            else if (/^(no|false|reject)/.test(ll)) { color = 'red'; colorHex = '#ff7b72'; }
          }
          return { from: e.from, to: e.to, label: e.label, sameRow, sameCol, exitSide, enterSide, color, colorHex };
        });

        // Spread outgoing connections from same node+side
        const outGroups = {};
        edgeInfo.forEach((ei, i) => { if (!ei) return; const k = ei.from+'-'+ei.exitSide; if (!outGroups[k]) outGroups[k] = []; outGroups[k].push(i); });
        const outOff = {};
        Object.values(outGroups).forEach(g => { if (g.length <= 1) return; g.forEach((idx, i) => { outOff[idx] = (i - (g.length-1)/2) * 20; }); });

        // Spread incoming connections to same node+side
        const inGroups = {};
        edgeInfo.forEach((ei, i) => { if (!ei) return; const k = ei.to+'-'+ei.enterSide; if (!inGroups[k]) inGroups[k] = []; inGroups[k].push(i); });
        const inOff = {};
        Object.values(inGroups).forEach(g => { if (g.length <= 1) return; g.forEach((idx, i) => { inOff[idx] = (i - (g.length-1)/2) * 20; }); });

        // --- Draw edges ---
        edgeInfo.forEach((ei, idx) => {
          if (!ei) return;
          const f = pos[ei.from], t = pos[ei.to];
          const fhw = nodeHW[ei.from] || maxNodeW/2, fhh = nodeHH[ei.from] || maxNodeH/2;
          const thw = nodeHW[ei.to] || maxNodeW/2, thh = nodeHH[ei.to] || maxNodeH/2;
          const oOff = outOff[idx] || 0, iOff = inOff[idx] || 0;
          const path = document.createElementNS(ns, 'path');
          path.setAttribute('stroke', ei.colorHex); path.setAttribute('stroke-width', '2');
          path.setAttribute('stroke-opacity', '0.6'); path.setAttribute('fill', 'none');
          path.setAttribute('marker-end', 'url(#snake-arrow-'+ei.color+')');
          let d, lx, ly;
          if (ei.sameRow) {
            const goR = f.x < t.x;
            const x1 = f.x + (goR ? fhw : -fhw), x2 = t.x + (goR ? -thw : thw);
            const fy = f.y + oOff, ty = t.y + iOff;
            d = 'M'+x1+','+fy+' L'+x2+','+ty;
            const lineLen = Math.abs(x2 - x1);
            if (ei.label && measureText(ei.label) + 20 > lineLen * 0.8) {
              lx = f.x; ly = f.y - fhh - 12;
            } else {
              lx = (x1 + x2) / 2; ly = Math.min(fy, ty) - 12;
            }
          } else if (ei.sameCol) {
            const goD = f.y < t.y;
            const y1 = f.y + (goD ? fhh : -fhh), y2 = t.y + (goD ? -thh : thh);
            const fx = f.x + oOff; // same x for both ends ‚Äî keeps line vertical
            d = 'M'+fx+','+y1+' L'+fx+','+y2;
            const labelLeft = f.x > gridCenterX;
            lx = f.x + (labelLeft ? -(fhw + 8) : (fhw + 8));
            ly = (y1 + y2) / 2;
          } else {
            const goD = f.y < t.y;
            const exitY = f.y + (goD ? fhh : -fhh), enterY = t.y + (goD ? -thh : thh);
            // Route horizontal segment through gap nearest to source (not through intermediate rows)
            const srcRi = rows.findIndex(row => row.includes(ei.from));
            const tgtRi = rows.findIndex(row => row.includes(ei.to));
            let midY;
            if (Math.abs(tgtRi - srcRi) <= 1 || srcRi < 0 || tgtRi < 0) {
              midY = (f.y + t.y) / 2 + oOff;
            } else {
              const nextRi = goD ? srcRi + 1 : srcRi - 1;
              const nextRowY = padY + nextRi * finalCellH;
              midY = (f.y + nextRowY) / 2 + oOff;
            }
            const dirX = t.x > f.x ? 1 : -1, dirY = goD ? 1 : -1;
            const fx = f.x + oOff, tx = t.x + iOff;
            const r = Math.min(14, Math.abs(midY - exitY)/2, Math.abs(midY - enterY)/2);
            d = 'M'+fx+','+exitY+' L'+fx+','+(midY-dirY*r)
              +' Q'+fx+','+midY+' '+(fx+dirX*r)+','+midY
              +' L'+(tx-dirX*r)+','+midY
              +' Q'+tx+','+midY+' '+tx+','+(midY+dirY*r)
              +' L'+tx+','+enterY;
            lx = (f.x + t.x) / 2; ly = midY - 14;
          }
          path.setAttribute('d', d); mainG.appendChild(path);
          if (ei.label) {
            const LFONT = 14;
            measureCanvas.font = '600 '+LFONT+'px Inter, system-ui, sans-serif';
            const tw = measureText(ei.label) + 16;
            measureCanvas.font = '600 '+FONT+'px Inter, system-ui, sans-serif';
            const lh = 20;
            const bg = document.createElementNS(ns, 'rect');
            bg.setAttribute('x', lx-tw/2); bg.setAttribute('y', ly-lh/2);
            bg.setAttribute('width', tw); bg.setAttribute('height', lh);
            bg.setAttribute('rx', '4'); bg.setAttribute('fill', '#152a45');
            bg.setAttribute('fill-opacity', '0.95');
            bg.setAttribute('stroke', ei.colorHex); bg.setAttribute('stroke-width', '0.7');
            bg.setAttribute('stroke-opacity', '0.5');
            mainG.appendChild(bg);
            const txt = document.createElementNS(ns, 'text');
            txt.setAttribute('x', lx); txt.setAttribute('y', ly + 5);
            txt.setAttribute('text-anchor', 'middle'); txt.setAttribute('font-size', LFONT);
            txt.setAttribute('font-weight', '600');
            txt.setAttribute('font-family', 'Inter,-apple-system,sans-serif');
            txt.setAttribute('fill', ei.color === 'blue' ? '#e0ecff' : ei.colorHex);
            txt.textContent = ei.label; mainG.appendChild(txt);
          }
        });

        // --- Draw custom nodes (no cloning) ---
        chain.forEach(id => {
          if (!pos[id] || !nodeDim[id]) return;
          const { w, h, lines } = nodeDim[id];
          const type = nodeType[id] || 'action';
          const pal = palette[type];
          const g = document.createElementNS(ns, 'g');
          g.setAttribute('transform', 'translate('+pos[id].x+','+pos[id].y+')');

          // Shape
          if (type === 'decision') {
            const poly = document.createElementNS(ns, 'polygon');
            poly.setAttribute('points', '0,'+(-h/2)+' '+(w/2)+',0 0,'+(h/2)+' '+(-w/2)+',0');
            poly.setAttribute('fill', pal.fill); poly.setAttribute('stroke', pal.stroke);
            poly.setAttribute('stroke-width', '2.5'); g.appendChild(poly);
          } else {
            const rect = document.createElementNS(ns, 'rect');
            rect.setAttribute('x', -w/2); rect.setAttribute('y', -h/2);
            rect.setAttribute('width', w); rect.setAttribute('height', h);
            rect.setAttribute('rx', type === 'terminal' ? h/2 : 8);
            rect.setAttribute('fill', pal.fill); rect.setAttribute('stroke', pal.stroke);
            rect.setAttribute('stroke-width', '2.5'); g.appendChild(rect);
          }

          // Text lines ‚Äî centered in shape
          const blockH = lines.length * LINE_H;
          lines.forEach((line, i) => {
            const txt = document.createElementNS(ns, 'text');
            txt.setAttribute('x', '0');
            txt.setAttribute('y', -blockH/2 + (i + 0.75) * LINE_H);
            txt.setAttribute('text-anchor', 'middle');
            txt.setAttribute('font-size', FONT + 'px');
            txt.setAttribute('font-weight', '600');
            txt.setAttribute('font-family', 'Inter,-apple-system,sans-serif');
            txt.setAttribute('fill', pal.text);
            txt.textContent = line; g.appendChild(txt);
          });
          mainG.appendChild(g);
        });

        // Tight viewBox matching container AR so it fills the box exactly
        let bx0 = Infinity, by0 = Infinity, bx1 = -Infinity, by1 = -Infinity;
        chain.forEach(id => {
          if (!pos[id] || !nodeDim[id]) return;
          const hw = nodeDim[id].w / 2, hh = nodeDim[id].h / 2;
          bx0 = Math.min(bx0, pos[id].x - hw); bx1 = Math.max(bx1, pos[id].x + hw);
          by0 = Math.min(by0, pos[id].y - hh); by1 = Math.max(by1, pos[id].y + hh);
        });
        const cp = 50;
        let vbX = bx0 - cp, vbY = by0 - cp;
        let vbFW = bx1 - bx0 + cp * 2, vbFH = by1 - by0 + cp * 2;
        // Expand shorter dimension to match container AR (centers content)
        const contentAR = vbFW / vbFH;
        if (contentAR > containerAR) {
          const newH = vbFW / containerAR;
          vbY -= (newH - vbFH) / 2; vbFH = newH;
        } else {
          const newW = vbFH * containerAR;
          vbX -= (newW - vbFW) / 2; vbFW = newW;
        }
        newSvg.setAttribute('viewBox', vbX+' '+vbY+' '+vbFW+' '+vbFH);
        newSvg.setAttribute('data-snake-reflow', '1');
        el.innerHTML = '';
        el.appendChild(newSvg);
      } catch(e) { console.warn('Snake reflow failed:', e); }
    }

    async function renderMermaidSafe(elementId, code, container) {
      try {
        const prev = document.getElementById(elementId);
        if (prev) prev.remove();
        const { svg } = await mermaid.render(elementId, code);
        container.innerHTML = svg;
        reflowFlowchartToSnake(code);
        requestAnimationFrame(() => initFlowchartSvg());
      } catch(e) {
        container.innerHTML = '<div class="flowchart-error"><strong>‚ö†Ô∏è Flowchart rendering failed</strong><p>' + (e.message || 'Unknown error') + '</p><pre>' + code.replace(/</g,'&lt;') + '</pre></div>';
      }
    }

    // Wheel zoom, pinch-to-zoom, double-click toggle
    (function() {
      const el = document.getElementById('flowchartRender');
      if (!el) return;

      el.addEventListener('wheel', function(e) {
        if (!el.querySelector('svg')) return;
        if (!e.ctrlKey) return; // Let normal 2-finger scroll pan natively; only intercept pinch-zoom
        e.preventDefault();
        fcApplyScale(fcScale * (e.deltaY > 0 ? 0.9 : 1.1), e.clientX, e.clientY);
      }, { passive: false });

      let lastPinchDist = 0;
      el.addEventListener('touchstart', function(e) {
        if (e.touches.length === 2) {
          lastPinchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        }
      });
      el.addEventListener('touchmove', function(e) {
        if (e.touches.length === 2) {
          e.preventDefault();
          const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
          const midX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
          const midY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
          fcApplyScale(fcScale * (dist / lastPinchDist), midX, midY);
          lastPinchDist = dist;
        }
      }, { passive: false });

      el.addEventListener('dblclick', function() {
        if (Math.abs(fcScale - fcFitScale) < 0.01) {
          const rect = el.getBoundingClientRect();
          fcApplyScale(1, rect.left + rect.width / 2, rect.top + rect.height / 2);
        } else {
          fitFlowchartToContainer();
        }
      });
    })();

    // Render saved flowchart
    <% if (design.flowchart) { %>
    (async () => {
      await renderMermaidSafe('flowchart-svg-saved', `<%- design.flowchart.replace(/`/g, '\\`').replace(/\\/g, '\\\\') %>`, document.getElementById('flowchartRender'));
    })();
    <% } %>

    // AI Chat
    async function sendChat() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;
      const btn = document.getElementById('chatSendBtn');
      btn.disabled = true; btn.textContent = '‚è≥‚Ä¶';
      input.value = '';
      const empty = document.getElementById('chatEmpty');
      if (empty) empty.remove();
      const msgs = document.getElementById('chatMessages');
      const userBubble = document.createElement('div');
      userBubble.className = 'chat-bubble';
      userBubble.innerHTML = '<div class="chat-meta"><strong>üë§ You</strong> ‚Äî just now</div><div class="chat-text">' + text.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>';
      msgs.appendChild(userBubble);
      const typing = document.createElement('div');
      typing.className = 'chat-bubble';
      typing.style.background = 'var(--accent-dim)';
      typing.style.borderLeft = '3px solid var(--accent)';
      typing.innerHTML = '<div class="chat-meta"><strong>ü§ñ AI</strong></div><div class="chat-text" style="color: var(--text-muted);">Thinking‚Ä¶</div>';
      msgs.appendChild(typing);
      msgs.scrollTop = msgs.scrollHeight;
      try {
        const res = await fetch('/admin/projects/<%= encodeId(projectId) %>/design/chat', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ designId: '<%= design.id %>', text })
        });
        if (!res.ok) throw new Error('Server returned ' + res.status);
        const data = await res.json();
        typing.querySelector('.chat-text').style.whiteSpace = 'pre-wrap';
        typing.querySelector('.chat-text').style.color = 'var(--text-secondary)';
        typing.querySelector('.chat-text').textContent = data.aiMessage.text;
      } catch (e) {
        typing.querySelector('.chat-text').textContent = 'Error: ' + e.message;
      } finally {
        btn.disabled = false; btn.textContent = 'Send';
        msgs.scrollTop = msgs.scrollHeight;
      }
    }
    document.getElementById('chatInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
    });

    // Send to Engine
    function toggleEnginePanel() {
      const panel = document.getElementById('enginePanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      if (panel.style.display === 'block') panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    async function sendToEngine() {
      const btn = document.getElementById('engineSendBtn');
      if (!btn) return;
      const guidance = (document.getElementById('engineGuidance') || {}).value || '';
      btn.disabled = true; btn.textContent = '‚è≥ Sending to Engine...';
      try {
        const res = await fetch('/admin/projects/<%= encodeId(projectId) %>/send-to-engine', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adminGuidance: guidance })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        btn.textContent = '‚úÖ Sent to Engine';
        btn.style.background = 'var(--accent-secondary)';
        setTimeout(() => window.location.reload(), 2000);
      } catch (e) {
        btn.disabled = false; btn.textContent = 'üöÄ Confirm & Send';
        alert('Failed to send to engine: ' + e.message);
      }
    }

    // Assign/Accept question handlers
    async function acceptAssumption(btn, questionText, assumption) {
      try {
        const res = await fetch('/admin/projects/<%= encodeId(projectId) %>/design/accept-assumption', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ designId: '<%= design.id %>', questionText, assumption })
        });
        if (res.ok) {
          const card = btn.closest('.question-card');
          card.style.transition = 'opacity 0.3s'; card.style.opacity = '0';
          setTimeout(() => card.remove(), 300);
        } else { alert('Failed to accept assumption'); }
      } catch (e) { alert('Error: ' + e.message); }
    }

    async function assignQuestion(btn, questionText) {
      try {
        const res = await fetch('/admin/projects/<%= encodeId(projectId) %>/design/assign-question', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ designId: '<%= design.id %>', questionText, assignedTo: 'customer' })
        });
        if (res.ok) { btn.style.background = '#f59e0b'; btn.textContent = 'üë§ Customer ‚úì'; }
        else { alert('Failed to assign question'); }
      } catch (e) { alert('Error: ' + e.message); }
    }

    document.getElementById('generateFlowchart').addEventListener('click', async function() {
      const btn = this;
      btn.disabled = true; btn.textContent = '‚è≥ Generating‚Ä¶';
      const container = document.getElementById('flowchartContainer');
      const render = document.getElementById('flowchartRender');
      let responseData = null;
      try {
        const res = await fetch('/admin/projects/<%= encodeId(projectId) %>/design/flowchart', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        if (!res.ok) throw new Error('Server returned ' + res.status);
        responseData = await res.json();
        if (!responseData.mermaid) throw new Error('No flowchart data returned');
        container.style.display = 'block';
        await renderMermaidSafe('flowchart-svg', responseData.mermaid, render);
      } catch (e) {
        container.style.display = 'block';
        render.innerHTML = '<div class="flowchart-error"><strong>‚ö†Ô∏è Flowchart generation failed</strong><p>' + e.message + '</p>' + (responseData && responseData.mermaid ? '<pre>' + responseData.mermaid.replace(/</g,'&lt;') + '</pre>' : '') + '</div>';
      } finally {
        btn.disabled = false; btn.textContent = 'üó∫Ô∏è Flowchart';
      }
    });
  </script>
<% } %>
</body>
</html>