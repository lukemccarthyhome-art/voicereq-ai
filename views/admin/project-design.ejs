<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Morti Projects</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #050d1a;
      --bg-primary: #0a1628;
      --bg-card: #0f1d32;
      --bg-glass: rgba(15, 29, 50, 0.6);
      --border-glass: rgba(255, 255, 255, 0.08);
      --border-glass-hover: rgba(255, 255, 255, 0.15);
      --accent: #1199fa;
      --accent-glow: rgba(17, 153, 250, 0.4);
      --accent-dim: rgba(17, 153, 250, 0.12);
      --accent-secondary: #00d4aa;
      --accent-purple: #8b5cf6;
      --text-primary: #f0f4f8;
      --text-secondary: rgba(240, 244, 248, 0.7);
      --text-muted: rgba(240, 244, 248, 0.4);
      --radius: 16px;
      --radius-pill: 50px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-deep); line-height:1.6; color: var(--text-primary); -webkit-font-smoothing: antialiased; }
    a { text-decoration: none; color: inherit; }
    .main { max-width:1100px; margin:0 auto; padding:24px 20px; }
    .breadcrumb { font-size:13px; color: var(--text-muted); margin-bottom:16px; }
    .breadcrumb a { color: var(--accent); text-decoration:none; }
    .breadcrumb a:hover { text-decoration:underline; }
    .card { background: var(--bg-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-glass); border-radius: var(--radius); padding:24px; margin-bottom:20px; transition: border-color 0.3s; }
    .card:hover { border-color: var(--border-glass-hover); }
    .card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap; gap:12px; }
    .card-header h2 { font-size:20px; color: var(--text-primary); font-weight: 700; }
    .badge { display:inline-block; padding:4px 12px; border-radius: var(--radius-pill); font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
    .badge-draft { background: rgba(245,158,11,0.15); color: #f59e0b; border: 1px solid rgba(245,158,11,0.2); }
    .badge-final { background: rgba(0,212,170,0.12); color: var(--accent-secondary); border: 1px solid rgba(0,212,170,0.2); }
    .meta-row { display:flex; gap:24px; font-size:13px; color: var(--text-muted); margin-bottom:4px; }
    .btn { display:inline-flex; align-items:center; gap:6px; padding:8px 18px; border:none; border-radius: var(--radius-pill); font-weight:600; font-size:13px; cursor:pointer; transition:all 0.3s; text-decoration:none; color: #fff; }
    .btn:hover { transform:translateY(-1px); }
    .btn-primary { background: var(--accent); box-shadow: 0 0 16px var(--accent-glow); }
    .btn-primary:hover { background: #2aa8ff; box-shadow: 0 0 24px var(--accent-glow); }
    .btn-amber { background: #f59e0b; box-shadow: 0 0 12px rgba(245,158,11,0.3); }
    .btn-cyan { background: #06b6d4; box-shadow: 0 0 12px rgba(6,182,212,0.3); }
    .btn-sm { padding:6px 14px; font-size:12px; }
    .empty-state { text-align:center; padding:24px; color: var(--text-muted); font-size:14px; }

    /* Tabs */
    .tabs { display:flex; gap:0; border-bottom:1px solid var(--border-glass); margin-bottom:20px; }
    .tab { padding:12px 24px; font-size:14px; font-weight:600; color: var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; margin-bottom:-1px; transition:all 0.2s; user-select:none; }
    .tab:hover { color: var(--text-secondary); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-content { display:none; }
    .tab-content.active { display:block; }

    /* Customer View Cards */
    .section-card { background: var(--bg-card); border:1px solid var(--border-glass); border-radius:12px; padding:20px 24px; margin-bottom:16px; transition: border-color 0.3s; }
    .section-card:hover { border-color: var(--border-glass-hover); }
    .section-card h3 { font-size:15px; font-weight:700; color: var(--text-primary); margin-bottom:12px; display:flex; align-items:center; gap:8px; }
    .section-card h3 .icon { font-size:18px; }
    .section-body { font-size:14px; color: var(--text-secondary); line-height:1.7; }
    .section-body p { margin-bottom:8px; }
    .section-body strong { color: var(--text-primary); }

    /* Step Flow for HowItWorks */
    .step-flow { display:flex; flex-direction:column; gap:0; position:relative; padding-left:40px; }
    .step-flow::before { content:''; position:absolute; left:18px; top:20px; bottom:20px; width:2px; background:linear-gradient(to bottom, var(--accent), var(--accent-purple)); }
    .step-item { position:relative; padding:12px 16px 12px 20px; }
    .step-num { position:absolute; left:-40px; top:12px; width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg, var(--accent), #0077cc); color:#fff; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:700; box-shadow:0 2px 12px var(--accent-glow); z-index:1; }
    .step-title { font-weight:700; color: var(--text-primary); font-size:14px; margin-bottom:4px; }
    .step-desc { color: var(--text-muted); font-size:13px; line-height:1.5; }

    /* Build Spec (engine) items */
    .engine-section { background: var(--bg-card); border:1px solid var(--border-glass); border-radius:10px; padding:18px 22px; margin-bottom:14px; }
    .engine-section h4 { font-size:13px; text-transform:uppercase; letter-spacing:0.5px; color: var(--accent); margin-bottom:10px; font-weight:700; }
    .engine-section .section-body { font-size:13px; color: var(--text-secondary); }

    /* Questions */
    .question-card { padding:12px 16px; border-radius:10px; background: var(--bg-card); border:1px solid var(--border-glass); margin-bottom:10px; }
    .question-card .q-id { display:inline-block; background: var(--accent); color:white; width:24px; height:24px; border-radius:50%; text-align:center; line-height:24px; font-size:12px; font-weight:700; margin-right:8px; }
    .question-card .q-text { font-weight:600; color: var(--text-primary); font-size:14px; }
    .question-card .q-assumption { font-size:12px; color: var(--text-muted); margin-top:4px; font-style:italic; }
    .question-card .q-answer { margin-top:8px; padding:8px 12px; background: rgba(0,212,170,0.1); border:1px solid rgba(0,212,170,0.15); border-radius:8px; color: var(--accent-secondary); font-size:13px; }
    .answer-form { display:flex; gap:8px; margin-top:8px; }
    .answer-form input[type="text"] { flex:1; padding:8px 12px; border:1px solid var(--border-glass); border-radius:8px; font-size:13px; background: var(--bg-primary); color: var(--text-primary); }
    .answer-form input[type="text"]:focus { outline: none; border-color: var(--accent); }

    /* Chat */
    .chat-bubble { margin-bottom:10px; padding:10px 14px; border-radius:10px; background: var(--bg-card); border: 1px solid var(--border-glass); }
    .chat-bubble .chat-meta { font-size:12px; color: var(--text-muted); margin-bottom:4px; }
    .chat-bubble .chat-meta strong { color: var(--text-primary); }
    .chat-bubble .chat-text { font-size:14px; color: var(--text-secondary); }
    .chat-input { display:flex; gap:8px; margin-top:12px; }
    .chat-input textarea { flex:1; padding:10px; border:1px solid var(--border-glass); border-radius:10px; font-size:13px; font-family:inherit; resize:vertical; min-height:60px; background: var(--bg-primary); color: var(--text-primary); }
    .chat-input textarea:focus { outline: none; border-color: var(--accent); }

    /* Flowchart */
    #flowchartContainer { margin-top:16px; padding:24px; border:1px solid var(--border-glass); border-radius: var(--radius); background: var(--bg-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
    #flowchartRender { min-height:200px; max-height:600px; overflow:auto; display:flex; align-items:center; justify-content:center; padding:16px; border:1px solid var(--border-glass); border-radius:10px; background: var(--bg-card); position:relative; }
    #flowchartRender svg { max-width:100%; height:auto; }
    .flowchart-zoom { display:flex; gap:6px; margin-bottom:12px; }
    .flowchart-zoom button { padding:4px 12px; border:1px solid var(--border-glass); border-radius:8px; background: var(--bg-card); cursor:pointer; font-size:14px; color: var(--text-secondary); transition: all 0.2s; }
    .flowchart-zoom button:hover { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
    .flowchart-error { color:#f87171; padding:16px; background: rgba(239,68,68,0.08); border:1px solid rgba(239,68,68,0.2); border-radius:10px; }
    .flowchart-error pre { font-size:11px; background: var(--bg-primary); padding:8px; border-radius:6px; overflow-x:auto; margin-top:8px; white-space:pre-wrap; color: var(--text-muted); }

    @media (max-width:768px) {
      .card-header { flex-direction:column; align-items:flex-start; }
      .step-flow { padding-left:36px; }
    }
  </style>
</head>
<body>
  <%- include('../partials/admin-nav', { currentPage: 'projects', user: user }) %>

  <main class="main">
    <div class="breadcrumb">
      <a href="/admin">Dashboard</a> ‚Ä∫ <a href="/admin/projects">Projects</a> ‚Ä∫ <a href="/admin/projects/<%= encodeId(projectId) %>">Project <%= projectId %></a> ‚Ä∫ Design
    </div>

    <% if (locals.generating && !design) { %>
    <div class="card" style="text-align: center; padding: 60px;" id="genCard">
      <div style="font-size: 3rem; margin-bottom: 16px;" id="genSpinner">‚è≥</div>
      <h3 style="color: var(--accent); margin-bottom: 8px;" id="genTitle">Extracting Design...</h3>
      <p style="color: var(--text-muted);" id="genMsg">AI is analysing your project requirements and building a solution design. This usually takes 20-40 seconds.</p>
      <div style="margin-top: 16px; width: 200px; height: 4px; background: var(--bg-card); border-radius: 2px; margin-left: auto; margin-right: auto; overflow: hidden;">
        <div style="width: 30%; height: 100%; background: var(--accent); border-radius: 2px; animation: designProgress 2s ease-in-out infinite;"></div>
      </div>
    </div>
    <style>@keyframes designProgress { 0% { width: 10%; margin-left: 0; } 50% { width: 60%; margin-left: 20%; } 100% { width: 10%; margin-left: 90%; } }</style>
    <script>
    (function pollDesignStatus() {
      const projectId = '<%= projectId %>';
      let elapsed = 0;
      const interval = setInterval(async () => {
        elapsed += 2;
        try {
          const res = await fetch(`/admin/projects/${projectId}/generation-status`);
          const data = await res.json();
          if (data.status === 'done') { clearInterval(interval); window.location.reload(); }
          else if (data.status === 'error') {
            clearInterval(interval);
            document.getElementById('genSpinner').textContent = '‚ùå';
            document.getElementById('genTitle').textContent = 'Extraction Failed';
            document.getElementById('genTitle').style.color = '#f87171';
            document.getElementById('genMsg').textContent = data.error || 'Unknown error. Try again.';
          } else if (elapsed > 120) {
            clearInterval(interval);
            document.getElementById('genMsg').textContent = 'Taking longer than expected. Try refreshing the page.';
          }
        } catch(e) {}
      }, 2000);
    })();
    </script>
    <% } else if (locals.genError) { %>
    <div class="card" style="text-align: center; padding: 60px;">
      <div style="font-size: 3rem; margin-bottom: 16px;">‚ùå</div>
      <h3 style="color: #f87171; margin-bottom: 8px;">Design Extraction Failed</h3>
      <p style="color: var(--text-muted);"><%= locals.genError %></p>
      <a href="/admin/projects/<%= encodeId(projectId) %>" class="btn btn-primary" style="margin-top: 16px;">‚Üê Back to Project</a>
    </div>
    <% } else if (design) { %>
    <%
      // Detect new format vs old format
      const hasNewFormat = !!(design.customerDesign || design.engineDesign);
      const customerDesign = design.customerDesign || null;
      const engineDesign = design.engineDesign || null;
      // Fallback: old format sections
      let designSections = design.sections || null;
      let designSummary = design.summary || '';
      if (!designSections && !hasNewFormat) {
        try {
          if (design.designMarkdown && design.designMarkdown.trim().startsWith('```json')) {
            const jsonText = design.designMarkdown.replace(/```json\s*|```/g, '').trim();
            const parsed = JSON.parse(jsonText);
            if (parsed.design) designSections = parsed.design;
            if (parsed.summary) designSummary = parsed.summary;
          }
        } catch(e) {}
      }
    %>

    <% if (locals.generating) { %>
    <div style="background: var(--accent-dim); border:1px solid rgba(17,153,250,0.2); border-radius:12px; padding:12px 16px; margin-bottom:16px; display:flex; align-items:center; gap:12px;" id="refreshBanner">
      <div style="animation: spin 1s linear infinite; font-size:1.2rem;">‚è≥</div>
      <div style="flex:1;">
        <strong style="color: var(--accent);">Refreshing design...</strong>
        <span style="color: var(--text-secondary); font-size:0.9rem;"> AI is updating the design with new information.</span>
      </div>
    </div>
    <style>@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>
    <script>
    (function pollRefresh() {
      const projectId = '<%= projectId %>';
      const interval = setInterval(async () => {
        try {
          const res = await fetch(`/admin/projects/${projectId}/generation-status`);
          const data = await res.json();
          if (data.status === 'done' || data.status === 'error') { clearInterval(interval); window.location.reload(); }
        } catch(e) {}
      }, 2000);
    })();
    </script>
    <% } %>

    <!-- Header Card -->
    <div class="card">
      <div class="card-header">
        <div>
          <h2>üìê <%= projectName %> ‚Äî Solution Design</h2>
          <div class="meta-row" style="margin-top:8px;">
            <span>üë§ <%= design.owner %></span>
            <span>üìÖ <%= melb(design.createdAt) %></span>
            <% if (design.version) { %><span>v<%= design.version %></span><% } %>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <span class="badge <%= (design.status === 'final') ? 'badge-final' : 'badge-draft' %>"><%= design.status || 'draft' %></span>
          <form method="POST" action="/admin/projects/<%= encodeId(projectId) %>/extract-design" style="margin:0">
            <button type="submit" class="btn btn-amber btn-sm">üîÑ Refresh</button>
          </form>
          <button id="generateFlowchart" class="btn btn-cyan btn-sm">üó∫Ô∏è Flowchart</button>
          <% if (design.published) { %>
            <form method="POST" action="/admin/projects/<%= encodeId(projectId) %>/design/unpublish" style="margin:0">
              <button type="submit" class="btn btn-sm" style="background:#ef4444;color:white;">üîí Unpublish</button>
            </form>
            <span class="badge badge-final" style="font-size:10px;">Published <%= design.publishedAt ? melbDate(design.publishedAt) : '' %></span>
          <% } else { %>
            <form method="POST" action="/admin/projects/<%= encodeId(projectId) %>/design/publish" style="margin:0">
              <button type="submit" class="btn btn-sm" style="background: var(--accent-secondary);color:white;">üì§ Publish to Customer</button>
            </form>
          <% } %>
          <% if (design.approvedAt) { %>
            <% if (design.sentToEngineAt) { %>
              <span class="badge badge-final" style="font-size:10px;">‚úÖ Sent to Engine <%= melbDate(design.sentToEngineAt) %></span>
              <% if (design.enginePlanId) { %>
                <a href="<%= (process.env.ENGINE_API_URL || 'http://localhost:3100') %>/builds/<%= design.enginePlanId %>" target="_blank" class="btn btn-sm" style="background:#06b6d4;color:white;font-size:11px;">üîó View Build</a>
              <% } %>
            <% } else { %>
              <button id="sendToEngineBtn" onclick="sendToEngine()" class="btn btn-sm" style="background: var(--accent-secondary);color:white;">üöÄ Send to Engine</button>
            <% } %>
          <% } %>
        </div>
      </div>

      <% if (hasNewFormat) { %>
        <!-- NEW FORMAT: Tabbed layout -->
        <div class="tabs">
          <div class="tab active" data-tab="customer">üë§ Customer View</div>
          <div class="tab" data-tab="engine">‚öôÔ∏è Build Spec</div>
        </div>

        <!-- Customer View Tab -->
        <div class="tab-content active" id="tab-customer">
          <% if (customerDesign) { %>
            <%
              const custSections = [
                { key: 'ExecutiveSummary', label: 'Executive Summary', icon: 'üìã' },
                { key: 'HowItWorks', label: 'How It Works', icon: '‚ö°' },
                { key: 'WhatYouGet', label: 'What You Get', icon: 'üéØ' },
                { key: 'WhatWeNeedFromYou', label: 'What We Need From You', icon: 'ü§ù' },
                { key: 'TimelineAndInvestment', label: 'Timeline & Investment', icon: 'üìÖ' },
                { key: 'AutomatedVsManual', label: 'Automated vs Manual', icon: 'ü§ñ' }
              ];
              // Also pick up any extra keys
              const custKeys = Object.keys(customerDesign);
              const extraCustKeys = custKeys.filter(k => !custSections.find(s => s.key === k));
            %>
            <% custSections.forEach(sec => { %>
              <% if (customerDesign[sec.key]) { %>
                <div class="section-card">
                  <h3><span class="icon"><%= sec.icon %></span> <%= sec.label %></h3>
                  <% if (sec.key === 'HowItWorks') { %>
                    <div class="step-flow" id="howItWorksFlow"></div>
                    <noscript><div class="section-body"><%- renderText(customerDesign[sec.key]) %></div></noscript>
                  <% } else { %>
                    <div class="section-body"><%- renderText(customerDesign[sec.key]) %></div>
                  <% } %>
                </div>
              <% } %>
            <% }) %>
            <% extraCustKeys.forEach(key => { %>
              <% if (customerDesign[key]) { %>
                <div class="section-card">
                  <h3><%= key.replace(/([A-Z])/g, ' $1').trim() %></h3>
                  <div class="section-body"><%- renderText(customerDesign[key]) %></div>
                </div>
              <% } %>
            <% }) %>
          <% } else { %>
            <div class="empty-state">No customer design sections generated yet.</div>
          <% } %>
        </div>

        <!-- Build Spec Tab -->
        <div class="tab-content" id="tab-engine">
          <% if (engineDesign) { %>
            <%
              const engSections = [
                { key: 'TechnicalArchitecture', label: 'Technical Architecture', icon: 'üèóÔ∏è' },
                { key: 'DataModel', label: 'Data Model', icon: 'üóÑÔ∏è' },
                { key: 'IntegrationsAndAPIs', label: 'Integrations & APIs', icon: 'üîå' },
                { key: 'BuildSpecification', label: 'Build Specification', icon: 'üìê' },
                { key: 'RiskRegister', label: 'Risk Register', icon: '‚ö†Ô∏è' }
              ];
              const engKeys = Object.keys(engineDesign);
              const extraEngKeys = engKeys.filter(k => !engSections.find(s => s.key === k));
            %>
            <% engSections.forEach(sec => { %>
              <% if (engineDesign[sec.key]) { %>
                <div class="engine-section">
                  <h4><%= sec.icon %> <%= sec.label %></h4>
                  <div class="section-body"><%- renderText(engineDesign[sec.key]) %></div>
                </div>
              <% } %>
            <% }) %>
            <% extraEngKeys.forEach(key => { %>
              <% if (engineDesign[key]) { %>
                <div class="engine-section">
                  <h4><%= key.replace(/([A-Z])/g, ' $1').trim() %></h4>
                  <div class="section-body"><%- renderText(engineDesign[key]) %></div>
                </div>
              <% } %>
            <% }) %>
          <% } else { %>
            <div class="empty-state">No engine design sections generated yet.</div>
          <% } %>
        </div>

      <% } else if (designSections) { %>
        <!-- OLD FORMAT: Flat sections (backward compat) -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px;">
          <%
            const sectionOrder = ['ExecutiveSummary','CoreWorkflow','SimplifiedArchitecture','MinimalDataModel','ManualVsAutomated','Assumptions','Dependencies','Phase2Enhancements','RisksAndMitigations','BuildEffortEstimate','CostBenefitAnalysis','TechnicalReadiness','TechnicalReference'];
            const sectionLabels = { ExecutiveSummary:'Executive Summary', CoreWorkflow:'Core Workflow', SimplifiedArchitecture:'Simplified Architecture', MinimalDataModel:'Minimal Data Model', ManualVsAutomated:'Manual vs Automated', Assumptions:'Assumptions', Dependencies:'Dependencies', Phase2Enhancements:'Phase 2 Enhancements (Out of Scope)', RisksAndMitigations:'Risks & Mitigations', BuildEffortEstimate:'Build Effort Estimate', CostBenefitAnalysis:'Cost / Benefit Analysis', TechnicalReadiness:'Technical Readiness', TechnicalReference:'Technical Reference' };
            const fullWidthSections = ['ExecutiveSummary','CoreWorkflow','SimplifiedArchitecture','MinimalDataModel','ManualVsAutomated','Phase2Enhancements','TechnicalReference'];
            const allKeys = Object.keys(designSections);
            const orderedKeys = sectionOrder.filter(k => designSections[k]);
            const extraKeys = allKeys.filter(k => !sectionOrder.includes(k));
            const renderKeys = orderedKeys.concat(extraKeys);
          %>
          <% renderKeys.forEach(key => { %>
            <% if (designSections[key]) { %>
              <div style="padding:16px;border-radius:10px;background: var(--bg-card);border:1px solid var(--border-glass);<%= fullWidthSections.includes(key) ? 'grid-column:1/-1;' : '' %>">
                <h4 style="font-size:13px;text-transform:uppercase;letter-spacing:0.5px;color: var(--accent);margin-bottom:6px;"><%= sectionLabels[key] || key.replace(/([A-Z])/g, ' $1').trim() %></h4>
                <div class="section-body"><%- renderText(designSections[key]) %></div>
              </div>
            <% } %>
          <% }) %>
        </div>
      <% } else { %>
        <div class="empty-state">No design content generated yet. Click Refresh to generate.</div>
      <% } %>
    </div>

    <!-- Flowchart -->
    <div id="flowchartContainer" style="<%= design.flowchart ? '' : 'display:none;' %>" class="card">
      <h3 style="margin-bottom:12px; color: var(--text-primary);">üó∫Ô∏è Component Flowchart</h3>
      <div class="flowchart-zoom">
        <button onclick="zoomFlowchart(0.2)" title="Zoom In">‚ûï</button>
        <button onclick="zoomFlowchart(-0.2)" title="Zoom Out">‚ûñ</button>
        <button onclick="zoomFlowchart(0)" title="Reset Zoom">‚Ü∫ Reset</button>
      </div>
      <div id="flowchartRender"></div>
    </div>

    <!-- Questions -->
    <div class="card">
      <h3 style="margin-bottom:12px; color: var(--text-primary);">‚ùì Outstanding Questions</h3>
      <% if (!design.questions || design.questions.length === 0) { %>
        <div class="empty-state">‚úÖ No outstanding questions ‚Äî design is complete based on available requirements.</div>
      <% } else { %>
        <% design.questions.forEach(function(q, i) { %>
          <%
            const isObj = (typeof q === 'object' && q !== null);
            const qText = isObj ? q.text : String(q);
            const qId = isObj ? q.id : (i+1);
            const qAssumption = isObj ? q.assumption : '';
            const answered = (design.answers || []).find(a => a.question === qText);
            const customerAnswered = (design.customerAnswers || []).find(a => a.question === qText);
            const assignedTo = isObj && q.assignedTo ? q.assignedTo : 'admin';
          %>
          <div class="question-card">
            <div>
              <span class="q-id"><%= qId %></span>
              <span class="q-text"><%= qText %></span>
            </div>
            <% if (qAssumption) { %>
              <div class="q-assumption">üí° <%= qAssumption %></div>
            <% } %>
            <% if (answered) { %>
              <div class="q-answer">‚úÖ <strong>Answer:</strong> <%= answered.answer %> <span style="font-size:11px;color: var(--text-muted);">‚Äî <%= answered.from %>, <%= melb(answered.ts) %></span></div>
            <% } else if (customerAnswered) { %>
              <div class="q-answer">‚úÖ <strong>Customer Answer:</strong> <%= customerAnswered.answer %> <span style="font-size:11px;color: var(--text-muted);">‚Äî <%= customerAnswered.from %>, <%= melb(customerAnswered.ts) %></span></div>
            <% } else { %>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <form method="POST" action="/admin/projects/<%= encodeId(projectId) %>/design/answer" class="answer-form" style="flex:1;margin-top:0;">
                  <input type="hidden" name="designId" value="<%= design.id %>" />
                  <input type="hidden" name="question" value="<%= qText %>" />
                  <input type="text" name="answer" placeholder="Type your answer‚Ä¶" />
                  <button type="submit" class="btn btn-primary btn-sm">Save</button>
                </form>
                <button onclick="assignQuestion(this, '<%= qText.replace(/'/g, "\\'") %>')" class="btn btn-sm" style="background:<%= assignedTo === 'customer' ? '#f59e0b' : 'rgba(255,255,255,0.08)' %>;color:white;white-space:nowrap;font-size:11px;">
                  üë§ <%= assignedTo === 'customer' ? 'Customer ‚úì' : 'Assign to Customer' %>
                </button>
                <% if (qAssumption) { %>
                <button onclick="acceptAssumption(this, '<%= qText.replace(/'/g, "\\'") %>', '<%= qAssumption.replace(/'/g, "\\'") %>')" class="btn btn-sm" style="background: var(--accent-purple);color:white;white-space:nowrap;font-size:11px;">
                  üí° Accept Assumption
                </button>
                <% } %>
              </div>
            <% } %>
          </div>
        <% }) %>
      <% } %>
    </div>

    <!-- Accepted Assumptions -->
    <% if (design.acceptedAssumptions && design.acceptedAssumptions.length > 0) { %>
    <div class="card" style="border-left: 4px solid var(--accent-purple);">
      <h3 style="margin-bottom:12px; color: var(--text-primary);">üí° Accepted Assumptions</h3>
      <p style="color: var(--text-muted); font-size:12px; margin-bottom:12px;">These assumptions were accepted in place of asking more questions. They are incorporated into the design on refresh.</p>
      <% design.acceptedAssumptions.forEach(function(a) { %>
        <div style="padding:10px 14px;background: rgba(139,92,246,0.08);border-left:3px solid var(--accent-purple);border-radius:0 10px 10px 0;margin-bottom:8px;">
          <div style="font-size:13px;color: var(--text-muted);">‚ùì <%= a.question %></div>
          <div style="font-size:14px;color: var(--text-primary);margin-top:4px;">üí° <strong>Assumption:</strong> <%= a.assumption %></div>
          <div style="font-size:11px;color: var(--text-muted);margin-top:4px;">Accepted by <%= a.acceptedBy %> ¬∑ <%= melb(a.ts) %></div>
        </div>
      <% }) %>
    </div>
    <% } %>

    <!-- AI Chat -->
    <div class="card">
      <h3 style="margin-bottom:12px; color: var(--text-primary);">ü§ñ AI Design Chat</h3>
      <div id="chatMessages" style="max-height:400px;overflow-y:auto;">
        <% if (!design.chat || design.chat.length === 0) { %>
          <div class="empty-state" id="chatEmpty">Ask the AI anything about this design ‚Äî refine sections, explore alternatives, or prepare for customer review.</div>
        <% } else { %>
          <% design.chat.forEach(function(c) { %>
            <div class="chat-bubble" style="<%= c.from === 'AI Assistant' ? 'background: var(--accent-dim); border-left:3px solid var(--accent);' : '' %>">
              <div class="chat-meta"><strong><%= c.from === 'AI Assistant' ? 'ü§ñ AI' : 'üë§ ' + c.from %></strong> ‚Äî <%= melb(c.ts) %></div>
              <div class="chat-text" style="white-space:pre-wrap;"><%= c.text %></div>
            </div>
          <% }) %>
        <% } %>
      </div>
      <div class="chat-input">
        <textarea id="chatInput" placeholder="Ask about the design, request changes, or discuss before publishing‚Ä¶" rows="2"></textarea>
        <button id="chatSendBtn" onclick="sendChat()" class="btn btn-primary" style="align-self:flex-end;">Send</button>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({
      startOnLoad: false,
      theme: 'dark',
      themeVariables: {
        primaryColor: '#0f1d32', primaryTextColor: '#f0f4f8', primaryBorderColor: '#1199fa',
        lineColor: '#1199fa', secondaryColor: '#0a1628', tertiaryColor: '#0f1d32',
        fontFamily: 'Inter, system-ui, -apple-system, sans-serif', fontSize: '14px',
        nodeBorder: '#1199fa', mainBkg: '#0f1d32', clusterBkg: '#0a1628',
        clusterBorder: 'rgba(255,255,255,0.08)', edgeLabelBackground: '#0a1628'
      }
    });

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
      });
    });

    // HowItWorks step flow rendering
    <% if (hasNewFormat && customerDesign && customerDesign.HowItWorks) { %>
    (function() {
      const text = `<%- (customerDesign.HowItWorks || '').replace(/`/g, '\\`').replace(/\\/g, '\\\\') %>`;
      const container = document.getElementById('howItWorksFlow');
      if (!container || !text) return;
      const lines = text.split('\n');
      const steps = [];
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        const m = line.match(/^(\d+)\.\s+\*\*(.+?)\*\*\s*[-‚Äî:]*\s*(.*)/);
        if (m) {
          let desc = m[3].trim();
          if (!desc) {
            for (let j = i+1; j < Math.min(i+4, lines.length); j++) {
              const next = lines[j].trim();
              if (next && !next.match(/^\d+\./)) { desc = next.replace(/^[-‚Ä¢]\s*/, ''); break; }
            }
          }
          steps.push({ num: m[1], title: m[2], desc: desc.substring(0, 200) });
        }
      }
      if (steps.length === 0) {
        // Fallback: just render as formatted text
        container.style.paddingLeft = '0';
        container.className = 'section-body';
        container.innerHTML = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        return;
      }
      container.innerHTML = steps.map(s =>
        '<div class="step-item">' +
          '<div class="step-num">' + s.num + '</div>' +
          '<div class="step-title">' + s.title + '</div>' +
          (s.desc ? '<div class="step-desc">' + s.desc + '</div>' : '') +
        '</div>'
      ).join('');
    })();
    <% } %>

    let flowchartZoom = 1;
    function zoomFlowchart(delta) {
      if (delta === 0) flowchartZoom = 1;
      else flowchartZoom = Math.max(0.4, Math.min(3, flowchartZoom + delta));
      const svg = document.querySelector('#flowchartRender svg');
      if (svg) svg.style.transform = 'scale(' + flowchartZoom + ')';
    }

    async function renderMermaidSafe(elementId, code, container) {
      try {
        const prev = document.getElementById(elementId);
        if (prev) prev.remove();
        const { svg } = await mermaid.render(elementId, code);
        container.innerHTML = svg;
      } catch(e) {
        container.innerHTML = '<div class="flowchart-error"><strong>‚ö†Ô∏è Flowchart rendering failed</strong><p>' + (e.message || 'Unknown error') + '</p><pre>' + code.replace(/</g,'&lt;') + '</pre></div>';
      }
    }

    // Render saved flowchart
    <% if (design.flowchart) { %>
    (async () => {
      await renderMermaidSafe('flowchart-svg-saved', `<%- design.flowchart.replace(/`/g, '\\`').replace(/\\/g, '\\\\') %>`, document.getElementById('flowchartRender'));
    })();
    <% } %>

    // AI Chat
    async function sendChat() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;
      const btn = document.getElementById('chatSendBtn');
      btn.disabled = true; btn.textContent = '‚è≥‚Ä¶';
      input.value = '';
      const empty = document.getElementById('chatEmpty');
      if (empty) empty.remove();
      const msgs = document.getElementById('chatMessages');
      const userBubble = document.createElement('div');
      userBubble.className = 'chat-bubble';
      userBubble.innerHTML = '<div class="chat-meta"><strong>üë§ You</strong> ‚Äî just now</div><div class="chat-text">' + text.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>';
      msgs.appendChild(userBubble);
      const typing = document.createElement('div');
      typing.className = 'chat-bubble';
      typing.style.background = 'var(--accent-dim)';
      typing.style.borderLeft = '3px solid var(--accent)';
      typing.innerHTML = '<div class="chat-meta"><strong>ü§ñ AI</strong></div><div class="chat-text" style="color: var(--text-muted);">Thinking‚Ä¶</div>';
      msgs.appendChild(typing);
      msgs.scrollTop = msgs.scrollHeight;
      try {
        const res = await fetch('/admin/projects/<%= encodeId(projectId) %>/design/chat', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ designId: '<%= design.id %>', text })
        });
        if (!res.ok) throw new Error('Server returned ' + res.status);
        const data = await res.json();
        typing.querySelector('.chat-text').style.whiteSpace = 'pre-wrap';
        typing.querySelector('.chat-text').style.color = 'var(--text-secondary)';
        typing.querySelector('.chat-text').textContent = data.aiMessage.text;
      } catch (e) {
        typing.querySelector('.chat-text').textContent = 'Error: ' + e.message;
      } finally {
        btn.disabled = false; btn.textContent = 'Send';
        msgs.scrollTop = msgs.scrollHeight;
      }
    }
    document.getElementById('chatInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
    });

    // Send to Engine
    async function sendToEngine() {
      const btn = document.getElementById('sendToEngineBtn');
      if (!btn) return;
      if (!confirm('Send this approved design to Morti Engine for build planning?')) return;
      btn.disabled = true; btn.textContent = '‚è≥ Sending to Engine...';
      try {
        const res = await fetch('/admin/projects/<%= encodeId(projectId) %>/send-to-engine', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        btn.textContent = '‚úÖ Sent to Engine';
        btn.style.background = 'var(--accent-secondary)';
        setTimeout(() => window.location.reload(), 2000);
      } catch (e) {
        btn.disabled = false; btn.textContent = 'üöÄ Send to Engine';
        alert('Failed to send to engine: ' + e.message);
      }
    }

    // Assign/Accept question handlers
    async function acceptAssumption(btn, questionText, assumption) {
      try {
        const res = await fetch('/admin/projects/<%= encodeId(projectId) %>/design/accept-assumption', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ designId: '<%= design.id %>', questionText, assumption })
        });
        if (res.ok) {
          const card = btn.closest('.question-card');
          card.style.transition = 'opacity 0.3s'; card.style.opacity = '0';
          setTimeout(() => card.remove(), 300);
        } else { alert('Failed to accept assumption'); }
      } catch (e) { alert('Error: ' + e.message); }
    }

    async function assignQuestion(btn, questionText) {
      try {
        const res = await fetch('/admin/projects/<%= encodeId(projectId) %>/design/assign-question', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ designId: '<%= design.id %>', questionText, assignedTo: 'customer' })
        });
        if (res.ok) { btn.style.background = '#f59e0b'; btn.textContent = 'üë§ Customer ‚úì'; }
        else { alert('Failed to assign question'); }
      } catch (e) { alert('Error: ' + e.message); }
    }

    document.getElementById('generateFlowchart').addEventListener('click', async function() {
      const btn = this;
      btn.disabled = true; btn.textContent = '‚è≥ Generating‚Ä¶';
      const container = document.getElementById('flowchartContainer');
      const render = document.getElementById('flowchartRender');
      let responseData = null;
      try {
        const res = await fetch('/admin/projects/<%= encodeId(projectId) %>/design/flowchart', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        if (!res.ok) throw new Error('Server returned ' + res.status);
        responseData = await res.json();
        if (!responseData.mermaid) throw new Error('No flowchart data returned');
        container.style.display = 'block';
        flowchartZoom = 1;
        await renderMermaidSafe('flowchart-svg', responseData.mermaid, render);
      } catch (e) {
        container.style.display = 'block';
        render.innerHTML = '<div class="flowchart-error"><strong>‚ö†Ô∏è Flowchart generation failed</strong><p>' + e.message + '</p>' + (responseData && responseData.mermaid ? '<pre>' + responseData.mermaid.replace(/</g,'&lt;') + '</pre>' : '') + '</div>';
      } finally {
        btn.disabled = false; btn.textContent = 'üó∫Ô∏è Flowchart';
      }
    });
  </script>
<% } %>
</body>
</html>