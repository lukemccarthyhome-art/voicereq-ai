<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Morti Projects</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#f0f2f5; line-height:1.6; color:#0f172a; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:16px 0; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .header-container { max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; padding:0 20px; }
    .logo { font-size:20px; font-weight:bold; display:flex; align-items:center; gap:8px; text-decoration:none; color:white; }
    .nav { display:flex; gap:12px; align-items:center; }
    .nav a { color:rgba(255,255,255,0.9); text-decoration:none; padding:8px 14px; border-radius:6px; transition:background 0.2s; font-weight:500; font-size:14px; }
    .nav a:hover { background:rgba(255,255,255,0.2); }
    .main { max-width:1100px; margin:0 auto; padding:24px 20px; }
    .breadcrumb { font-size:13px; color:#64748b; margin-bottom:16px; }
    .breadcrumb a { color:#667eea; text-decoration:none; }
    .breadcrumb a:hover { text-decoration:underline; }
    .card { background:white; border-radius:12px; padding:24px; margin-bottom:20px; box-shadow:0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04); }
    .card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .card-header h2 { font-size:20px; color:#0f172a; }
    .badge { display:inline-block; padding:4px 10px; border-radius:12px; font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
    .badge-draft { background:#fef3c7; color:#92400e; }
    .badge-final { background:#d1fae5; color:#065f46; }
    .meta-row { display:flex; gap:24px; font-size:13px; color:#64748b; margin-bottom:4px; }
    .section { margin-top:20px; }
    .section h3 { font-size:16px; color:#334155; margin-bottom:8px; padding-bottom:6px; border-bottom:2px solid #eef2ff; }
    .section-body { font-size:14px; color:#334155; line-height:1.7; }
    .design-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:12px; }
    .design-item { padding:16px; border-radius:8px; background:#f8fafc; border:1px solid #e2e8f0; }
    .design-item h4 { font-size:13px; text-transform:uppercase; letter-spacing:0.5px; color:#667eea; margin-bottom:6px; }
    .design-item p, .design-item .section-body { font-size:13px; color:#475569; line-height:1.7; }
    .design-item .section-body p { margin-bottom:8px; }
    .full-width { grid-column: 1 / -1; }
    .btn { display:inline-flex; align-items:center; gap:6px; padding:8px 16px; border:none; border-radius:8px; font-weight:600; font-size:13px; cursor:pointer; transition:all 0.15s; text-decoration:none; }
    .btn:hover { transform:translateY(-1px); box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .btn-primary { background:#667eea; color:white; }
    .btn-amber { background:#f59e0b; color:white; }
    .btn-cyan { background:#06b6d4; color:white; }
    .btn-sm { padding:6px 12px; font-size:12px; }
    .question-card { padding:12px 16px; border-radius:8px; background:#f8fafc; border:1px solid #e2e8f0; margin-bottom:10px; }
    .question-card .q-id { display:inline-block; background:#667eea; color:white; width:24px; height:24px; border-radius:50%; text-align:center; line-height:24px; font-size:12px; font-weight:700; margin-right:8px; }
    .question-card .q-text { font-weight:600; color:#0f172a; font-size:14px; }
    .question-card .q-assumption { font-size:12px; color:#64748b; margin-top:4px; font-style:italic; }
    .question-card .q-answer { margin-top:8px; padding:8px 12px; background:#d1fae5; border-radius:6px; color:#065f46; font-size:13px; }
    .answer-form { display:flex; gap:8px; margin-top:8px; }
    .answer-form input[type="text"] { flex:1; padding:8px 12px; border:1px solid #dbeafe; border-radius:6px; font-size:13px; }
    .answer-form button { padding:8px 16px; }
    .chat-bubble { margin-bottom:10px; padding:10px 14px; border-radius:8px; background:#f1f5f9; }
    .chat-bubble .chat-meta { font-size:12px; color:#64748b; margin-bottom:4px; }
    .chat-bubble .chat-meta strong { color:#0f172a; }
    .chat-bubble .chat-text { font-size:14px; color:#0f172a; }
    .chat-input { display:flex; gap:8px; margin-top:12px; }
    .chat-input textarea { flex:1; padding:10px; border:1px solid #e2e8f0; border-radius:8px; font-size:13px; font-family:inherit; resize:vertical; min-height:60px; }
    #flowchartContainer { margin-top:16px; padding:16px; border:1px solid #e2e8f0; border-radius:8px; background:#fff; }
    #flowchartContainer h4 { margin-bottom:12px; color:#334155; }
    #flowchartRender { min-height:100px; display:flex; align-items:center; justify-content:center; }
    .empty-state { text-align:center; padding:24px; color:#94a3b8; font-size:14px; }
    @media (max-width:768px) {
      .design-grid { grid-template-columns:1fr; }
      .card-header { flex-direction:column; gap:12px; align-items:flex-start; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-container">
      <a href="/admin" class="logo">üéôÔ∏è Morti Projects</a>
      <nav class="nav">
        <a href="/admin">Dashboard</a>
        <a href="/admin/customers">Customers</a>
        <a href="/admin/projects">Projects</a>
                <a href="/admin/sessions">Sessions</a>
                <a href="/admin/feature-requests">Feature Requests</a>
        <a href="/profile">Profile</a>
        <a href="/logout">üö™ Logout</a>
      </nav>
    </div>
  </div>

  <main class="main">
    <div class="breadcrumb">
      <a href="/admin">Dashboard</a> ‚Ä∫ <a href="/admin/projects">Projects</a>
                <a href="/admin/sessions">Sessions</a>
                <a href="/admin/feature-requests">Feature Requests</a> ‚Ä∫ <a href="/admin/projects/<%= projectId %>">Project <%= projectId %></a> ‚Ä∫ Design
    </div>

    <% if (locals.generating && !design) { %>
    <div class="card" style="text-align: center; padding: 60px;" id="genCard">
      <div style="font-size: 3rem; margin-bottom: 16px;" id="genSpinner">‚è≥</div>
      <h3 style="color: #667eea; margin-bottom: 8px;" id="genTitle">Extracting Design...</h3>
      <p style="color: #94a3b8;" id="genMsg">AI is analysing your project requirements and building a solution design. This usually takes 20-40 seconds.</p>
      <div style="margin-top: 16px; width: 200px; height: 4px; background: #e2e8f0; border-radius: 2px; margin-left: auto; margin-right: auto; overflow: hidden;">
        <div style="width: 30%; height: 100%; background: #667eea; border-radius: 2px; animation: designProgress 2s ease-in-out infinite;"></div>
      </div>
    </div>
    <style>@keyframes designProgress { 0% { width: 10%; margin-left: 0; } 50% { width: 60%; margin-left: 20%; } 100% { width: 10%; margin-left: 90%; } }</style>
    <script>
    (function pollDesignStatus() {
      const projectId = '<%= projectId %>';
      let elapsed = 0;
      const interval = setInterval(async () => {
        elapsed += 2;
        try {
          const res = await fetch(`/admin/projects/${projectId}/generation-status`);
          const data = await res.json();
          if (data.status === 'done') {
            clearInterval(interval);
            window.location.reload();
          } else if (data.status === 'error') {
            clearInterval(interval);
            document.getElementById('genSpinner').textContent = '‚ùå';
            document.getElementById('genTitle').textContent = 'Extraction Failed';
            document.getElementById('genTitle').style.color = '#dc2626';
            document.getElementById('genMsg').textContent = data.error || 'Unknown error. Try again.';
          } else if (elapsed > 120) {
            clearInterval(interval);
            document.getElementById('genMsg').textContent = 'Taking longer than expected. Try refreshing the page.';
          }
        } catch(e) { /* retry */ }
      }, 2000);
    })();
    </script>
    <% } else if (locals.genError) { %>
    <div class="card" style="text-align: center; padding: 60px;">
      <div style="font-size: 3rem; margin-bottom: 16px;">‚ùå</div>
      <h3 style="color: #dc2626; margin-bottom: 8px;">Design Extraction Failed</h3>
      <p style="color: #94a3b8;"><%= locals.genError %></p>
      <a href="/admin/projects/<%= projectId %>" class="btn" style="margin-top: 16px;">‚Üê Back to Project</a>
    </div>
    <% } else if (design) { %>
    <%
      // Use pre-parsed sections from server if available, otherwise try parsing markdown
      let designSections = design.sections || null;
      let designSummary = design.summary || '';
      if (!designSections) {
        try {
          if (design.designMarkdown && design.designMarkdown.trim().startsWith('```json')) {
            const jsonText = design.designMarkdown.replace(/```json\s*|```/g, '').trim();
            const parsed = JSON.parse(jsonText);
            if (parsed.design) designSections = parsed.design;
            if (parsed.summary) designSummary = parsed.summary;
          }
        } catch(e) {}
      }
    %>

    <% if (locals.generating) { %>
    <div style="background:#eef2ff;border:2px solid #c7d2fe;border-radius:8px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:12px;" id="refreshBanner">
      <div style="animation: spin 1s linear infinite; font-size:1.2rem;">‚è≥</div>
      <div style="flex:1;">
        <strong style="color:#4338ca;">Refreshing design...</strong>
        <span style="color:#6366f1;font-size:0.9rem;"> AI is updating the design with new information.</span>
      </div>
    </div>
    <style>@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>
    <script>
    (function pollRefresh() {
      const projectId = '<%= projectId %>';
      const interval = setInterval(async () => {
        try {
          const res = await fetch(`/admin/projects/${projectId}/generation-status`);
          const data = await res.json();
          if (data.status === 'done' || data.status === 'error') {
            clearInterval(interval);
            window.location.reload();
          }
        } catch(e) {}
      }, 2000);
    })();
    </script>
    <% } %>

    <!-- Header Card -->
    <div class="card">
      <div class="card-header">
        <div>
          <h2>üìê Solution Design</h2>
          <div class="meta-row" style="margin-top:8px;">
            <span>üë§ <%= design.owner %></span>
            <span>üìÖ <%= new Date(design.createdAt).toLocaleString() %></span>
            <% if (design.version) { %><span>v<%= design.version %></span><% } %>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="badge <%= (design.status === 'final') ? 'badge-final' : 'badge-draft' %>"><%= design.status || 'draft' %></span>
          <form method="POST" action="/admin/projects/<%= projectId %>/extract-design" style="margin:0">
            <button type="submit" class="btn btn-amber btn-sm">üîÑ Refresh</button>
          </form>
          <button id="generateFlowchart" class="btn btn-cyan btn-sm">üó∫Ô∏è Flowchart</button>
          <% if (design.published) { %>
            <form method="POST" action="/admin/projects/<%= projectId %>/design/unpublish" style="margin:0">
              <button type="submit" class="btn btn-sm" style="background:#ef4444;color:white;">üîí Unpublish</button>
            </form>
            <span class="badge badge-final" style="font-size:10px;">Published <%= design.publishedAt ? new Date(design.publishedAt).toLocaleDateString() : '' %></span>
          <% } else { %>
            <form method="POST" action="/admin/projects/<%= projectId %>/design/publish" style="margin:0">
              <button type="submit" class="btn btn-sm" style="background:#10b981;color:white;">üì§ Publish to Customer</button>
            </form>
          <% } %>

          <% if (design.approvedAt) { %>
            <% if (design.sentToEngineAt) { %>
              <span class="badge badge-final" style="font-size:10px;">‚úÖ Sent to Engine <%= new Date(design.sentToEngineAt).toLocaleDateString() %></span>
              <% if (design.enginePlanId) { %>
                <a href="<%= (process.env.ENGINE_API_URL || 'http://localhost:3100') %>/builds/<%= design.enginePlanId %>" target="_blank" class="btn btn-sm" style="background:#06b6d4;color:white;font-size:11px;">üîó View Build</a>
              <% } %>
            <% } else { %>
              <button id="sendToEngineBtn" onclick="sendToEngine()" class="btn btn-sm" style="background:#059669;color:white;">üöÄ Send to Engine</button>
            <% } %>
          <% } %>
        </div>
      </div>

      <% if (designSummary) { %>
        <div style="padding:12px 16px;background:#eef2ff;border-radius:8px;font-size:14px;color:#3730a3;margin-bottom:16px;">
          <strong>Summary:</strong> <%= designSummary %>
        </div>
      <% } %>

      <% if (designSections) { %>
        <div class="design-grid">
          <% const sectionOrder = ['ExecutiveSummary','CoreWorkflow','SimplifiedArchitecture','MinimalDataModel','ManualVsAutomated','Assumptions','Dependencies','Phase2Enhancements','RisksAndMitigations','BuildEffortEstimate']; %>
          <% const sectionLabels = { ExecutiveSummary:'Executive Summary', CoreWorkflow:'Core Workflow', SimplifiedArchitecture:'Simplified Architecture', MinimalDataModel:'Minimal Data Model', ManualVsAutomated:'Manual vs Automated', Assumptions:'Assumptions', Dependencies:'Dependencies', Phase2Enhancements:'Phase 2 Enhancements (Out of Scope)', RisksAndMitigations:'Risks & Mitigations', BuildEffortEstimate:'Build Effort Estimate' }; %>
          <% const fullWidthSections = ['ExecutiveSummary','CoreWorkflow','SimplifiedArchitecture','MinimalDataModel','ManualVsAutomated','Phase2Enhancements']; %>
          <%
            // Also render any sections not in the predefined order
            const allKeys = Object.keys(designSections);
            const orderedKeys = sectionOrder.filter(k => designSections[k]);
            const extraKeys = allKeys.filter(k => !sectionOrder.includes(k));
            const renderKeys = orderedKeys.concat(extraKeys);
          %>
          <% renderKeys.forEach(key => { %>
            <% if (designSections[key]) { %>
              <div class="design-item <%= fullWidthSections.includes(key) ? 'full-width' : '' %>">
                <h4><%= sectionLabels[key] || key.replace(/([A-Z])/g, ' $1').trim() %></h4>
                <div class="section-body"><%- (function(txt) {
                  let s = txt.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                  // Format [ASSUMPTION] tags
                  s = s.replace(/\[ASSUMPTION\]/g,'<span style="background:#fef3c7;padding:1px 6px;border-radius:3px;font-size:12px;font-weight:600;color:#92400e;">ASSUMPTION</span>');
                  // Bold text
                  s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                  // Split into lines
                  const lines = s.split('\n');
                  let html = '';
                  let inList = false;
                  let listType = '';
                  for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) {
                      if (inList) { html += listType === 'ul' ? '</ul>' : '</ol>'; inList = false; }
                      html += '<div style="height:8px"></div>';
                      continue;
                    }
                    const bullet = line.match(/^[-‚Ä¢]\s+(.+)/);
                    const numbered = line.match(/^(\d+)\.\s+(.+)/);
                    if (bullet) {
                      if (!inList || listType !== 'ul') {
                        if (inList) html += listType === 'ul' ? '</ul>' : '</ol>';
                        html += '<ul style="margin:4px 0 4px 20px;padding:0;">';
                        inList = true; listType = 'ul';
                      }
                      html += '<li style="margin-bottom:3px;">' + bullet[1] + '</li>';
                    } else if (numbered) {
                      if (!inList || listType !== 'ol') {
                        if (inList) html += listType === 'ul' ? '</ul>' : '</ol>';
                        html += '<ol style="margin:4px 0 4px 20px;padding:0;">';
                        inList = true; listType = 'ol';
                      }
                      html += '<li style="margin-bottom:3px;">' + numbered[2] + '</li>';
                    } else {
                      if (inList) { html += listType === 'ul' ? '</ul>' : '</ol>'; inList = false; }
                      html += '<p style="margin:0 0 4px 0;">' + line + '</p>';
                    }
                  }
                  if (inList) html += listType === 'ul' ? '</ul>' : '</ol>';
                  return html;
                })(designSections[key]) %></div>
              </div>
            <% } %>
          <% }) %>
        </div>
      <% } else { %>
        <div class="section">
          <div class="section-body">
            <%- design.designHtml || '<div class="empty-state">No design content generated yet. Click Refresh to generate.</div>' %>
          </div>
        </div>
      <% } %>
    </div>

    <!-- Flowchart -->
    <div id="flowchartContainer" style="<%= design.flowchart ? '' : 'display:none;' %>" class="card">
      <h3 style="margin-bottom:12px;">üó∫Ô∏è Component Flowchart</h3>
      <div id="flowchartRender"></div>
    </div>

    <!-- Questions -->
    <div class="card">
      <h3 style="margin-bottom:12px;">‚ùì Outstanding Questions</h3>
      <% if (!design.questions || design.questions.length === 0) { %>
        <div class="empty-state">‚úÖ No outstanding questions ‚Äî design is complete based on available requirements.</div>
      <% } else { %>
        <% design.questions.forEach(function(q, i) { %>
          <%
            const isObj = (typeof q === 'object' && q !== null);
            const qText = isObj ? q.text : String(q);
            const qId = isObj ? q.id : (i+1);
            const qAssumption = isObj ? q.assumption : '';
            const answered = (design.answers || []).find(a => a.question === qText);
          %>
          <div class="question-card">
            <div>
              <span class="q-id"><%= qId %></span>
              <span class="q-text"><%= qText %></span>
            </div>
            <% if (qAssumption) { %>
              <div class="q-assumption">üí° <%= qAssumption %></div>
            <% } %>
            <%
              const customerAnswered = (design.customerAnswers || []).find(a => a.question === qText);
              const assignedTo = isObj && q.assignedTo ? q.assignedTo : 'admin';
            %>
            <% if (answered) { %>
              <div class="q-answer">‚úÖ <strong>Answer:</strong> <%= answered.answer %> <span style="font-size:11px;color:#6b7280">‚Äî <%= answered.from %>, <%= new Date(answered.ts).toLocaleString() %></span></div>
            <% } else if (customerAnswered) { %>
              <div class="q-answer">‚úÖ <strong>Customer Answer:</strong> <%= customerAnswered.answer %> <span style="font-size:11px;color:#6b7280">‚Äî <%= customerAnswered.from %>, <%= new Date(customerAnswered.ts).toLocaleString() %></span></div>
            <% } else { %>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <form method="POST" action="/admin/projects/<%= projectId %>/design/answer" class="answer-form" style="flex:1;margin-top:0;">
                  <input type="hidden" name="designId" value="<%= design.id %>" />
                  <input type="hidden" name="question" value="<%= qText %>" />
                  <input type="text" name="answer" placeholder="Type your answer‚Ä¶" />
                  <button type="submit" class="btn btn-primary btn-sm">Save</button>
                </form>
                <button onclick="assignQuestion(this, '<%= qText.replace(/'/g, "\\'") %>')" class="btn btn-sm" style="background:<%= assignedTo === 'customer' ? '#f59e0b' : '#94a3b8' %>;color:white;white-space:nowrap;font-size:11px;" title="<%= assignedTo === 'customer' ? 'Assigned to customer' : 'Click to assign to customer' %>">
                  üë§ <%= assignedTo === 'customer' ? 'Customer ‚úì' : 'Assign to Customer' %>
                </button>
                <% if (qAssumption) { %>
                <button onclick="acceptAssumption(this, '<%= qText.replace(/'/g, "\\'") %>', '<%= qAssumption.replace(/'/g, "\\'") %>')" class="btn btn-sm" style="background:#8b5cf6;color:white;white-space:nowrap;font-size:11px;" title="Accept the assumption and move this question out">
                  üí° Accept Assumption
                </button>
                <% } %>
              </div>
            <% } %>
          </div>
        <% }) %>
      <% } %>
    </div>

    <!-- Accepted Assumptions -->
    <% if (design.acceptedAssumptions && design.acceptedAssumptions.length > 0) { %>
    <div class="card" style="border-left: 4px solid #8b5cf6;">
      <h3 style="margin-bottom:12px;">üí° Accepted Assumptions</h3>
      <p style="color:#64748b;font-size:12px;margin-bottom:12px;">These assumptions were accepted in place of asking more questions. They are incorporated into the design on refresh.</p>
      <% design.acceptedAssumptions.forEach(function(a) { %>
        <div style="padding:10px 14px;background:#f5f3ff;border-left:3px solid #8b5cf6;border-radius:0 8px 8px 0;margin-bottom:8px;">
          <div style="font-size:13px;color:#64748b;">‚ùì <%= a.question %></div>
          <div style="font-size:14px;color:#0f172a;margin-top:4px;">üí° <strong>Assumption:</strong> <%= a.assumption %></div>
          <div style="font-size:11px;color:#94a3b8;margin-top:4px;">Accepted by <%= a.acceptedBy %> ¬∑ <%= new Date(a.ts).toLocaleString() %></div>
        </div>
      <% }) %>
    </div>
    <% } %>

    <!-- AI Chat -->
    <div class="card">
      <h3 style="margin-bottom:12px;">ü§ñ AI Design Chat</h3>
      <div id="chatMessages" style="max-height:400px;overflow-y:auto;">
        <% if (!design.chat || design.chat.length === 0) { %>
          <div class="empty-state" id="chatEmpty">Ask the AI anything about this design ‚Äî refine sections, explore alternatives, or prepare for customer review.</div>
        <% } else { %>
          <% design.chat.forEach(function(c) { %>
            <div class="chat-bubble" style="<%= c.from === 'AI Assistant' ? 'background:#eef2ff;border-left:3px solid #667eea;' : '' %>">
              <div class="chat-meta"><strong><%= c.from === 'AI Assistant' ? 'ü§ñ AI' : 'üë§ ' + c.from %></strong> ‚Äî <%= new Date(c.ts).toLocaleString() %></div>
              <div class="chat-text" style="white-space:pre-wrap;"><%= c.text %></div>
            </div>
          <% }) %>
        <% } %>
      </div>
      <div class="chat-input">
        <textarea id="chatInput" placeholder="Ask about the design, request changes, or discuss before publishing‚Ä¶" rows="2"></textarea>
        <button id="chatSendBtn" onclick="sendChat()" class="btn btn-primary" style="align-self:flex-end;">Send</button>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: false, theme: 'default' });

    // Render saved flowchart on page load
    <% if (design.flowchart) { %>
    (async () => {
      try {
        const { svg } = await mermaid.render('flowchart-svg-saved', `<%- design.flowchart.replace(/`/g, '\\`').replace(/\\/g, '\\\\') %>`);
        document.getElementById('flowchartRender').innerHTML = svg;
      } catch(e) { console.warn('Saved flowchart render failed:', e); }
    })();
    <% } %>

    // AI Chat
    async function sendChat() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;
      const btn = document.getElementById('chatSendBtn');
      btn.disabled = true; btn.textContent = '‚è≥‚Ä¶';
      input.value = '';

      // Remove empty state
      const empty = document.getElementById('chatEmpty');
      if (empty) empty.remove();

      // Show user message immediately
      const msgs = document.getElementById('chatMessages');
      const userBubble = document.createElement('div');
      userBubble.className = 'chat-bubble';
      userBubble.innerHTML = '<div class="chat-meta"><strong>üë§ You</strong> ‚Äî just now</div><div class="chat-text">' + text.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>';
      msgs.appendChild(userBubble);

      // Show typing indicator
      const typing = document.createElement('div');
      typing.className = 'chat-bubble';
      typing.style.background = '#eef2ff';
      typing.style.borderLeft = '3px solid #667eea';
      typing.innerHTML = '<div class="chat-meta"><strong>ü§ñ AI</strong></div><div class="chat-text" style="color:#64748b;">Thinking‚Ä¶</div>';
      msgs.appendChild(typing);
      msgs.scrollTop = msgs.scrollHeight;

      try {
        const res = await fetch('/admin/projects/<%= projectId %>/design/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ designId: '<%= design.id %>', text })
        });
        if (!res.ok) throw new Error('Server returned ' + res.status);
        const data = await res.json();
        typing.querySelector('.chat-text').style.whiteSpace = 'pre-wrap';
        typing.querySelector('.chat-text').style.color = '#0f172a';
        typing.querySelector('.chat-text').textContent = data.aiMessage.text;
      } catch (e) {
        typing.querySelector('.chat-text').textContent = 'Error: ' + e.message;
      } finally {
        btn.disabled = false; btn.textContent = 'Send';
        msgs.scrollTop = msgs.scrollHeight;
      }
    }

    document.getElementById('chatInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
    });

    // Send to Engine
    async function sendToEngine() {
      const btn = document.getElementById('sendToEngineBtn');
      if (!btn) return;
      if (!confirm('Send this approved design to Morti Engine for build planning?')) return;
      btn.disabled = true;
      btn.textContent = '‚è≥ Sending...';
      try {
        const res = await fetch('/admin/projects/<%= projectId %>/send-to-engine', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');
        btn.textContent = '‚úÖ Sent!';
        btn.style.background = '#10b981';
        setTimeout(() => window.location.reload(), 1500);
      } catch (e) {
        btn.disabled = false;
        btn.textContent = 'üöÄ Send to Engine';
        alert('Failed to send to engine: ' + e.message);
      }
    }

    // Assign question to customer
    async function acceptAssumption(btn, questionText, assumption) {
      try {
        const res = await fetch('/admin/projects/<%= projectId %>/design/accept-assumption', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ designId: '<%= design.id %>', questionText, assumption })
        });
        if (res.ok) {
          // Remove the question card from the UI
          const card = btn.closest('.question-card');
          card.style.transition = 'opacity 0.3s';
          card.style.opacity = '0';
          setTimeout(() => card.remove(), 300);
        } else {
          alert('Failed to accept assumption');
        }
      } catch (e) { alert('Error: ' + e.message); }
    }

    async function assignQuestion(btn, questionText) {
      try {
        const res = await fetch('/admin/projects/<%= projectId %>/design/assign-question', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ designId: '<%= design.id %>', questionText, assignedTo: 'customer' })
        });
        if (res.ok) {
          btn.style.background = '#f59e0b';
          btn.textContent = 'üë§ Customer ‚úì';
        } else {
          alert('Failed to assign question');
        }
      } catch (e) { alert('Error: ' + e.message); }
    }

    document.getElementById('generateFlowchart').addEventListener('click', async function() {
      const btn = this;
      btn.disabled = true;
      btn.textContent = '‚è≥ Generating‚Ä¶';
      try {
        const res = await fetch('/admin/projects/<%= projectId %>/design/flowchart', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        if (!res.ok) throw new Error('Server returned ' + res.status);
        const data = await res.json();
        if (!data.mermaid) throw new Error('No flowchart data returned');

        const container = document.getElementById('flowchartContainer');
        const render = document.getElementById('flowchartRender');
        container.style.display = 'block';

        // Use mermaid.render for reliable rendering
        // Sanitize labels with special chars
        let code = data.mermaid.replace(/(\w+)(\[|\(|\{)([^\]})]+)(\]|\)|\})/g, (m, id, open, label, close) => {
          if (/[\/\\(){}|<>#&]/.test(label) && !label.startsWith('"')) {
            return id + open + '"' + label.replace(/"/g, "'") + '"' + close;
          }
          return m;
        });
        const { svg } = await mermaid.render('flowchart-svg', code);
        render.innerHTML = svg;
      } catch (e) {
        render.innerHTML = '<div style="color:#ef4444;padding:12px;">Flowchart rendering failed: ' + e.message + '<br><br><pre style="font-size:11px;background:#f8fafc;padding:8px;border-radius:4px;overflow-x:auto;">' + (data && data.mermaid ? data.mermaid : '') + '</pre></div>';
        container.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = 'üó∫Ô∏è Flowchart';
      }
    });
  </script>
<% } %>
</body>
</html>
