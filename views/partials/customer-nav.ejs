<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<style>
    .header {
        background: rgba(5, 13, 26, 0.8);
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border-glass);
        padding: 16px 0;
        position: relative;
        z-index: 100;
    }
    .header-container { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }
    .logo { font-size: 1.3rem; font-weight: 800; color: #fff; letter-spacing: -0.02em; text-decoration: none; display: flex; align-items: center; gap: 8px; }
    .nav { display: flex; gap: 8px; align-items: center; }
    .nav a { color: var(--text-muted); font-size: 0.88rem; padding: 8px 14px; border-radius: var(--radius-pill); transition: all 0.2s; font-weight: 500; text-decoration: none; }
    .nav a:hover { color: #fff; background: rgba(255,255,255,0.06); }
    .nav a.active { color: var(--accent); background: var(--accent-dim); }
    .nav a.feature-link { color: #f5c542 !important; }
    .nav a.feature-link:hover { background: rgba(245,197,66,0.12); }
    .user-name { background: #1199fa; padding: 8px 18px; border-radius: var(--radius-pill); font-weight: 600; font-size: 0.88rem; color: #fff; cursor: pointer; text-decoration: none; box-shadow: 0 0 16px rgba(17,153,250,0.4); border: none; transition: all 0.3s; }
    .user-name:hover { background: #2aa8ff; box-shadow: 0 0 24px rgba(17,153,250,0.4); }
    .user-dropdown { position: relative; }
    .user-dropdown-menu { position: absolute; top: calc(100% + 8px); right: 0; min-width: 160px; padding: 6px; background: rgba(10, 22, 40, 0.95); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--border-glass); border-radius: 12px; box-shadow: 0 16px 48px rgba(0,0,0,0.4); opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; z-index: 200; }
    .user-dropdown:hover .user-dropdown-menu { opacity: 1; visibility: visible; }
    .user-dropdown-menu a { display: block; padding: 10px 16px; font-size: 0.88rem; font-weight: 500; color: rgba(240,244,248,0.6); border-radius: 8px; transition: all 0.2s; text-decoration: none; }
    .user-dropdown-menu a:hover { color: #fff; background: rgba(255,255,255,0.06); }
    .projects-dropdown { position: relative; }
    .projects-dropdown-trigger { cursor: pointer; }
    .projects-dropdown-menu { position: absolute; top: calc(100% + 8px); left: 0; min-width: 220px; max-height: 360px; overflow-y: auto; padding: 6px; background: rgba(10, 22, 40, 0.95); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; box-shadow: 0 16px 48px rgba(0,0,0,0.4); opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; z-index: 200; }
    .projects-dropdown:hover .projects-dropdown-menu { opacity: 1; visibility: visible; }
    .projects-dropdown-menu a { display: block; padding: 10px 16px; font-size: 0.85rem; font-weight: 500; color: rgba(240,244,248,0.6); border-radius: 8px; transition: all 0.2s; text-decoration: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .projects-dropdown-menu a:hover { color: #fff; background: rgba(255,255,255,0.06); }
    .projects-dropdown-menu .divider { height: 1px; background: rgba(255,255,255,0.08); margin: 4px 6px; }

    /* Feature modal */
    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7); z-index: 1000;
        align-items: center; justify-content: center; backdrop-filter: blur(8px);
    }
    .modal-card {
        background: var(--bg-card); border: 1px solid var(--border-glass);
        border-radius: var(--radius); padding: 28px; width: 90%; max-width: 500px;
        box-shadow: 0 16px 48px rgba(0,0,0,0.4);
    }

    .mobile-menu-toggle { display: none; background: none; border: 1px solid var(--border-glass); border-radius: 8px; padding: 8px; cursor: pointer; flex-direction: column; gap: 4px; align-items: center; justify-content: center; }
    .mobile-menu-toggle span { display: block; width: 20px; height: 2px; background: var(--text-secondary); border-radius: 2px; transition: all 0.2s; }

    @media (max-width: 768px) {
        .mobile-menu-toggle { display: flex; }
        .header-container { flex-direction: row; flex-wrap: wrap; }
        .nav { display: none; flex-direction: column; width: 100%; gap: 2px; padding-top: 12px; border-top: 1px solid var(--border-glass); margin-top: 8px; }
        .nav.nav-open { display: flex; }
        .nav a { padding: 10px 14px; font-size: 0.92rem; text-align: left; border-radius: 8px; }
        .nav a:hover { background: rgba(255,255,255,0.06); }
        .user-name { padding: 10px 18px; font-size: 0.92rem; text-align: center; }
    }
</style>
<div class="header">
    <div class="header-container">
        <a href="/" class="logo">‚óÜ Morti</a>
        <button class="mobile-menu-toggle" onclick="document.querySelector('.nav').classList.toggle('nav-open')" aria-label="Menu">
            <span></span><span></span><span></span>
        </button>
        <nav class="nav">
            <a href="/dashboard"<%- currentPage === 'dashboard' ? ' class="active"' : '' %>>Dashboard</a>
            <div class="projects-dropdown">
                <a href="/projects" class="<%= currentPage === 'projects' ? 'active ' : '' %>projects-dropdown-trigger">Projects ‚ñæ</a>
                <div class="projects-dropdown-menu">
                    <% if (typeof navProjects !== 'undefined' && navProjects && navProjects.length > 0) { %>
                        <% navProjects.filter(p => p.status !== 'archived').forEach(function(p) { %>
                            <a href="/projects/<%= encodeId(p.id) %>"><%= p.name %></a>
                        <% }); %>
                    <% } else { %>
                        <a href="/projects" style="color:rgba(240,244,248,0.3);pointer-events:none;">No projects yet</a>
                    <% } %>
                    <div class="divider"></div>
                    <a href="/projects">All Projects</a>
                    <a href="/projects/archived">Archived</a>
                </div>
            </div>
            <a href="/help"<%- currentPage === 'help' ? ' class="active"' : '' %>>Help</a>
            <a href="#" class="feature-link" onclick="document.getElementById('featureModal').style.display='flex';setFeatureType('feature');return false;">üí° Feedback</a>
            <div class="user-dropdown">
                <span class="user-name">üë§ <%= user.name %> ‚ñæ</span>
                <div class="user-dropdown-menu">
                    <a href="/dashboard">Dashboard</a>
                    <a href="/profile">Profile</a>
                    <a href="/billing">Billing</a>
                    <a href="/logout">Logout</a>
                </div>
            </div>
        </nav>
    </div>
</div>

<!-- Feature Request Modal -->
<div class="modal-overlay" id="featureModal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h3 style="color:var(--text-primary);font-weight:700;" id="featureModalTitle">üí° Feedback</h3>
      <button onclick="document.getElementById('featureModal').style.display='none'" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted);">&times;</button>
    </div>
    <!-- Type toggle -->
    <div style="display:flex;gap:4px;margin-bottom:14px;background:rgba(5,13,26,0.6);border-radius:var(--radius-pill);padding:3px;border:1px solid var(--border-glass);">
      <button id="typeFeatureBtn" onclick="setFeatureType('feature')" style="flex:1;padding:8px 16px;border:none;border-radius:var(--radius-pill);font-size:0.85rem;font-weight:600;cursor:pointer;font-family:'Inter',sans-serif;transition:all 0.2s;background:var(--accent);color:#fff;">üí° Feature</button>
      <button id="typeBugBtn" onclick="setFeatureType('bug')" style="flex:1;padding:8px 16px;border:none;border-radius:var(--radius-pill);font-size:0.85rem;font-weight:600;cursor:pointer;font-family:'Inter',sans-serif;transition:all 0.2s;background:transparent;color:var(--text-secondary);">üêõ Bug / Error</button>
    </div>
    <textarea id="featureText" rows="5" placeholder="Tell us what you'd like to see, or what could be better..." style="width:100%;padding:12px;border:1px solid var(--border-glass);border-radius:12px;font-size:0.88rem;font-family:'Inter',sans-serif;resize:vertical;background:rgba(5,13,26,0.6);color:var(--text-primary);"></textarea>
    <!-- Screenshot upload -->
    <div style="margin-top:10px;">
      <label for="featureScreenshot" style="display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border:1px dashed var(--border-glass);border-radius:8px;cursor:pointer;font-size:0.82rem;color:var(--text-muted);transition:all 0.2s;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border-glass)';this.style.color='var(--text-muted)'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
        Attach screenshot
      </label>
      <input type="file" id="featureScreenshot" accept=".png,.jpg,.jpeg,.gif,.webp,.pdf,.doc,.docx" style="display:none" onchange="updateScreenshotLabel(this)">
      <span id="screenshotName" style="font-size:0.78rem;color:var(--text-muted);margin-left:8px;"></span>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
      <button onclick="document.getElementById('featureModal').style.display='none'" style="padding:10px 24px;border:1px solid var(--border-glass);border-radius:var(--radius-pill);background:transparent;cursor:pointer;font-size:0.88rem;color:var(--text-secondary);font-family:'Inter',sans-serif;">Cancel</button>
      <button id="featureSubmitBtn" onclick="submitFeature()" style="padding:10px 24px;border:none;border-radius:var(--radius-pill);background:var(--accent);color:white;cursor:pointer;font-weight:600;font-size:0.88rem;box-shadow:0 0 16px var(--accent-glow);font-family:'Inter',sans-serif;">Submit</button>
    </div>
    <div id="featureStatus" style="margin-top:8px;font-size:0.82rem;"></div>
  </div>
</div>
<script>
let featureType = 'feature';
function setFeatureType(type) {
  featureType = type;
  const fBtn = document.getElementById('typeFeatureBtn');
  const bBtn = document.getElementById('typeBugBtn');
  const title = document.getElementById('featureModalTitle');
  const textarea = document.getElementById('featureText');
  if (type === 'bug') {
    bBtn.style.background = '#ef4444'; bBtn.style.color = '#fff';
    fBtn.style.background = 'transparent'; fBtn.style.color = 'var(--text-secondary)';
    title.textContent = 'üêõ Report a Bug';
    textarea.placeholder = 'Describe the issue: what happened, what you expected, and any steps to reproduce...';
  } else {
    fBtn.style.background = 'var(--accent)'; fBtn.style.color = '#fff';
    bBtn.style.background = 'transparent'; bBtn.style.color = 'var(--text-secondary)';
    title.textContent = 'üí° Feedback';
    textarea.placeholder = "Tell us what you'd like to see, or what could be better...";
  }
}
function updateScreenshotLabel(input) {
  const name = input.files[0] ? input.files[0].name : '';
  document.getElementById('screenshotName').textContent = name;
}
async function submitFeature(){
  const text=document.getElementById('featureText').value.trim();
  if(!text)return;
  const st=document.getElementById('featureStatus');
  st.innerHTML='Submitting...';st.style.color='var(--text-muted)';
  try{
    const fd = new FormData();
    fd.append('text', text);
    fd.append('page', location.pathname);
    fd.append('type', featureType);
    const file = document.getElementById('featureScreenshot').files[0];
    if (file) fd.append('screenshot', file);
    const r=await fetch('/api/feature-request',{method:'POST',body:fd});
    if(!r.ok){ const err=await r.json(); throw new Error(err.error||'Failed'); }
    st.innerHTML='‚úÖ Thank you! Your feedback has been submitted.';st.style.color='#009e7e';
    document.getElementById('featureText').value='';
    document.getElementById('featureScreenshot').value='';
    document.getElementById('screenshotName').textContent='';
    setTimeout(()=>{document.getElementById('featureModal').style.display='none';st.innerHTML='';},2000);
  }catch(e){st.innerHTML='‚ùå '+(e.message||'Failed to submit. Please try again.');st.style.color='#ef4444';}
}
</script>
