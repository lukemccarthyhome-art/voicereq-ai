<%- include('layout-top', { 
  title: project.name, 
  headerTitle: project.name, 
  headerSubtitle: project.description || '',
  backUrl: '/m/projects',
  activeTab: 'projects'
}) %>

<!-- Tabs -->
<div class="m-tab-bar" id="projectTabs">
  <a href="#overview" class="m-tab-item active" data-tab="overview">Overview</a>
  <% if (hasRequirements) { %><a href="#requirements" class="m-tab-item" data-tab="requirements">Requirements</a><% } %>
  <% if (hasPublishedDesign) { %><a href="#design" class="m-tab-item" data-tab="design">Design</a><% } %>
  <% if (hasPublishedProposal) { %><a href="#proposal" class="m-tab-item" data-tab="proposal">Proposal</a><% } %>
</div>

<div class="m-content">
  <!-- Overview Tab -->
  <div id="tab-overview" class="tab-panel">
    <!-- Rename Project -->
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
      <span id="mProjectName" style="font-size:1.1rem;font-weight:700;color:var(--text-primary);flex:1;"><%= project.name %></span>
      <button onclick="mEditName()" style="background:none;border:none;font-size:0.9rem;cursor:pointer;color:var(--text-muted);">âœï¸</button>
    </div>

    <!-- Voice CTA -->
    <a href="/m/projects/<%= encodeId(project.id) %>/voice" class="m-quick-voice">
      <div class="m-quick-voice-icon">ğŸ™ï¸</div>
      <div class="m-quick-voice-text">
        <h3>Start Voice Session</h3>
        <p>Discuss requirements with AI</p>
      </div>
    </a>

    <!-- Progress -->
    <div class="m-card">
      <div class="m-card-title">Progress</div>
      <%
      const milestones = [
        { key: 'session', label: 'Session', icon: 'ğŸ™ï¸', done: sessions.length > 0 },
        { key: 'requirements', label: 'Requirements', icon: 'ğŸ“‹', done: hasRequirements },
        { key: 'design', label: 'Design', icon: 'ğŸ“', done: hasPublishedDesign },
        { key: 'proposal', label: 'Proposal', icon: 'ğŸ’°', done: hasPublishedProposal },
        { key: 'approved', label: 'Approved', icon: 'âœ…', done: proposalApproved }
      ];
      %>
      <div style="display:flex;gap:4px;margin-top:12px;">
        <% milestones.forEach(function(m) { %>
          <div style="flex:1;text-align:center;">
            <div style="width:36px;height:36px;border-radius:50%;margin:0 auto 4px;display:flex;align-items:center;justify-content:center;font-size:16px;background:<%= m.done ? '#d1fae5' : '#f1f5f9' %>;border:2px solid <%= m.done ? '#10b981' : '#e2e8f0' %>"><%= m.icon %></div>
            <div style="font-size:11px;font-weight:600;color:<%= m.done ? '#059669' : '#94a3b8' %>"><%= m.label %></div>
          </div>
        <% }); %>
      </div>
    </div>

    <!-- Sessions -->
    <% if (sessions.length > 0) { %>
      <div class="m-card">
        <div class="m-card-title">Sessions (<%= sessions.length %>)</div>
        <% sessions.slice(0, 5).forEach(function(s) { %>
          <div style="padding:10px 0;border-bottom:1px solid var(--border);font-size:14px;">
            Session #<%= s.id %> â€” <span style="color:var(--text-secondary)"><%= new Date(s.created_at).toLocaleDateString() %></span>
            <span class="m-badge <%= s.status === 'active' ? 'm-badge-session' : 'm-badge-approved' %>" style="float:right"><%= s.status %></span>
          </div>
        <% }); %>
      </div>
    <% } %>

    <!-- Files -->
    <% if (files && files.length > 0) { %>
      <div class="m-card">
        <div class="m-card-title">Files (<%= files.length %>)</div>
        <% files.forEach(function(f) { %>
          <div style="padding:8px 0;border-bottom:1px solid var(--border);font-size:14px;">
            ğŸ“ <%= f.original_name || f.filename %>
          </div>
        <% }); %>
      </div>
    <% } %>

    <!-- Customer questions -->
    <% if (customerQuestions && customerQuestions.length > 0) { %>
      <div class="m-card" style="border-left:3px solid var(--indigo);">
        <div class="m-card-title">â“ Questions for You</div>
        <% customerQuestions.forEach(function(q) { %>
          <div style="padding:10px 0;border-bottom:1px solid var(--border);font-size:14px;">
            <%= typeof q === 'object' ? q.text : q %>
          </div>
        <% }); %>
        <a href="/m/projects/<%= encodeId(project.id) %>/design" class="m-btn m-btn-primary m-btn-full mt-16" style="font-size:14px;">Answer Questions</a>
      </div>
    <% } %>
  </div>

  <!-- Requirements Tab -->
  <div id="tab-requirements" class="tab-panel" style="display:none;">
    <p style="color:var(--text-secondary);font-size:14px;margin-bottom:12px;">Requirements gathered from voice sessions.</p>
    <a href="/customer/projects/<%= encodeId(project.id) %>/requirements" class="m-btn m-btn-outline m-btn-full mb-12">View Full Requirements</a>
  </div>

  <!-- Design Tab -->
  <% if (hasPublishedDesign) { %>
  <div id="tab-design" class="tab-panel" style="display:none;">
    <div class="m-card">
      <div class="m-card-title">ğŸ“ Solution Design</div>
      <p style="color:var(--text-secondary);font-size:14px;margin:8px 0;">
        <% if (designApproved) { %>
          âœ… You've approved this design.
        <% } else { %>
          Review and approve the proposed solution design.
        <% } %>
      </p>
      <a href="/m/projects/<%= encodeId(project.id) %>/design" class="m-btn m-btn-primary m-btn-full mt-8">
        <%= designApproved ? 'View Design' : 'Review & Approve' %>
      </a>
    </div>
  </div>
  <% } %>

  <!-- Proposal Tab -->
  <% if (hasPublishedProposal) { %>
  <div id="tab-proposal" class="tab-panel" style="display:none;">
    <div class="m-card">
      <div class="m-card-title">ğŸ’° Proposal</div>
      <p style="color:var(--text-secondary);font-size:14px;margin:8px 0;">
        <% if (proposalApproved) { %>
          âœ… Proposal approved â€” project is underway!
        <% } else { %>
          Review the proposal and pricing for your project.
        <% } %>
      </p>
      <a href="/m/projects/<%= encodeId(project.id) %>/proposal" class="m-btn m-btn-primary m-btn-full mt-8">
        <%= proposalApproved ? 'View Proposal' : 'Review & Approve' %>
      </a>
    </div>
  </div>
  <% } %>
</div>

<script>
document.querySelectorAll('#projectTabs .m-tab-item').forEach(tab => {
  tab.addEventListener('click', function(e) {
    e.preventDefault();
    document.querySelectorAll('#projectTabs .m-tab-item').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
    this.classList.add('active');
    document.getElementById('tab-' + this.dataset.tab).style.display = 'block';
  });
});

function mEditName() {
  const el = document.getElementById('mProjectName');
  const current = el.textContent.trim();
  const input = document.createElement('input');
  input.type = 'text'; input.value = current;
  input.style.cssText = 'font-size:1.1rem;font-weight:700;background:rgba(255,255,255,0.06);border:1px solid var(--accent,#1199fa);border-radius:8px;padding:6px 10px;color:var(--text-primary,#f0f4f8);font-family:Inter,sans-serif;width:100%;outline:none;';
  el.replaceWith(input); input.focus(); input.select();
  const save = async () => {
    const n = input.value.trim();
    if (!n || n === current) { const s = document.createElement('span'); s.id='mProjectName'; s.style.cssText='font-size:1.1rem;font-weight:700;color:var(--text-primary);flex:1;'; s.textContent=current; input.replaceWith(s); return; }
    try {
      const r = await fetch('/api/projects/<%= project.id %>/rename', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name:n}) });
      if (!r.ok) throw new Error();
      const s = document.createElement('span'); s.id='mProjectName'; s.style.cssText='font-size:1.1rem;font-weight:700;color:var(--text-primary);flex:1;'; s.textContent=n; input.replaceWith(s);
    } catch { alert('Failed to rename'); const s = document.createElement('span'); s.id='mProjectName'; s.style.cssText='font-size:1.1rem;font-weight:700;color:var(--text-primary);flex:1;'; s.textContent=current; input.replaceWith(s); }
  };
  input.addEventListener('blur', save);
  input.addEventListener('keydown', (e) => { if(e.key==='Enter'){e.preventDefault();input.blur();} if(e.key==='Escape'){input.value=current;input.blur();} });
}
</script>

<%- include('layout-bottom', { activeTab: 'projects' }) %>
