<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Morti Projects</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#f0f2f5; line-height:1.6; color:#0f172a; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:16px 0; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .header-container { max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; padding:0 20px; }
    .logo { font-size:20px; font-weight:bold; display:flex; align-items:center; gap:8px; text-decoration:none; color:white; }
    .nav { display:flex; gap:12px; align-items:center; }
    .nav a { color:rgba(255,255,255,0.9); text-decoration:none; padding:8px 14px; border-radius:6px; transition:background 0.2s; font-weight:500; font-size:14px; }
    .nav a:hover { background:rgba(255,255,255,0.2); }
    .main { max-width:1100px; margin:0 auto; padding:24px 20px; }
    .breadcrumb { font-size:13px; color:#64748b; margin-bottom:16px; }
    .breadcrumb a { color:#667eea; text-decoration:none; }
    .card { background:white; border-radius:12px; padding:24px; margin-bottom:20px; box-shadow:0 1px 3px rgba(0,0,0,0.06); }
    .badge { display:inline-block; padding:4px 10px; border-radius:12px; font-size:11px; font-weight:600; text-transform:uppercase; }
    .badge-final { background:#d1fae5; color:#065f46; }
    .meta-row { display:flex; gap:24px; font-size:13px; color:#64748b; margin-bottom:4px; }
    .design-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:12px; }
    .design-item { padding:16px; border-radius:8px; background:#f8fafc; border:1px solid #e2e8f0; }
    .design-item h4 { font-size:13px; text-transform:uppercase; letter-spacing:0.5px; color:#667eea; margin-bottom:6px; }
    .design-item .section-body { font-size:13px; color:#475569; line-height:1.7; }
    .full-width { grid-column: 1 / -1; }
    .btn { display:inline-flex; align-items:center; gap:6px; padding:8px 16px; border:none; border-radius:8px; font-weight:600; font-size:13px; cursor:pointer; transition:all 0.15s; text-decoration:none; }
    .btn-primary { background:#667eea; color:white; }
    .btn-sm { padding:6px 12px; font-size:12px; }
    .question-card { padding:12px 16px; border-radius:8px; background:#f8fafc; border:1px solid #e2e8f0; margin-bottom:10px; }
    .question-card .q-id { display:inline-block; background:#667eea; color:white; width:24px; height:24px; border-radius:50%; text-align:center; line-height:24px; font-size:12px; font-weight:700; margin-right:8px; }
    .question-card .q-text { font-weight:600; color:#0f172a; font-size:14px; }
    .question-card .q-assumption { font-size:12px; color:#64748b; margin-top:4px; font-style:italic; }
    .question-card .q-answer { margin-top:8px; padding:8px 12px; background:#d1fae5; border-radius:6px; color:#065f46; font-size:13px; }
    .answer-form { display:flex; gap:8px; margin-top:8px; }
    .answer-form input[type="text"] { flex:1; padding:8px 12px; border:1px solid #dbeafe; border-radius:6px; font-size:13px; }
    @media (max-width:768px) { .design-grid { grid-template-columns:1fr; } }
    .cw-rollup-step { background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:10px 14px; flex:1 1 calc(50% - 10px); min-width:260px; }
    .cw-rollup-step .step-num { display:inline-block; background:#4f46e5; color:#fff; border-radius:50%; width:22px; height:22px; text-align:center; line-height:22px; font-size:12px; font-weight:600; margin-right:8px; }
    .cw-rollup-step .step-title { font-weight:600; color:#1e293b; font-size:14px; }
    .cw-rollup-step .step-desc { color:#64748b; font-size:13px; margin-top:4px; }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-container">
      <a href="/dashboard" class="logo">üéôÔ∏è Morti Projects</a>
      <nav class="nav">
        <a href="/dashboard">Dashboard</a>
        <a href="/projects">My Projects</a>
        <a href="/profile">Profile</a>
        <a href="/logout">üö™ Logout</a>
      </nav>
    </div>
  </div>

  <main class="main">
    <div class="breadcrumb">
      <a href="/dashboard">Dashboard</a> ‚Ä∫ <a href="/projects">Projects</a> ‚Ä∫ <a href="/projects/<%= projectId %>"><%= project.name %></a> ‚Ä∫ Design
    </div>

    <%
      let designSections = design.sections || null;
      let designSummary = design.summary || '';
    %>

    <div class="card">
      <% if (design.approvedAt) { %>
      <div style="padding:12px 16px;background:#d1fae5;border:1px solid #6ee7b7;border-radius:8px;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
        <span style="font-size:20px;">‚úÖ</span>
        <div>
          <strong style="color:#065f46;">Design Approved</strong>
          <span style="font-size:13px;color:#047857;"> ‚Äî by <%= design.approvedBy %> on <%= melb(design.approvedAt) %></span>
        </div>
      </div>
      <% } %>

      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <div>
          <h2>üìê <%= project.name %> ‚Äî Solution Design</h2>
          <div class="meta-row" style="margin-top:8px;">
            <span>üìÖ Published <%= design.publishedAt ? melb(design.publishedAt) : '' %></span>
            <% if (design.version) { %><span>v<%= design.version %></span><% } %>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="badge badge-final">Published</span>
          <% if (!design.approvedAt) { %>
          <form method="POST" action="/customer/projects/<%= projectId %>/design/approve" onsubmit="return confirm('Approve this design? This confirms you are happy with the proposed solution.');" style="margin:0;">
            <button type="submit" class="btn btn-primary" style="background:#10b981;">‚úÖ Approve Design</button>
          </form>
          <% } %>
        </div>
      </div>

      <% if (designSummary) { %>
        <div style="padding:12px 16px;background:#eef2ff;border-radius:8px;font-size:14px;color:#3730a3;margin-bottom:16px;">
          <strong>Summary:</strong> <%= designSummary %>
        </div>
      <% } %>

      <% if (designSections) { %>
        <div class="design-grid">
          <% const sectionOrder = ['ExecutiveSummary','CoreWorkflow','SimplifiedArchitecture','MinimalDataModel','ManualVsAutomated','Assumptions','Dependencies','Phase2Enhancements','RisksAndMitigations','BuildEffortEstimate','CostBenefitAnalysis','TechnicalReadiness','TechnicalReference']; %>
          <% const sectionLabels = { ExecutiveSummary:'Executive Summary', CoreWorkflow:'Core Workflow', SimplifiedArchitecture:'Simplified Architecture', MinimalDataModel:'Minimal Data Model', ManualVsAutomated:'Manual vs Automated', Assumptions:'Assumptions', Dependencies:'Dependencies', Phase2Enhancements:'Phase 2 Enhancements (Out of Scope)', RisksAndMitigations:'Risks & Mitigations', BuildEffortEstimate:'Build Effort Estimate', CostBenefitAnalysis:'Cost / Benefit Analysis', TechnicalReadiness:'Technical Readiness', TechnicalReference:'Technical Reference' }; %>
          <% const fullWidthSections = ['ExecutiveSummary','CoreWorkflow','SimplifiedArchitecture','MinimalDataModel','ManualVsAutomated','Phase2Enhancements','TechnicalReference']; %>
          <%
            const allKeys = Object.keys(designSections);
            const orderedKeys = sectionOrder.filter(k => designSections[k]);
            const extraKeys = allKeys.filter(k => !sectionOrder.includes(k));
            const renderKeys = orderedKeys.concat(extraKeys);
          %>
          <% renderKeys.forEach(key => { %>
            <% if (key === 'CoreWorkflow' && designSections.CoreWorkflow) { %>
              <div class="design-item full-width" id="coreWorkflowRollup">
                <h4>üìã Workflow Overview <span style="font-size:12px;color:#94a3b8;font-weight:400;">(scroll down for full detail)</span></h4>
                <div id="cwRollupContent" style="display:flex;flex-wrap:wrap;gap:10px;padding:8px 0;"></div>
              </div>
            <% } %>
            <% if (designSections[key]) { %>
              <div class="design-item <%= fullWidthSections.includes(key) ? 'full-width' : '' %>">
                <h4><%= sectionLabels[key] || key.replace(/([A-Z])/g, ' $1').trim() %></h4>
                <div class="section-body"><%- (function(txt) {
                  let s = txt.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                  s = s.replace(/\[ASSUMPTION\]/g,'<span style="background:#fef3c7;padding:1px 6px;border-radius:3px;font-size:12px;font-weight:600;color:#92400e;">ASSUMPTION</span>');
                  s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                  const lines = s.split('\n');
                  let html = '';
                  let inOl = false;
                  let inSub = false;
                  for (let i = 0; i < lines.length; i++) {
                    const raw = lines[i];
                    const line = raw.trim();
                    if (!line) {
                      if (inSub) { html += '</ul>'; inSub = false; }
                      if (!inOl) html += '<div style="height:8px"></div>';
                      continue;
                    }
                    const numbered = line.match(/^(\d+)\.\s+(.+)/);
                    const subItem = line.match(/^\(?([a-h])\)\s+(.+)/);
                    const bullet = line.match(/^[-‚Ä¢]\s+(.+)/);
                    const indented = raw.match(/^   +(.+)/);
                    if (numbered) {
                      if (inSub) { html += '</ul>'; inSub = false; }
                      if (!inOl) { html += '<ol style="margin:8px 0 8px 0;padding:0;list-style:none;">'; inOl = true; }
                      html += '<li style="margin-bottom:12px;padding:10px 14px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;list-style:none;"><span style="display:inline-block;background:#4f46e5;color:#fff;border-radius:50%;width:24px;height:24px;text-align:center;line-height:24px;font-size:12px;font-weight:700;margin-right:10px;">' + numbered[1] + '</span>' + numbered[2] + '</li>';
                    } else if (subItem) {
                      if (!inSub) { html += '<ul style="margin:6px 0 4px 36px;padding:0;list-style:none;">'; inSub = true; }
                      html += '<li style="margin-bottom:4px;font-size:13px;color:#475569;"><span style="color:#6366f1;font-weight:600;margin-right:4px;">(' + subItem[1] + ')</span>' + subItem[2] + '</li>';
                    } else if (bullet) {
                      if (!inSub) { html += '<ul style="margin:4px 0 4px 36px;padding:0;">'; inSub = true; }
                      html += '<li style="margin-bottom:3px;font-size:13px;color:#475569;">' + bullet[1] + '</li>';
                    } else if (indented && inOl) {
                      html += '<div style="margin:2px 0 2px 36px;font-size:13px;color:#475569;">' + line + '</div>';
                    } else {
                      if (inSub) { html += '</ul>'; inSub = false; }
                      if (inOl) { html += '</ol>'; inOl = false; }
                      html += '<p style="margin:0 0 4px 0;">' + line + '</p>';
                    }
                  }
                  if (inSub) html += '</ul>';
                  if (inOl) html += '</ol>';
                  return html;
                })(designSections[key]) %></div>
              </div>
            <% } %>
          <% }) %>
        </div>
      <% } else { %>
        <div><%- design.designHtml || '<p>No design content available.</p>' %></div>
      <% } %>
    </div>

    <!-- Flowchart -->
    <% if (design.flowchart) { %>
    <div class="card">
      <h3 style="margin-bottom:12px;">üó∫Ô∏è System Architecture</h3>
      <div id="flowchartRender" style="min-height:100px;display:flex;align-items:center;justify-content:center;"></div>
    </div>
    <% } %>

    <!-- Customer Questions -->
    <div class="card">
      <h3 style="margin-bottom:12px;">‚ùì Questions for You</h3>
      <%
        const customerQuestions = (design.questions || []).filter(q => {
          return (typeof q === 'object' && q.assignedTo === 'customer');
        });
      %>
      <% if (customerQuestions.length === 0) { %>
        <div style="text-align:center;padding:24px;color:#94a3b8;font-size:14px;">No questions assigned to you at this time.</div>
      <% } else { %>
        <% customerQuestions.forEach(function(q, i) { %>
          <%
            const qText = q.text || String(q);
            const qId = q.id || (i+1);
            const qAssumption = q.assumption || '';
            const custAnswered = (design.customerAnswers || []).find(a => a.question === qText);
          %>
          <div class="question-card">
            <div>
              <span class="q-id"><%= qId %></span>
              <span class="q-text"><%= qText %></span>
            </div>
            <% if (qAssumption) { %>
              <div class="q-assumption">üí° <%= qAssumption %></div>
            <% } %>
            <% if (custAnswered) { %>
              <div class="q-answer">‚úÖ <strong>Your answer:</strong> <%= custAnswered.answer %> <span style="font-size:11px;color:#6b7280">‚Äî <%= melb(custAnswered.ts) %></span></div>
            <% } else { %>
              <form method="POST" action="/customer/projects/<%= projectId %>/design/answer" class="answer-form">
                <input type="hidden" name="designId" value="<%= design.id %>" />
                <input type="hidden" name="question" value="<%= qText %>" />
                <input type="text" name="answer" placeholder="Type your answer‚Ä¶" required />
                <button type="submit" class="btn btn-primary btn-sm">Submit</button>
              </form>
            <% } %>
          </div>
        <% }) %>
      <% } %>
    </div>
  </main>
  <% if (design.flowchart || design.coreWorkflowFlowchart) { %>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: false, theme: 'default' });
    <% if (designSections.CoreWorkflow) { %>
    (function() {
      const cwText = `<%- (designSections.CoreWorkflow || '').replace(/`/g, '\\`').replace(/\\/g, '\\\\') %>`;
      const container = document.getElementById('cwRollupContent');
      if (!container || !cwText) return;
      const steps = [];
      const lines = cwText.split('\n');
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        const numbered = line.match(/^(\d+)\.\s+\*\*(.+?)\*\*(.*)$/);
        if (numbered) {
          const title = numbered[2].trim();
          let desc = numbered[3].replace(/^\s*[-:‚Äî‚Äì]\s*/, '').trim();
          if (!desc) {
            for (let j = i + 1; j < Math.min(i + 5, lines.length); j++) {
              const next = lines[j].trim();
              if (next && next.match(/^\(?[a-z]\)/)) { desc = next.replace(/^\(?[a-z]\)\s*/, '').substring(0, 140); break; }
              else if (next && !next.startsWith('(')) { desc = next.replace(/^[-‚Ä¢]\s*/, '').substring(0, 140); break; }
            }
          }
          steps.push({ num: numbered[1], title, desc: desc.substring(0, 140) });
        }
      }
      if (steps.length === 0) { document.getElementById('coreWorkflowRollup').style.display = 'none'; return; }
      container.innerHTML = steps.map(s =>
        '<div class="cw-rollup-step"><span class="step-num">' + s.num + '</span><span class="step-title">' + s.title + '</span>' +
        (s.desc ? '<div class="step-desc">' + s.desc + '</div>' : '') + '</div>'
      ).join('');
    })();
    <% } %>
    <% if (design.flowchart) { %>
    (async () => {
      try {
        const { svg } = await mermaid.render('flowchart-svg', `<%- design.flowchart.replace(/`/g, '\\`').replace(/\\/g, '\\\\') %>`);
        document.getElementById('flowchartRender').innerHTML = svg;
      } catch(e) { if (document.getElementById('flowchartRender')) document.getElementById('flowchartRender').textContent = 'Flowchart rendering failed'; }
    })();
    <% } %>
  </script>
  <% } %>
</body>
</html>
