<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Morti Projects</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#f0f2f5; line-height:1.6; color:#0f172a; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:16px 0; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .header-container { max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; padding:0 20px; }
    .logo { font-size:20px; font-weight:bold; display:flex; align-items:center; gap:8px; text-decoration:none; color:white; }
    .nav { display:flex; gap:12px; align-items:center; }
    .nav a { color:rgba(255,255,255,0.9); text-decoration:none; padding:8px 14px; border-radius:6px; transition:background 0.2s; font-weight:500; font-size:14px; }
    .nav a:hover { background:rgba(255,255,255,0.2); }
    .main { max-width:900px; margin:0 auto; padding:32px 20px; }
    .breadcrumb { font-size:13px; color:#64748b; margin-bottom:20px; }
    .breadcrumb a { color:#667eea; text-decoration:none; }
    .badge { display:inline-block; padding:4px 10px; border-radius:12px; font-size:11px; font-weight:600; text-transform:uppercase; }
    .badge-final { background:#d1fae5; color:#065f46; }
    .btn { display:inline-flex; align-items:center; gap:6px; padding:8px 16px; border:none; border-radius:8px; font-weight:600; font-size:13px; cursor:pointer; transition:all 0.15s; text-decoration:none; }
    .btn-primary { background:#667eea; color:white; }
    .btn-sm { padding:6px 12px; font-size:12px; }

    /* Section cards */
    .section-card { background:#fff; border-radius:12px; padding:24px 28px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.06); }
    .section-card h3 { font-size:16px; font-weight:700; color:#1e293b; margin-bottom:14px; display:flex; align-items:center; gap:10px; }
    .section-card h3 .icon { font-size:20px; }
    .section-body { font-size:14px; color:#334155; line-height:1.8; }
    .section-body p { margin-bottom:8px; }
    .section-body strong { color:#0f172a; }

    /* Step Flow */
    .step-flow { display:flex; flex-direction:column; gap:0; position:relative; padding-left:44px; }
    .step-flow::before { content:''; position:absolute; left:18px; top:24px; bottom:24px; width:2px; background:linear-gradient(to bottom, #667eea, #a78bfa); }
    .step-item { position:relative; padding:14px 0; }
    .step-num { position:absolute; left:-44px; top:14px; width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg, #667eea, #4f46e5); color:#fff; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:700; box-shadow:0 2px 8px rgba(79,70,229,0.3); z-index:1; }
    .step-title { font-weight:700; color:#1e293b; font-size:15px; margin-bottom:4px; }
    .step-desc { color:#64748b; font-size:14px; line-height:1.6; }

    /* Questions */
    .question-card { padding:14px 18px; border-radius:10px; background:#f8fafc; border:1px solid #e2e8f0; margin-bottom:12px; }
    .question-card .q-id { display:inline-block; background:#667eea; color:white; width:26px; height:26px; border-radius:50%; text-align:center; line-height:26px; font-size:12px; font-weight:700; margin-right:10px; }
    .question-card .q-text { font-weight:600; color:#0f172a; font-size:14px; }
    .question-card .q-assumption { font-size:12px; color:#64748b; margin-top:4px; font-style:italic; }
    .question-card .q-answer { margin-top:8px; padding:8px 12px; background:#d1fae5; border-radius:6px; color:#065f46; font-size:13px; }
    .answer-form { display:flex; gap:8px; margin-top:10px; }
    .answer-form input[type="text"] { flex:1; padding:10px 14px; border:1px solid #dbeafe; border-radius:8px; font-size:14px; }

    /* Old format grid */
    .design-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:12px; }
    .design-item { padding:16px; border-radius:8px; background:#f8fafc; border:1px solid #e2e8f0; }
    .design-item h4 { font-size:13px; text-transform:uppercase; letter-spacing:0.5px; color:#667eea; margin-bottom:6px; }
    .full-width { grid-column: 1 / -1; }
    @media (max-width:768px) { .design-grid { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-container">
      <a href="/dashboard" class="logo">üéôÔ∏è Morti Projects</a>
      <nav class="nav">
        <a href="/dashboard">Dashboard</a>
        <a href="/projects">My Projects</a>
        <a href="/profile">Profile</a>
        <a href="/logout">üö™ Logout</a>
      </nav>
    </div>
  </div>

  <main class="main">
    <div class="breadcrumb">
      <a href="/dashboard">Dashboard</a> ‚Ä∫ <a href="/projects">Projects</a> ‚Ä∫ <a href="/projects/<%= encodeId(projectId) %>"><%= project.name %></a> ‚Ä∫ Design
    </div>

    <%
      const hasNewFormat = !!(design.customerDesign || design.engineDesign);
      const customerDesign = design.customerDesign || null;
      // Fallback for old format
      let designSections = design.sections || null;
      let designSummary = design.summary || '';
    %>

    <!-- Approval Banner -->
    <% if (design.approvedAt) { %>
    <div style="padding:14px 18px;background:#d1fae5;border:1px solid #6ee7b7;border-radius:12px;margin-bottom:16px;display:flex;align-items:center;gap:10px;">
      <span style="font-size:22px;">‚úÖ</span>
      <div>
        <strong style="color:#065f46;">Design Approved</strong>
        <span style="font-size:13px;color:#047857;"> ‚Äî by <%= design.approvedBy %> on <%= melb(design.approvedAt) %></span>
      </div>
    </div>
    <% } %>

    <!-- Header -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;">
      <div>
        <h1 style="font-size:22px;color:#1e293b;margin-bottom:4px;">üìê <%= project.name %> ‚Äî Solution Design</h1>
        <div style="font-size:13px;color:#64748b;">
          Published <%= design.publishedAt ? melb(design.publishedAt) : '' %>
          <% if (design.version) { %> ¬∑ v<%= design.version %><% } %>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span class="badge badge-final">Published</span>
        <% if (!design.approvedAt) { %>
        <form method="POST" action="/customer/projects/<%= encodeId(projectId) %>/design/approve" onsubmit="return confirm('Approve this design? This confirms you are happy with the proposed solution.');" style="margin:0;">
          <button type="submit" class="btn btn-primary" style="background:#10b981;">‚úÖ Approve Design</button>
        </form>
        <% } %>
      </div>
    </div>

    <% if (hasNewFormat && customerDesign) { %>
      <!-- NEW FORMAT: Customer-facing sections only -->
      <%
        const custSections = [
          { key: 'ExecutiveSummary', label: 'Executive Summary', icon: 'üìã' },
          { key: 'HowItWorks', label: 'How It Works', icon: '‚ö°' },
          { key: 'WhatYouGet', label: 'What You Get', icon: 'üéØ' },
          { key: 'WhatWeNeedFromYou', label: 'What We Need From You', icon: 'ü§ù' },
          { key: 'TimelineAndInvestment', label: 'Timeline & Investment', icon: 'üìÖ' },
          { key: 'AutomatedVsManual', label: 'Automated vs Manual', icon: 'ü§ñ' }
        ];
        const custKeys = Object.keys(customerDesign);
        const extraCustKeys = custKeys.filter(k => !custSections.find(s => s.key === k));
      %>
      <% custSections.forEach(sec => { %>
        <% if (customerDesign[sec.key]) { %>
          <div class="section-card">
            <h3><span class="icon"><%= sec.icon %></span> <%= sec.label %></h3>
            <% if (sec.key === 'HowItWorks') { %>
              <div class="step-flow" id="howItWorksFlow"></div>
              <noscript><div class="section-body"><%- renderText(customerDesign[sec.key]) %></div></noscript>
            <% } else { %>
              <div class="section-body"><%- renderText(customerDesign[sec.key]) %></div>
            <% } %>
          </div>
        <% } %>
      <% }) %>
      <% extraCustKeys.forEach(key => { %>
        <% if (customerDesign[key]) { %>
          <div class="section-card">
            <h3><%= key.replace(/([A-Z])/g, ' $1').trim() %></h3>
            <div class="section-body"><%- renderText(customerDesign[key]) %></div>
          </div>
        <% } %>
      <% }) %>

    <% } else if (designSections) { %>
      <!-- OLD FORMAT: All sections -->
      <% if (designSummary) { %>
        <div style="padding:14px 18px;background:#eef2ff;border-radius:10px;font-size:14px;color:#3730a3;margin-bottom:16px;">
          <strong>Summary:</strong> <%= designSummary %>
        </div>
      <% } %>
      <div class="design-grid">
        <%
          const sectionOrder = ['ExecutiveSummary','CoreWorkflow','SimplifiedArchitecture','MinimalDataModel','ManualVsAutomated','Assumptions','Dependencies','Phase2Enhancements','RisksAndMitigations','BuildEffortEstimate','CostBenefitAnalysis','TechnicalReadiness','TechnicalReference'];
          const sectionLabels = { ExecutiveSummary:'Executive Summary', CoreWorkflow:'Core Workflow', SimplifiedArchitecture:'Simplified Architecture', MinimalDataModel:'Minimal Data Model', ManualVsAutomated:'Manual vs Automated', Assumptions:'Assumptions', Dependencies:'Dependencies', Phase2Enhancements:'Phase 2 Enhancements', RisksAndMitigations:'Risks & Mitigations', BuildEffortEstimate:'Build Effort Estimate', CostBenefitAnalysis:'Cost / Benefit Analysis', TechnicalReadiness:'Technical Readiness', TechnicalReference:'Technical Reference' };
          const fullWidthSections = ['ExecutiveSummary','CoreWorkflow','SimplifiedArchitecture','MinimalDataModel','ManualVsAutomated','Phase2Enhancements','TechnicalReference'];
          const allKeys = Object.keys(designSections);
          const orderedKeys = sectionOrder.filter(k => designSections[k]);
          const extraKeys = allKeys.filter(k => !sectionOrder.includes(k));
          const renderKeys = orderedKeys.concat(extraKeys);
        %>
        <% renderKeys.forEach(key => { %>
          <% if (designSections[key]) { %>
            <div class="design-item <%= fullWidthSections.includes(key) ? 'full-width' : '' %>">
              <h4><%= sectionLabels[key] || key.replace(/([A-Z])/g, ' $1').trim() %></h4>
              <div class="section-body"><%- renderText(designSections[key]) %></div>
            </div>
          <% } %>
        <% }) %>
      </div>
    <% } else { %>
      <div style="text-align:center;padding:40px;color:#94a3b8;"><%- design.designHtml || '<p>No design content available.</p>' %></div>
    <% } %>

    <!-- Flowchart -->
    <% if (design.flowchart) { %>
    <div class="section-card">
      <h3><span class="icon">üó∫Ô∏è</span> System Architecture</h3>
      <div id="flowchartRender" style="min-height:100px;display:flex;align-items:center;justify-content:center;"></div>
    </div>
    <% } %>

    <!-- Customer Questions -->
    <div class="section-card">
      <h3><span class="icon">‚ùì</span> Questions for You</h3>
      <%
        const customerQuestions = (design.questions || []).filter(q => {
          return (typeof q === 'object' && q.assignedTo === 'customer');
        });
      %>
      <% if (customerQuestions.length === 0) { %>
        <div style="text-align:center;padding:24px;color:#94a3b8;font-size:14px;">No questions assigned to you at this time.</div>
      <% } else { %>
        <% customerQuestions.forEach(function(q, i) { %>
          <%
            const qText = q.text || String(q);
            const qId = q.id || (i+1);
            const qAssumption = q.assumption || '';
            const custAnswered = (design.customerAnswers || []).find(a => a.question === qText);
          %>
          <div class="question-card">
            <div>
              <span class="q-id"><%= qId %></span>
              <span class="q-text"><%= qText %></span>
            </div>
            <% if (qAssumption) { %>
              <div class="q-assumption">üí° <%= qAssumption %></div>
            <% } %>
            <% if (custAnswered) { %>
              <div class="q-answer">‚úÖ <strong>Your answer:</strong> <%= custAnswered.answer %> <span style="font-size:11px;color:#6b7280">‚Äî <%= melb(custAnswered.ts) %></span></div>
            <% } else { %>
              <form method="POST" action="/customer/projects/<%= encodeId(projectId) %>/design/answer" class="answer-form">
                <input type="hidden" name="designId" value="<%= design.id %>" />
                <input type="hidden" name="question" value="<%= qText %>" />
                <input type="text" name="answer" placeholder="Type your answer‚Ä¶" required />
                <button type="submit" class="btn btn-primary btn-sm">Submit</button>
              </form>
            <% } %>
          </div>
        <% }) %>
      <% } %>
    </div>
  </main>

  <% if (design.flowchart || (hasNewFormat && customerDesign && customerDesign.HowItWorks)) { %>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: false, theme: 'default' });

    // HowItWorks step flow
    <% if (hasNewFormat && customerDesign && customerDesign.HowItWorks) { %>
    (function() {
      const text = `<%- (customerDesign.HowItWorks || '').replace(/`/g, '\\`').replace(/\\/g, '\\\\') %>`;
      const container = document.getElementById('howItWorksFlow');
      if (!container || !text) return;
      const lines = text.split('\n');
      const steps = [];
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        const m = line.match(/^(\d+)\.\s+\*\*(.+?)\*\*\s*[-‚Äî:]*\s*(.*)/);
        if (m) {
          let desc = m[3].trim();
          if (!desc) {
            for (let j = i+1; j < Math.min(i+4, lines.length); j++) {
              const next = lines[j].trim();
              if (next && !next.match(/^\d+\./)) { desc = next.replace(/^[-‚Ä¢]\s*/, ''); break; }
            }
          }
          steps.push({ num: m[1], title: m[2], desc: desc.substring(0, 200) });
        }
      }
      if (steps.length === 0) {
        container.style.paddingLeft = '0';
        container.className = 'section-body';
        container.innerHTML = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        return;
      }
      container.innerHTML = steps.map(s =>
        '<div class="step-item">' +
          '<div class="step-num">' + s.num + '</div>' +
          '<div class="step-title">' + s.title + '</div>' +
          (s.desc ? '<div class="step-desc">' + s.desc + '</div>' : '') +
        '</div>'
      ).join('');
    })();
    <% } %>

    <% if (design.flowchart) { %>
    (async () => {
      try {
        const { svg } = await mermaid.render('flowchart-svg', `<%- design.flowchart.replace(/`/g, '\\`').replace(/\\/g, '\\\\') %>`);
        document.getElementById('flowchartRender').innerHTML = svg;
      } catch(e) { if (document.getElementById('flowchartRender')) document.getElementById('flowchartRender').textContent = 'Flowchart rendering failed'; }
    })();
    <% } %>
  </script>
  <% } %>
</body>
</html>