<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Morti Projects</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #0a1628; --bg-primary: #0f1d32; --bg-card: #142640;
      --bg-glass: rgba(15, 29, 50, 0.6); --border-glass: rgba(255, 255, 255, 0.08);
      --border-glass-hover: rgba(255, 255, 255, 0.15);
      --accent: #1199fa; --accent-glow: rgba(17, 153, 250, 0.4); --accent-dim: rgba(17, 153, 250, 0.12);
      --accent-secondary: #009e7e; --accent-purple: #8b5cf6;
      --text-primary: #f0f4f8; --text-secondary: rgba(240, 244, 248, 0.7); --text-muted: rgba(240, 244, 248, 0.4);
      --radius: 16px; --radius-pill: 50px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-deep); color: var(--text-primary); line-height:1.6; -webkit-font-smoothing: antialiased; }
    a { text-decoration: none; color: inherit; }

    .header { background: rgba(5, 13, 26, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-glass); padding: 16px 0; }
    .header-container { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }
    .logo { font-size: 1.3rem; font-weight: 800; color: #fff; letter-spacing: -0.02em; }
    .nav { display:flex; gap:8px; align-items:center; }
    .nav a { color: var(--text-muted); font-size: 0.88rem; padding: 8px 14px; border-radius: var(--radius-pill); transition: all 0.2s; font-weight: 500; }
    .nav a:hover { color: #fff; background: rgba(255,255,255,0.06); }

    .main { max-width:900px; margin:0 auto; padding:32px 24px; }
    .breadcrumb { font-size:0.82rem; color:var(--text-muted); margin-bottom:20px; }
    .breadcrumb a { color:var(--accent); }
    .badge { display:inline-block; padding:4px 12px; border-radius:var(--radius-pill); font-size:0.72rem; font-weight:600; text-transform:uppercase; }
    .badge-final { background:rgba(0,158,126,0.12); color:var(--accent-secondary); border: 1px solid rgba(0,158,126,0.3); }
    .btn { display:inline-flex; align-items:center; gap:6px; padding:10px 24px; border:none; border-radius:var(--radius-pill); font-weight:600; font-size:0.88rem; cursor:pointer; transition:all 0.3s; color:#fff; font-family:'Inter',sans-serif; }
    .btn-primary { background:var(--accent); box-shadow: 0 0 16px var(--accent-glow); }
    .btn-sm { padding:6px 14px; font-size:0.78rem; }

    .section-card { background: var(--bg-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-glass); border-radius: var(--radius); padding:24px 28px; margin-bottom:16px; transition: border-color 0.3s; }
    .section-card:hover { border-color: var(--border-glass-hover); }
    .section-card h3 { font-size:1rem; font-weight:700; color:var(--text-primary); margin-bottom:14px; display:flex; align-items:center; gap:10px; }
    .section-card h3 .icon { font-size:20px; }
    .section-body { font-size:0.88rem; color:var(--text-secondary); line-height:1.8; }
    .section-body p { margin-bottom:8px; }
    .section-body strong { color:var(--text-primary); }

    .step-flow { display:flex; flex-direction:column; gap:0; position:relative; padding-left:44px; }
    .step-flow::before { content:''; position:absolute; left:18px; top:24px; bottom:24px; width:2px; background:linear-gradient(to bottom, var(--accent), var(--accent-purple)); }
    .step-item { position:relative; padding:14px 0; }
    .step-num { position:absolute; left:-44px; top:14px; width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg, var(--accent), var(--accent-purple)); color:#fff; display:flex; align-items:center; justify-content:center; font-size:0.88rem; font-weight:700; box-shadow:0 0 16px var(--accent-glow); z-index:1; }
    .step-title { font-weight:700; color:var(--text-primary); font-size:0.95rem; margin-bottom:4px; }
    .step-desc { color:var(--text-muted); font-size:0.88rem; line-height:1.6; }

    .question-card { padding:14px 18px; border-radius:12px; background:var(--bg-card); border:1px solid var(--border-glass); margin-bottom:12px; }
    .question-card .q-id { display:inline-block; background:var(--accent); color:white; width:26px; height:26px; border-radius:50%; text-align:center; line-height:26px; font-size:0.78rem; font-weight:700; margin-right:10px; }
    .question-card .q-text { font-weight:600; color:var(--text-primary); font-size:0.88rem; }
    .question-card .q-assumption { font-size:0.78rem; color:var(--text-muted); margin-top:4px; font-style:italic; }
    .question-card .q-answer { margin-top:8px; padding:8px 12px; background:rgba(0,158,126,0.1); border-radius:8px; color:var(--accent-secondary); font-size:0.82rem; }
    .answer-form { display:flex; gap:8px; margin-top:10px; }
    .answer-form input[type="text"] { flex:1; padding:10px 14px; border:1px solid var(--border-glass); border-radius:10px; font-size:0.88rem; background:rgba(5,13,26,0.6); color:var(--text-primary); font-family:'Inter',sans-serif; }
    .answer-form input[type="text"]:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }

    .design-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:12px; }
    .design-item { padding:16px; border-radius:12px; background:var(--bg-card); border:1px solid var(--border-glass); }
    .design-item h4 { font-size:0.72rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--accent); margin-bottom:6px; font-weight:600; }
    .full-width { grid-column: 1 / -1; }
    @media (max-width:768px) {
      .design-grid { grid-template-columns:1fr; }
      .header-container { flex-direction: column; gap: 12px; }
      .nav { flex-wrap: wrap; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-container">
      <a href="/dashboard" class="logo">‚óÜ Morti</a>
      <nav class="nav" style="display:flex;gap:8px;align-items:center;">
        <a href="/dashboard">Dashboard</a>
        <a href="/profile">Profile</a>
        <a href="#" onclick="if(document.getElementById('featureModal'))document.getElementById('featureModal').style.display='flex';return false;" style="color:#8b5cf6;">üí° Feedback</a>
                <span style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);padding:8px 14px;border-radius:50px;font-weight:500;font-size:0.88rem;color:rgba(240,244,248,0.7);">üë§ <%= user.name %></span>
                <a href="/logout">Logout</a>
      </nav>
    </div>
  </div>

  <main class="main">
    <div class="breadcrumb">
      <a href="/dashboard">Dashboard</a> ‚Ä∫ <a href="/projects">Projects</a> ‚Ä∫ <a href="/projects/<%= encodeId(projectId) %>"><%= project.name %></a> ‚Ä∫ Design
    </div>

    <%
      const hasNewFormat = !!(design.customerDesign || design.engineDesign);
      const customerDesign = design.customerDesign || null;
      let designSections = design.sections || null;
      let designSummary = design.summary || '';
    %>

    <!-- Approval Banner -->
    <% if (design.approvedAt) { %>
    <div style="padding:14px 18px;background:rgba(0,158,126,0.1);border:1px solid rgba(0,158,126,0.3);border-radius:var(--radius);margin-bottom:16px;display:flex;align-items:center;gap:10px;">
      <span style="font-size:22px;">‚úÖ</span>
      <div>
        <strong style="color:var(--accent-secondary);">Design Approved</strong>
        <span style="font-size:0.82rem;color:var(--text-secondary);"> ‚Äî by <%= design.approvedBy %> on <%= melb(design.approvedAt) %></span>
      </div>
    </div>
    <% } %>

    <!-- Header -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;">
      <div>
        <h1 style="font-size:1.4rem;font-weight:800;letter-spacing:-0.03em;margin-bottom:4px;">üìê <%= project.name %> ‚Äî Solution Design</h1>
        <div style="font-size:0.82rem;color:var(--text-muted);">
          Published <%= design.publishedAt ? melb(design.publishedAt) : '' %>
          <% if (design.version) { %> ¬∑ v<%= design.version %><% } %>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span class="badge badge-final">Published</span>
        <% if (!design.approvedAt) { %>
        <form method="POST" action="/customer/projects/<%= encodeId(projectId) %>/design/approve" onsubmit="return confirm('Approve this design? This confirms you are happy with the proposed solution.');" style="margin:0;">
          <button type="submit" class="btn" style="background:var(--accent-secondary);box-shadow:0 0 16px rgba(0,158,126,0.3);">‚úÖ Approve Design</button>
        </form>
        <% } %>
      </div>
    </div>

    <% if (hasNewFormat && customerDesign) { %>
      <%
        const custSections = [
          { key: 'ExecutiveSummary', label: 'Executive Summary', icon: 'üìã' },
          { key: 'HowItWorks', label: 'How It Works', icon: '‚ö°' },
          { key: 'WhatYouGet', label: 'What You Get', icon: 'üéØ' },
          { key: 'WhatWeNeedFromYou', label: 'What We Need From You', icon: 'ü§ù' },
          { key: 'TimelineAndInvestment', label: 'Timeline & Investment', icon: 'üìÖ' },
          { key: 'AutomatedVsManual', label: 'Automated vs Manual', icon: 'ü§ñ' }
        ];
        const custKeys = Object.keys(customerDesign);
        const extraCustKeys = custKeys.filter(k => !custSections.find(s => s.key === k));
      %>
      <% custSections.forEach(sec => { %>
        <% if (customerDesign[sec.key]) { %>
          <div class="section-card">
            <h3><span class="icon"><%= sec.icon %></span> <%= sec.label %></h3>
            <% if (sec.key === 'HowItWorks') { %>
              <div class="step-flow" id="howItWorksFlow"></div>
              <noscript><div class="section-body"><%- renderText(customerDesign[sec.key]) %></div></noscript>
            <% } else { %>
              <div class="section-body"><%- renderText(customerDesign[sec.key]) %></div>
            <% } %>
          </div>
        <% } %>
      <% }) %>
      <% extraCustKeys.forEach(key => { %>
        <% if (customerDesign[key]) { %>
          <div class="section-card">
            <h3><%= key.replace(/([A-Z])/g, ' $1').trim() %></h3>
            <div class="section-body"><%- renderText(customerDesign[key]) %></div>
          </div>
        <% } %>
      <% }) %>

    <% } else if (designSections) { %>
      <% if (designSummary) { %>
        <div style="padding:14px 18px;background:var(--accent-dim);border:1px solid rgba(17,153,250,0.2);border-radius:12px;font-size:0.88rem;color:var(--accent);margin-bottom:16px;">
          <strong>Summary:</strong> <%= designSummary %>
        </div>
      <% } %>
      <div class="design-grid">
        <%
          const sectionOrder = ['ExecutiveSummary','CoreWorkflow','SimplifiedArchitecture','MinimalDataModel','ManualVsAutomated','Assumptions','Dependencies','Phase2Enhancements','RisksAndMitigations','BuildEffortEstimate','CostBenefitAnalysis','TechnicalReadiness','TechnicalReference'];
          const sectionLabels = { ExecutiveSummary:'Executive Summary', CoreWorkflow:'Core Workflow', SimplifiedArchitecture:'Simplified Architecture', MinimalDataModel:'Minimal Data Model', ManualVsAutomated:'Manual vs Automated', Assumptions:'Assumptions', Dependencies:'Dependencies', Phase2Enhancements:'Phase 2 Enhancements', RisksAndMitigations:'Risks & Mitigations', BuildEffortEstimate:'Build Effort Estimate', CostBenefitAnalysis:'Cost / Benefit Analysis', TechnicalReadiness:'Technical Readiness', TechnicalReference:'Technical Reference' };
          const fullWidthSections = ['ExecutiveSummary','CoreWorkflow','SimplifiedArchitecture','MinimalDataModel','ManualVsAutomated','Phase2Enhancements','TechnicalReference'];
          const allKeys = Object.keys(designSections);
          const orderedKeys = sectionOrder.filter(k => designSections[k]);
          const extraKeys = allKeys.filter(k => !sectionOrder.includes(k));
          const renderKeys = orderedKeys.concat(extraKeys);
        %>
        <% renderKeys.forEach(key => { %>
          <% if (designSections[key]) { %>
            <div class="design-item <%= fullWidthSections.includes(key) ? 'full-width' : '' %>">
              <h4><%= sectionLabels[key] || key.replace(/([A-Z])/g, ' $1').trim() %></h4>
              <div class="section-body"><%- renderText(designSections[key]) %></div>
            </div>
          <% } %>
        <% }) %>
      </div>
    <% } else { %>
      <div style="text-align:center;padding:40px;color:var(--text-muted);"><%- design.designHtml || '<p>No design content available.</p>' %></div>
    <% } %>

    <!-- Flowchart -->
    <% if (design.flowchart) { %>
    <div class="section-card">
      <h3><span class="icon">üó∫Ô∏è</span> System Architecture</h3>
      <div id="flowchartRender" style="min-height:100px;display:flex;align-items:center;justify-content:center;"></div>
    </div>
    <% } %>

    <!-- Customer Questions -->
    <div class="section-card">
      <h3><span class="icon">‚ùì</span> Questions for You</h3>
      <%
        const customerQuestions = (design.questions || []).filter(q => {
          return (typeof q === 'object' && q.assignedTo === 'customer');
        });
      %>
      <% if (customerQuestions.length === 0) { %>
        <div style="text-align:center;padding:24px;color:var(--text-muted);font-size:0.88rem;">No questions assigned to you at this time.</div>
      <% } else { %>
        <% customerQuestions.forEach(function(q, i) { %>
          <%
            const qText = q.text || String(q);
            const qId = q.id || (i+1);
            const qAssumption = q.assumption || '';
            const custAnswered = (design.customerAnswers || []).find(a => a.question === qText);
          %>
          <div class="question-card">
            <div>
              <span class="q-id"><%= qId %></span>
              <span class="q-text"><%= qText %></span>
            </div>
            <% if (qAssumption) { %>
              <div class="q-assumption">üí° <%= qAssumption %></div>
            <% } %>
            <% if (custAnswered) { %>
              <div class="q-answer">‚úÖ <strong>Your answer:</strong> <%= custAnswered.answer %> <span style="font-size:0.72rem;color:var(--text-muted)">‚Äî <%= melb(custAnswered.ts) %></span></div>
            <% } else { %>
              <form method="POST" action="/customer/projects/<%= encodeId(projectId) %>/design/answer" class="answer-form">
                <input type="hidden" name="designId" value="<%= design.id %>" />
                <input type="hidden" name="question" value="<%= qText %>" />
                <input type="text" name="answer" placeholder="Type your answer‚Ä¶" required />
                <button type="submit" class="btn btn-primary btn-sm">Submit</button>
              </form>
            <% } %>
          </div>
        <% }) %>
      <% } %>
    </div>
  </main>

  <% if (design.flowchart || (hasNewFormat && customerDesign && customerDesign.HowItWorks)) { %>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: false, theme: 'dark' });

    <% if (hasNewFormat && customerDesign && customerDesign.HowItWorks) { %>
    (function() {
      const text = `<%- (customerDesign.HowItWorks || '').replace(/`/g, '\\`').replace(/\\/g, '\\\\') %>`;
      const container = document.getElementById('howItWorksFlow');
      if (!container || !text) return;
      const lines = text.split('\n');
      const steps = [];
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        const m = line.match(/^(\d+)\.\s+\*\*(.+?)\*\*\s*[-‚Äî:]*\s*(.*)/);
        if (m) {
          let desc = m[3].trim();
          if (!desc) {
            for (let j = i+1; j < Math.min(i+4, lines.length); j++) {
              const next = lines[j].trim();
              if (next && !next.match(/^\d+\./)) { desc = next.replace(/^[-‚Ä¢]\s*/, ''); break; }
            }
          }
          steps.push({ num: m[1], title: m[2], desc: desc.substring(0, 200) });
        }
      }
      if (steps.length === 0) {
        container.style.paddingLeft = '0';
        container.className = 'section-body';
        container.innerHTML = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        return;
      }
      container.innerHTML = steps.map(s =>
        '<div class="step-item">' +
          '<div class="step-num">' + s.num + '</div>' +
          '<div class="step-title">' + s.title + '</div>' +
          (s.desc ? '<div class="step-desc">' + s.desc + '</div>' : '') +
        '</div>'
      ).join('');
    })();
    <% } %>

    <% if (design.flowchart) { %>
    (async () => {
      try {
        const { svg } = await mermaid.render('flowchart-svg', `<%- design.flowchart.replace(/`/g, '\\`').replace(/\\/g, '\\\\') %>`);
        document.getElementById('flowchartRender').innerHTML = svg;
      } catch(e) { if (document.getElementById('flowchartRender')) document.getElementById('flowchartRender').textContent = 'Flowchart rendering failed'; }
    })();
    <% } %>
  </script>
  <% } %>
</body>
</html>