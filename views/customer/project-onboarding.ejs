<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --brand: #4f46e5; --brand-light: #6366f1; --text: #1e293b; --text-mid: #475569; --text-light: #64748b; --bg: #f8fafc; --card-bg: #ffffff; --border: #e2e8f0; --success: #10b981; --warning: #f59e0b; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); }
        .header { background: white; border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
        .header h1 { font-size: 18px; font-weight: 600; }
        .header a { color: var(--brand); text-decoration: none; font-size: 14px; }
        .container { max-width: 800px; margin: 24px auto; padding: 0 24px; }
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 20px; }
        .card h2 { font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text); }
        .card p { font-size: 14px; color: var(--text-mid); line-height: 1.6; margin-bottom: 12px; }
        .field-group { margin-bottom: 16px; }
        .field-group label { display: block; font-size: 13px; font-weight: 500; color: var(--text); margin-bottom: 4px; }
        .field-group .hint { font-size: 12px; color: var(--text-light); margin-bottom: 4px; }
        .field-group input, .field-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; font-family: inherit; }
        .field-group input:focus, .field-group textarea:focus { outline: none; border-color: var(--brand); box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }
        .field-group input.filled { border-color: var(--success); background: #f0fdf4; }
        .badge { display: inline-block; padding: 3px 10px; border-radius: 99px; font-size: 12px; font-weight: 500; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #78350f; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .svc-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
        .svc-header h3 { font-size: 14px; font-weight: 600; }
        .svc-header .critical { color: #dc2626; font-size: 11px; font-weight: 500; }
        .btn { display: inline-block; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; text-decoration: none; }
        .btn-primary { background: var(--brand); color: white; }
        .btn-primary:hover { background: var(--brand-light); }
        .btn-secondary { background: white; color: var(--text); border: 1px solid var(--border); }
        .actions { display: flex; gap: 12px; align-items: center; margin-top: 20px; }
        .status-msg { font-size: 13px; color: var(--text-light); }
        .progress-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin-bottom: 8px; }
        .progress-fill { height: 100%; background: var(--success); border-radius: 4px; transition: width 0.3s; }
        .error-box { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; padding: 16px; border-radius: 8px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Setup ‚Äî <%= project.name %></h1>
        <a href="/customer/projects/<%= project.id %>">‚Üê Back to Project</a>
    </div>

    <div class="container">
        <% if (error) { %>
            <div class="error-box"><%= error %></div>
        <% } else { %>

        <div class="card">
            <p>To build your automation, we need a few credentials and configuration details. Your data is stored securely and only used for your project.</p>
            <div style="display:flex; gap:12px; align-items:center;">
                <span>Status:</span>
                <span class="badge <%= state.status === 'complete' ? 'badge-success' : state.status === 'in_progress' ? 'badge-warning' : 'badge-info' %>" id="statusBadge"><%= state.status === 'complete' ? '‚úÖ Complete' : state.status === 'in_progress' ? '‚è≥ In Progress' : 'üìã Not Started' %></span>
            </div>
            <div class="progress-bar" style="margin-top:12px;"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
            <div id="progressText" style="font-size:12px; color:var(--text-light);"></div>
        </div>

        <form id="onboardingForm">
            <% if (spec.credentials && spec.credentials.length > 0) { %>
            <div class="card">
                <h2>üîë Credentials</h2>
                <p>API keys and access credentials for the services your automation connects to.</p>
                <% spec.credentials.forEach(svc => { %>
                    <div class="svc-header">
                        <h3><%= svc.service || 'Service' %></h3>
                        <% if (svc.critical) { %><span class="critical">Required</span><% } %>
                        <% if (svc.setupGuide) { %><a href="<%= svc.setupGuide %>" target="_blank" style="font-size:12px; color:var(--brand); margin-left:auto;">Setup Guide ‚Üó</a><% } %>
                    </div>
                    <% (svc.keys || []).forEach(key => { %>
                        <div class="field-group">
                            <label><%= key %></label>
                            <input type="password" name="cred__<%= key %>" placeholder="Enter <%= key %>"
                                   class="<%= state.credentialsFilled.includes(key) ? 'filled' : '' %>"
                                   value="<%= state.credentialsFilled.includes(key) ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '' %>"
                                   onfocus="if(this.value==='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢')this.value=''" />
                        </div>
                    <% }); %>
                <% }); %>
            </div>
            <% } %>

            <% if (spec.configuration && spec.configuration.length > 0) { %>
            <div class="card">
                <h2>‚öôÔ∏è Configuration</h2>
                <p>Settings and preferences for how your automation should work.</p>
                <% spec.configuration.forEach(q => { %>
                    <div class="field-group">
                        <label><%= q.label || q.field %> <% if (q.required) { %><span style="color:#dc2626;">*</span><% } %></label>
                        <% if (q.hint) { %><div class="hint"><%= q.hint %></div><% } %>
                        <input type="text" name="config__<%= q.field %>" placeholder="<%= q.placeholder || '' %>"
                               class="<%= state.configurationFilled.includes(q.field) ? 'filled' : '' %>"
                               value="" />
                    </div>
                <% }); %>
            </div>
            <% } %>

            <div class="card">
                <h2>üìù Notes</h2>
                <p>Any additional context, preferences, or instructions for our team.</p>
                <textarea name="notes" rows="4" placeholder="Anything else we should know..."><%= state.notes || '' %></textarea>
            </div>

            <div class="actions">
                <button type="button" class="btn btn-secondary" onclick="saveDraft()">üíæ Save Draft</button>
                <button type="button" class="btn btn-primary" onclick="submitOnboarding()">‚úÖ Submit</button>
                <span class="status-msg" id="statusMsg"></span>
            </div>
        </form>

        <% } %>
    </div>

    <script>
    const PROJECT_ID = '<%= project.id %>';

    function gatherData() {
        const credentials = {};
        const configuration = {};
        document.querySelectorAll('input[name^="cred__"]').forEach(inp => {
            const key = inp.name.replace('cred__', '');
            if (inp.value.trim() && inp.value !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') credentials[key] = inp.value.trim();
        });
        document.querySelectorAll('input[name^="config__"]').forEach(inp => {
            const key = inp.name.replace('config__', '');
            if (inp.value.trim()) configuration[key] = inp.value.trim();
        });
        const notes = document.querySelector('[name="notes"]')?.value || '';
        return { credentials, configuration, notes };
    }

    function updateProgress() {
        let total = 0, filled = 0;
        document.querySelectorAll('input[name^="cred__"], input[name^="config__"]').forEach(inp => {
            total++;
            if (inp.value.trim() && inp.value !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') filled++;
            else if (inp.classList.contains('filled')) filled++;
        });
        const pct = total > 0 ? Math.round((filled / total) * 100) : 0;
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressText').textContent = `${filled} of ${total} fields completed (${pct}%)`;
    }

    async function saveDraft() {
        const msg = document.getElementById('statusMsg');
        msg.textContent = 'Saving...';
        try {
            const res = await fetch(`/customer/projects/${PROJECT_ID}/onboarding`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(gatherData())
            });
            const data = await res.json();
            msg.textContent = data.ok ? '‚úÖ Saved' : '‚ùå ' + (data.error || 'Error');
            if (data.status) document.getElementById('statusBadge').textContent = data.status === 'complete' ? '‚úÖ Complete' : '‚è≥ In Progress';
        } catch (e) { msg.textContent = '‚ùå ' + e.message; }
        setTimeout(() => { msg.textContent = ''; }, 3000);
    }

    async function submitOnboarding() {
        const msg = document.getElementById('statusMsg');
        msg.textContent = 'Submitting...';
        try {
            const res = await fetch(`/customer/projects/${PROJECT_ID}/onboarding`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(gatherData())
            });
            const data = await res.json();
            if (data.ok && data.status === 'complete') {
                document.getElementById('statusBadge').textContent = '‚úÖ Complete';
                document.getElementById('statusBadge').className = 'badge badge-success';
                msg.textContent = '‚úÖ Onboarding complete! Our team will begin building your automation.';
            } else if (data.missing && data.missing.length) {
                msg.textContent = '‚ö†Ô∏è Missing: ' + data.missing.join(', ');
            } else {
                msg.textContent = '‚úÖ Saved ‚Äî some required fields still missing.';
            }
        } catch (e) { msg.textContent = '‚ùå ' + e.message; }
    }

    // Init progress
    document.querySelectorAll('input').forEach(inp => inp.addEventListener('input', updateProgress));
    updateProgress();
    </script>
</body>
</html>
