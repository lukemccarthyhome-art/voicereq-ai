<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0a1628; --bg-primary: #0f1d32; --bg-card: #142640;
            --bg-glass: rgba(15, 29, 50, 0.6); --border-glass: rgba(255, 255, 255, 0.08);
            --border-glass-hover: rgba(255, 255, 255, 0.15);
            --accent: #1199fa; --accent-glow: rgba(17, 153, 250, 0.4); --accent-dim: rgba(17, 153, 250, 0.12);
            --accent-secondary: #009e7e; --accent-purple: #8b5cf6;
            --text-primary: #f0f4f8; --text-secondary: rgba(240, 244, 248, 0.7); --text-muted: rgba(240, 244, 248, 0.4);
            --radius: 16px; --radius-pill: 50px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-deep); color: var(--text-primary); -webkit-font-smoothing: antialiased; }
        a { text-decoration: none; color: inherit; }

        .header { background: rgba(5, 13, 26, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-glass); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
        .header h1 { font-size: 1.1rem; font-weight: 700; }
        .header a { color: var(--accent); font-size: 0.88rem; }

        .container { max-width: 800px; margin: 24px auto; padding: 0 24px; }

        .card { background: var(--bg-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-glass); border-radius: var(--radius); padding: 24px; margin-bottom: 20px; transition: border-color 0.3s; }
        .card:hover { border-color: var(--border-glass-hover); }
        .card h2 { font-size: 1rem; font-weight: 700; margin-bottom: 16px; color: var(--text-primary); }
        .card p { font-size: 0.88rem; color: var(--text-secondary); line-height: 1.6; margin-bottom: 12px; }

        .field-group { margin-bottom: 16px; }
        .field-group label { display: block; font-size: 0.82rem; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .field-group .hint { font-size: 0.78rem; color: var(--text-muted); margin-bottom: 4px; }
        .field-group input, .field-group textarea { width: 100%; padding: 10px 14px; border: 1px solid var(--border-glass); border-radius: 10px; font-size: 0.88rem; font-family: 'Inter', sans-serif; background: rgba(5,13,26,0.6); color: var(--text-primary); transition: all 0.2s; }
        .field-group input:focus, .field-group textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }
        .field-group input::placeholder, .field-group textarea::placeholder { color: var(--text-muted); }
        .field-group input.filled { border-color: var(--accent-secondary); background: rgba(0,158,126,0.06); }

        .badge { display: inline-block; padding: 4px 12px; border-radius: var(--radius-pill); font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: rgba(0,158,126,0.12); color: var(--accent-secondary); border: 1px solid rgba(0,158,126,0.3); }
        .badge-warning { background: rgba(245,158,11,0.12); color: #f59e0b; border: 1px solid rgba(245,158,11,0.3); }
        .badge-info { background: var(--accent-dim); color: var(--accent); border: 1px solid rgba(17,153,250,0.3); }

        .svc-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-glass); }
        .svc-header h3 { font-size: 0.88rem; font-weight: 700; color: var(--text-primary); }
        .svc-header .critical { color: #ef4444; font-size: 0.72rem; font-weight: 600; }

        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 10px 24px; border-radius: var(--radius-pill); font-size: 0.88rem; font-weight: 600; cursor: pointer; border: none; color: #fff; transition: all 0.3s; font-family: 'Inter', sans-serif; }
        .btn-primary { background: var(--accent); box-shadow: 0 0 16px var(--accent-glow); }
        .btn-primary:hover { background: #2aa8ff; transform: translateY(-1px); }
        .btn-secondary { background: rgba(255,255,255,0.06); border: 1px solid var(--border-glass); color: var(--text-secondary); }
        .btn-secondary:hover { background: rgba(255,255,255,0.12); }

        .actions { display: flex; gap: 12px; align-items: center; margin-top: 20px; }
        .status-msg { font-size: 0.82rem; color: var(--text-muted); }
        .progress-bar { height: 8px; background: rgba(255,255,255,0.06); border-radius: 4px; overflow: hidden; margin-bottom: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-secondary)); border-radius: 4px; transition: width 0.3s; box-shadow: 0 0 12px var(--accent-glow); }
        .error-box { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #ef4444; padding: 16px; border-radius: var(--radius); margin-bottom: 20px; font-size: 0.88rem; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Setup ‚Äî <%= project.name %></h1>
        <a href="/customer/projects/<%= encodeId(project.id) %>">‚Üê Back to Project</a>
    </div>

    <div class="container">
        <% if (error) { %>
            <div class="error-box"><%= error %></div>
        <% } else { %>

        <div class="card">
            <p>To build your automation, we need a few credentials and configuration details. Your data is stored securely and only used for your project.</p>
            <div style="display:flex; gap:12px; align-items:center;">
                <span style="font-size:0.88rem;">Status:</span>
                <span class="badge <%= state.status === 'complete' ? 'badge-success' : state.status === 'in_progress' ? 'badge-warning' : 'badge-info' %>" id="statusBadge"><%= state.status === 'complete' ? '‚úÖ Complete' : state.status === 'in_progress' ? '‚è≥ In Progress' : 'üìã Not Started' %></span>
            </div>
            <div class="progress-bar" style="margin-top:12px;"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
            <div id="progressText" style="font-size:0.78rem; color:var(--text-muted);"></div>
        </div>

        <form id="onboardingForm">
            <% if (spec.credentials && spec.credentials.length > 0) { %>
            <div class="card">
                <h2>üîë Credentials</h2>
                <p>API keys and access credentials for the services your automation connects to.</p>
                <% spec.credentials.forEach(svc => { %>
                    <div class="svc-header">
                        <h3><%= svc.service || 'Service' %></h3>
                        <% if (svc.critical) { %><span class="critical">Required</span><% } %>
                        <% if (svc.setupGuide) { %><a href="<%= svc.setupGuide %>" target="_blank" style="font-size:0.78rem; color:var(--accent); margin-left:auto;">Setup Guide ‚Üó</a><% } %>
                    </div>
                    <% (svc.keys || []).forEach(key => { %>
                        <div class="field-group">
                            <label><%= key %></label>
                            <input type="password" name="cred__<%= key %>" placeholder="Enter <%= key %>"
                                   class="<%= state.credentialsFilled.includes(key) ? 'filled' : '' %>"
                                   value="<%= state.credentialsFilled.includes(key) ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '' %>"
                                   onfocus="if(this.value==='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢')this.value=''" />
                        </div>
                    <% }); %>
                <% }); %>
            </div>
            <% } %>

            <% if (spec.configuration && spec.configuration.length > 0) { %>
            <div class="card">
                <h2>‚öôÔ∏è Configuration</h2>
                <p>Settings and preferences for how your automation should work.</p>
                <% spec.configuration.forEach(q => { %>
                    <div class="field-group">
                        <label><%= q.label || q.field %> <% if (q.required) { %><span style="color:#ef4444;">*</span><% } %></label>
                        <% if (q.hint) { %><div class="hint"><%= q.hint %></div><% } %>
                        <input type="text" name="config__<%= q.field %>" placeholder="<%= q.placeholder || '' %>"
                               class="<%= state.configurationFilled.includes(q.field) ? 'filled' : '' %>"
                               value="" />
                    </div>
                <% }); %>
            </div>
            <% } %>

            <div class="card">
                <h2>üìù Notes</h2>
                <p>Any additional context, preferences, or instructions for our team.</p>
                <textarea name="notes" rows="4" placeholder="Anything else we should know..." style="width:100%;padding:10px 14px;border:1px solid var(--border-glass);border-radius:10px;font-size:0.88rem;font-family:'Inter',sans-serif;background:rgba(5,13,26,0.6);color:var(--text-primary);"><%= state.notes || '' %></textarea>
            </div>

            <div class="actions">
                <button type="button" class="btn btn-secondary" onclick="saveDraft()">üíæ Save Draft</button>
                <button type="button" class="btn btn-primary" onclick="submitOnboarding()">‚úÖ Submit</button>
                <span class="status-msg" id="statusMsg"></span>
            </div>
        </form>

        <% } %>
    </div>

    <script>
    const PROJECT_ID = '<%= encodeId(project.id) %>';

    function gatherData() {
        const credentials = {};
        const configuration = {};
        document.querySelectorAll('input[name^="cred__"]').forEach(inp => {
            const key = inp.name.replace('cred__', '');
            if (inp.value.trim() && inp.value !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') credentials[key] = inp.value.trim();
        });
        document.querySelectorAll('input[name^="config__"]').forEach(inp => {
            const key = inp.name.replace('config__', '');
            if (inp.value.trim()) configuration[key] = inp.value.trim();
        });
        const notes = document.querySelector('[name="notes"]')?.value || '';
        return { credentials, configuration, notes };
    }

    function updateProgress() {
        let total = 0, filled = 0;
        document.querySelectorAll('input[name^="cred__"], input[name^="config__"]').forEach(inp => {
            total++;
            if (inp.value.trim() && inp.value !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') filled++;
            else if (inp.classList.contains('filled')) filled++;
        });
        const pct = total > 0 ? Math.round((filled / total) * 100) : 0;
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressText').textContent = `${filled} of ${total} fields completed (${pct}%)`;
    }

    async function saveDraft() {
        const msg = document.getElementById('statusMsg');
        msg.textContent = 'Saving...';
        try {
            const res = await fetch(`/customer/projects/${PROJECT_ID}/onboarding`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(gatherData())
            });
            const data = await res.json();
            msg.textContent = data.ok ? '‚úÖ Saved' : '‚ùå ' + (data.error || 'Error');
            if (data.status) document.getElementById('statusBadge').textContent = data.status === 'complete' ? '‚úÖ Complete' : '‚è≥ In Progress';
        } catch (e) { msg.textContent = '‚ùå ' + e.message; }
        setTimeout(() => { msg.textContent = ''; }, 3000);
    }

    async function submitOnboarding() {
        const msg = document.getElementById('statusMsg');
        msg.textContent = 'Submitting...';
        try {
            const res = await fetch(`/customer/projects/${PROJECT_ID}/onboarding`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(gatherData())
            });
            const data = await res.json();
            if (data.ok && data.status === 'complete') {
                document.getElementById('statusBadge').textContent = '‚úÖ Complete';
                document.getElementById('statusBadge').className = 'badge badge-success';
                msg.textContent = '‚úÖ Onboarding complete! Our team will begin building your automation.';
            } else if (data.missing && data.missing.length) {
                msg.textContent = '‚ö†Ô∏è Missing: ' + data.missing.join(', ');
            } else {
                msg.textContent = '‚úÖ Saved ‚Äî some required fields still missing.';
            }
        } catch (e) { msg.textContent = '‚ùå ' + e.message; }
    }

    document.querySelectorAll('input').forEach(inp => inp.addEventListener('input', updateProgress));
    updateProgress();
    </script>
</body>
</html>