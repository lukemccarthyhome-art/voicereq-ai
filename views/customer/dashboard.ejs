<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Morti Projects</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0a1628;
            --bg-primary: #0f1d32;
            --bg-card: #142640;
            --bg-glass: rgba(15, 29, 50, 0.6);
            --border-glass: rgba(255, 255, 255, 0.08);
            --border-glass-hover: rgba(255, 255, 255, 0.15);
            --accent: #1199fa;
            --accent-glow: rgba(17, 153, 250, 0.4);
            --accent-dim: rgba(17, 153, 250, 0.12);
            --accent-secondary: #009e7e;
            --accent-purple: #8b5cf6;
            --text-primary: #f0f4f8;
            --text-secondary: rgba(240, 244, 248, 0.7);
            --text-muted: rgba(240, 244, 248, 0.4);
            --radius: 16px;
            --radius-pill: 50px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-deep); color: var(--text-primary); line-height: 1.6; -webkit-font-smoothing: antialiased; }
        a { text-decoration: none; color: inherit; }

        /* Nav */
        .header {
            background: rgba(5, 13, 26, 0.8);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-glass);
            padding: 16px 0;
        }
        .header-container { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }
        .logo { font-size: 1.3rem; font-weight: 800; color: #fff; letter-spacing: -0.02em; }
        .nav { display: flex; gap: 8px; align-items: center; }
        .nav a { color: var(--text-muted); font-size: 0.88rem; padding: 8px 14px; border-radius: var(--radius-pill); transition: all 0.2s; font-weight: 500; }
        .nav a:hover { color: #fff; background: rgba(255,255,255,0.06); }
        .nav a.active { color: var(--accent); background: var(--accent-dim); }
        .nav a.feature-link { color: var(--accent-purple); }
        .nav a.feature-link:hover { background: rgba(139,92,246,0.12); color: #a78bfa; }
        .user-name { background: rgba(255,255,255,0.06); border: 1px solid var(--border-glass); padding: 8px 14px; border-radius: var(--radius-pill); font-weight: 500; font-size: 0.88rem; color: var(--text-secondary); }

        .main { max-width: 1200px; margin: 0 auto; padding: 24px; min-height: calc(100vh - 200px); }

        .card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        .card:hover { border-color: var(--border-glass-hover); }

        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 10px 24px; border-radius: var(--radius-pill); font-size: 0.88rem;
            font-weight: 600; cursor: pointer; transition: all 0.3s; border: none;
            color: #fff; letter-spacing: -0.01em;
        }
        .btn-primary { background: var(--accent); box-shadow: 0 0 20px var(--accent-glow); }
        .btn-primary:hover { background: #2aa8ff; transform: translateY(-2px); box-shadow: 0 0 32px var(--accent-glow); }
        .btn-sm { padding: 6px 14px; font-size: 0.78rem; }
        .btn-success { background: var(--accent-secondary); color: #fff; box-shadow: 0 0 16px rgba(0, 158, 126, 0.3); }
        .btn-success:hover { transform: translateY(-1px); box-shadow: 0 0 24px rgba(0, 158, 126, 0.4); }
        .btn-secondary { background: rgba(255,255,255,0.06); border: 1px solid var(--border-glass); color: var(--text-secondary); }
        .btn-secondary:hover { background: rgba(255,255,255,0.12); border-color: var(--border-glass-hover); }
        .btn-lg { padding: 18px 44px; font-size: 1.1rem; }

        /* ========== WIZARD (first-time user) ========== */
        .wizard-container {
            display: flex; align-items: center; justify-content: center;
            min-height: calc(100vh - 120px); position: relative;
        }
        .wizard-orb {
            position: absolute; border-radius: 50%; pointer-events: none;
            filter: blur(100px);
        }
        .wizard-orb-1 { width: 500px; height: 500px; background: rgba(17, 153, 250, 0.08); top: -10%; left: -5%; }
        .wizard-orb-2 { width: 400px; height: 400px; background: rgba(139, 92, 246, 0.06); bottom: -5%; right: -5%; }
        .wizard-inner {
            max-width: 600px; width: 100%; text-align: center; position: relative; z-index: 1;
        }
        .wizard-step {
            display: none; animation: wizardFadeIn 0.5s ease-out;
        }
        .wizard-step.active { display: block; }
        @keyframes wizardFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .wizard-welcome h1 {
            font-size: clamp(2rem, 5vw, 3rem); font-weight: 900;
            letter-spacing: -0.04em; line-height: 1.1; margin-bottom: 20px;
        }
        .wizard-welcome h1 .gradient-text {
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .wizard-welcome p {
            font-size: 1.15rem; color: var(--text-secondary); line-height: 1.8;
            font-weight: 300; max-width: 480px; margin: 0 auto 40px;
        }
        .wizard-steps-preview {
            display: flex; gap: 32px; justify-content: center; margin-bottom: 48px;
        }
        .wizard-preview-item {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .wizard-preview-num {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--accent-dim); border: 1px solid rgba(17, 153, 250, 0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.82rem; font-weight: 700; color: var(--accent);
        }
        .wizard-preview-label { font-size: 0.78rem; color: var(--text-muted); font-weight: 500; }
        .wizard-name h2 {
            font-size: clamp(1.5rem, 3vw, 2rem); font-weight: 800;
            letter-spacing: -0.03em; margin-bottom: 12px;
        }
        .wizard-name p {
            font-size: 1rem; color: var(--text-muted); margin-bottom: 36px; font-weight: 300;
        }
        .wizard-input-group {
            max-width: 440px; margin: 0 auto 32px;
        }
        .wizard-input {
            width: 100%; padding: 16px 20px; border: 1px solid var(--border-glass);
            border-radius: 14px; font-size: 1.1rem; font-family: 'Inter', sans-serif;
            background: rgba(5, 13, 26, 0.6); color: var(--text-primary);
            text-align: center; transition: all 0.3s; font-weight: 500;
        }
        .wizard-input::placeholder { color: var(--text-muted); font-weight: 300; }
        .wizard-input:focus {
            outline: none; border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim), 0 0 20px var(--accent-glow);
        }
        .wizard-hint {
            font-size: 0.78rem; color: var(--text-muted); margin-top: 10px; font-weight: 300;
        }
        .wizard-back {
            display: inline-block; margin-top: 16px; font-size: 0.85rem;
            color: var(--text-muted); cursor: pointer; transition: color 0.2s;
        }
        .wizard-back:hover { color: var(--text-secondary); }
        .wizard-creating h2 {
            font-size: 1.5rem; font-weight: 700; margin-bottom: 12px;
        }
        .wizard-creating p {
            color: var(--text-muted); font-size: 1rem; font-weight: 300;
        }
        .wizard-spinner {
            width: 48px; height: 48px; border: 3px solid var(--border-glass);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 32px auto 24px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ========== NORMAL DASHBOARD ========== */
        .overview-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
        .overview-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius);
            padding: 24px;
            text-align: center;
            transition: all 0.3s;
        }
        .overview-card:hover { border-color: var(--border-glass-hover); transform: translateY(-2px); }
        .overview-card .count { font-size: 2rem; font-weight: 800; margin-bottom: 4px; }
        .overview-card .label { font-size: 0.78rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; }

        .stage-section { margin-bottom: 28px; }
        .stage-header { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; padding-bottom: 10px; border-bottom: 1px solid var(--border-glass); }
        .stage-header h3 { font-size: 1rem; color: var(--text-primary); font-weight: 600; }
        .stage-badge {
            padding: 4px 12px; border-radius: var(--radius-pill); font-size: 0.75rem; font-weight: 700;
        }

        .project-row {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius);
            padding: 16px 20px; margin-bottom: 8px;
            text-decoration: none; color: inherit; transition: all 0.2s;
        }
        .project-row:hover { border-color: var(--border-glass-hover); transform: translateY(-1px); box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
        .project-name { font-weight: 600; color: var(--text-primary); font-size: 0.95rem; }
        .project-meta { font-size: 0.78rem; color: var(--text-muted); margin-top: 2px; }

        /* New project inline form */
        .new-project-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(17, 153, 250, 0.2);
            border-radius: var(--radius);
            padding: 28px;
            margin-bottom: 28px;
            animation: wizardFadeIn 0.3s ease-out;
        }
        .new-project-card h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 16px; }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary); font-size: 0.88rem; }
        .form-control { width: 100%; padding: 12px 16px; border: 1px solid var(--border-glass); border-radius: 12px; font-size: 0.88rem; background: rgba(5,13,26,0.6); color: var(--text-primary); font-family: 'Inter', sans-serif; transition: all 0.2s; }
        .form-control:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }
        .form-control::placeholder { color: var(--text-muted); }

        /* Shared projects */
        .shared-label {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 2px 10px; border-radius: var(--radius-pill);
            font-size: 0.72rem; font-weight: 600;
        }

        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state .emoji { font-size: 48px; margin-bottom: 16px; display: block; }
        .empty-state h3 { color: var(--text-secondary); margin-bottom: 8px; }

        /* Feature modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); z-index: 1000;
            align-items: center; justify-content: center; backdrop-filter: blur(8px);
        }
        .modal-card {
            background: var(--bg-card); border: 1px solid var(--border-glass);
            border-radius: var(--radius); padding: 28px; width: 90%; max-width: 500px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.4);
        }

        @media (max-width: 768px) {
            .header-container { flex-direction: column; gap: 12px; text-align: center; }
            .nav { flex-wrap: wrap; justify-content: center; }
            .main { padding: 16px; }
            .overview-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .wizard-steps-preview { gap: 20px; }
            .wizard-welcome h1 { font-size: 2rem; }
            .top-bar { flex-direction: column; gap: 12px; align-items: flex-start !important; }
            .top-bar-actions { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-container">
            <a href="/dashboard" class="logo">‚óÜ Morti</a>
            <nav class="nav">
                <a href="/dashboard" class="active">Projects</a>
                <a href="/billing">Billing</a>
                <a href="/profile">Profile</a>
                <a href="#" class="feature-link" onclick="document.getElementById('featureModal').style.display='flex';return false;">üí° Feedback</a>
                <div class="user-name">üë§ <%= user.name %></div>
                <a href="/logout">Logout</a>
            </nav>
        </div>
    </div>

<% if (projects.length === 0 && (!sharedProjects || sharedProjects.length === 0)) { %>
    <!-- ==================== WIZARD MODE ==================== -->
    <div class="wizard-container">
        <div class="wizard-orb wizard-orb-1"></div>
        <div class="wizard-orb wizard-orb-2"></div>
        <div class="wizard-inner">

            <!-- Step 1: Welcome -->
            <div class="wizard-step active" id="wizard-step-1">
                <div class="wizard-welcome">
                    <h1>Welcome, <%= user.name.split(' ')[0] %>.<br><span class="gradient-text">Let's build something.</span></h1>
                    <p>In just a few minutes, you'll go from an idea to a structured project ‚Äî just by talking. No forms, no jargon.</p>
                    <div class="wizard-steps-preview">
                        <div class="wizard-preview-item">
                            <div class="wizard-preview-num">1</div>
                            <div class="wizard-preview-label">Name it</div>
                        </div>
                        <div class="wizard-preview-item">
                            <div class="wizard-preview-num">2</div>
                            <div class="wizard-preview-label">Talk it through</div>
                        </div>
                        <div class="wizard-preview-item">
                            <div class="wizard-preview-num">3</div>
                            <div class="wizard-preview-label">Get your design</div>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-lg" onclick="showStep(2)">
                        Let's Go ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 2: Project Name -->
            <div class="wizard-step" id="wizard-step-2">
                <div class="wizard-name">
                    <h2>What's your project about?</h2>
                    <p>Give it a short name ‚Äî you can always change it later.</p>
                    <div class="wizard-input-group">
                        <input type="text" class="wizard-input" id="wizard-project-name"
                            placeholder="e.g. Client Onboarding Automation"
                            autofocus
                            onkeydown="if(event.key==='Enter')createAndStart()">
                        <div class="wizard-hint">Press Enter or click below to start your first session</div>
                    </div>
                    <button class="btn btn-primary btn-lg" id="wizard-start-btn" onclick="createAndStart()">
                        üéôÔ∏è Start Talking
                    </button>
                    <div>
                        <span class="wizard-back" onclick="showStep(1)">‚Üê Back</span>
                    </div>
                </div>
            </div>

            <!-- Step 3: Creating -->
            <div class="wizard-step" id="wizard-step-3">
                <div class="wizard-creating">
                    <div class="wizard-spinner"></div>
                    <h2>Setting up your project...</h2>
                    <p>Preparing your voice session</p>
                </div>
            </div>

        </div>
    </div>

    <script>
    function showStep(n) {
        document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
        const step = document.getElementById('wizard-step-' + n);
        step.classList.add('active');
        if (n === 2) {
            setTimeout(() => document.getElementById('wizard-project-name').focus(), 100);
        }
    }

    async function createAndStart() {
        const name = document.getElementById('wizard-project-name').value.trim();
        if (!name) {
            document.getElementById('wizard-project-name').focus();
            document.getElementById('wizard-project-name').style.borderColor = '#ef4444';
            setTimeout(() => { document.getElementById('wizard-project-name').style.borderColor = ''; }, 1500);
            return;
        }
        const btn = document.getElementById('wizard-start-btn');
        btn.disabled = true;
        btn.textContent = 'Creating...';
        showStep(3);
        try {
            const res = await fetch('/projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ name, description: '' }),
                redirect: 'follow'
            });
            const url = new URL(res.url);
            const match = url.pathname.match(/^\/projects\/([^/]+)/);
            if (match) {
                window.location.href = '/projects/' + match[1] + '/session';
                return;
            }
            window.location.href = '/dashboard';
        } catch (e) {
            console.error('Failed to create project:', e);
            showStep(2);
            btn.disabled = false;
            btn.textContent = 'üéôÔ∏è Start Talking';
        }
    }
    </script>

<% } else { %>
    <!-- ==================== NORMAL DASHBOARD ==================== -->
    <main class="main">
        <% if (typeof billingWarnings !== 'undefined' && billingWarnings.includes('past_due')) { %>
        <div style="padding:16px 20px;border-radius:16px;margin-bottom:20px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);color:#f59e0b;font-size:0.9rem;display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
            ‚ö†Ô∏è <strong>Payment issue</strong> ‚Äî Your latest payment didn't go through. <a href="/billing" style="color:#1199fa;font-weight:600;text-decoration:underline;">Update payment method ‚Üí</a>
        </div>
        <% } %>
        <% if (typeof billingWarnings !== 'undefined' && billingWarnings.includes('paused')) { %>
        <div style="padding:16px 20px;border-radius:16px;margin-bottom:20px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#ef4444;font-size:0.9rem;display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
            ‚è∏Ô∏è <strong>Automations paused</strong> ‚Äî Service is paused due to outstanding payment. <a href="/billing" style="color:#1199fa;font-weight:600;text-decoration:underline;">Restore service ‚Üí</a>
        </div>
        <% } %>
        <div class="top-bar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <div>
                <h1 style="font-weight: 800; letter-spacing: -0.03em;">Welcome back, <%= user.name.split(' ')[0] %> üëã</h1>
                <p style="color: var(--text-muted); margin-top: 4px; font-weight: 300;">Here's where your projects stand</p>
            </div>
            <div class="top-bar-actions" style="display:flex;gap:12px;align-items:center;">
                <a href="/projects/archived" style="color:var(--text-muted);font-size:0.85rem;transition:color 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color=''">üì¶ Archived</a>
                <button class="btn btn-success" onclick="toggleNewProject()">‚ûï New Project</button>
            </div>
        </div>

        <!-- Inline new project form (hidden by default) -->
        <div class="new-project-card" id="newProjectForm" style="display:none;">
            <h3>üöÄ New Project</h3>
            <form method="POST" action="/projects">
                <div class="form-group">
                    <label for="name">Project Name</label>
                    <input type="text" id="newProjectName" name="name" class="form-control" required placeholder="e.g., Client Onboarding Automation">
                </div>
                <div class="form-group">
                    <label for="description">Description <span style="color:var(--text-muted);font-weight:300;">(optional)</span></label>
                    <textarea id="description" name="description" class="form-control" rows="2" placeholder="Brief description of what you need automated..."></textarea>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button type="submit" class="btn btn-success">‚úÖ Create Project</button>
                    <button type="button" class="btn btn-secondary" onclick="toggleNewProject()">Cancel</button>
                </div>
            </form>
        </div>

        <%
        const counts = { new: 0, session: 0, design: 0, proposal: 0, approved: 0 };
        projects.forEach(p => counts[p.stage] = (counts[p.stage] || 0) + 1);
        
        const stageConfig = {
            approved: { icon: '‚úÖ', label: 'Approved', color: '#009e7e', bg: 'rgba(0,158,126,0.12)', border: 'rgba(0,158,126,0.3)' },
            proposal: { icon: 'üí∞', label: 'Proposal Ready', color: '#8b5cf6', bg: 'rgba(139,92,246,0.12)', border: 'rgba(139,92,246,0.3)' },
            design:   { icon: 'üìê', label: 'Design Ready', color: '#1199fa', bg: 'rgba(17,153,250,0.12)', border: 'rgba(17,153,250,0.3)' },
            session:  { icon: 'üéôÔ∏è', label: 'In Session', color: '#f59e0b', bg: 'rgba(245,158,11,0.12)', border: 'rgba(245,158,11,0.3)' },
            new:      { icon: 'üÜï', label: 'Getting Started', color: 'rgba(240,244,248,0.4)', bg: 'rgba(255,255,255,0.06)', border: 'rgba(255,255,255,0.08)' }
        };

        // Build smart status nudges
        const nudges = [];
        if (counts.new > 0) {
          nudges.push({ icon: 'üéôÔ∏è', color: '#f59e0b', bg: 'rgba(245,158,11,0.08)', border: 'rgba(245,158,11,0.2)',
            text: counts.new === 1
              ? 'You have <strong>1 project</strong> that hasn\'t had a session yet.'
              : 'You have <strong>' + counts.new + ' projects</strong> that haven\'t had a session yet.',
            action: 'Start talking', actionColor: '#f59e0b', actionBg: 'rgba(245,158,11,0.15)', stage: 'new' });
        }
        if (counts.session > 0) {
          nudges.push({ icon: 'üí¨', color: '#1199fa', bg: 'rgba(17,153,250,0.06)', border: 'rgba(17,153,250,0.15)',
            text: counts.session === 1
              ? '<strong>1 project</strong> is in session ‚Äî continue the conversation to move it forward.'
              : '<strong>' + counts.session + ' projects</strong> are in session ‚Äî continue the conversation to move them forward.',
            action: 'Continue session', actionColor: '#1199fa', actionBg: 'rgba(17,153,250,0.15)', stage: 'session' });
        }
        if (counts.design > 0) {
          nudges.push({ icon: 'üìê', color: '#1199fa', bg: 'rgba(17,153,250,0.06)', border: 'rgba(17,153,250,0.15)',
            text: counts.design === 1
              ? '<strong>1 project</strong> has a design ready for your review.'
              : '<strong>' + counts.design + ' projects</strong> have designs ready for your review.',
            action: 'Review design', actionColor: '#1199fa', actionBg: 'rgba(17,153,250,0.15)', stage: 'design' });
        }
        if (counts.proposal > 0) {
          nudges.push({ icon: 'üí∞', color: '#8b5cf6', bg: 'rgba(139,92,246,0.06)', border: 'rgba(139,92,246,0.15)',
            text: counts.proposal === 1
              ? '<strong>1 project</strong> has a proposal awaiting your approval.'
              : '<strong>' + counts.proposal + ' projects</strong> have proposals awaiting your approval.',
            action: 'View proposal', actionColor: '#8b5cf6', actionBg: 'rgba(139,92,246,0.15)', stage: 'proposal' });
        }
        if (counts.approved > 0 && nudges.length === 0) {
          nudges.push({ icon: '‚úÖ', color: '#009e7e', bg: 'rgba(0,158,126,0.06)', border: 'rgba(0,158,126,0.15)',
            text: counts.approved === 1
              ? '<strong>1 project</strong> is approved and in progress. We\'ll keep you updated.'
              : 'All <strong>' + counts.approved + ' projects</strong> are approved and in progress. We\'ll keep you updated.',
            action: null, stage: 'approved' });
        }
        if (nudges.length === 0) {
          nudges.push({ icon: 'üöÄ', color: 'var(--accent-secondary)', bg: 'rgba(0,158,126,0.06)', border: 'rgba(0,158,126,0.15)',
            text: 'All caught up! Ready to <strong>start a new project</strong>?',
            action: 'New Project', actionColor: 'var(--accent-secondary)', actionBg: 'rgba(0,158,126,0.15)', isNew: true });
        }
        %>

        <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:28px;">
          <% nudges.forEach(n => { %>
            <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:<%= n.bg %>;border:1px solid <%= n.border %>;border-radius:12px;">
              <div style="display:flex;align-items:center;gap:12px;">
                <span style="font-size:1.3rem;"><%= n.icon %></span>
                <span style="font-size:0.9rem;color:var(--text-secondary);line-height:1.5;"><%- n.text %></span>
              </div>
              <% if (n.action) { %>
                <% if (n.isNew) { %>
                  <button onclick="toggleNewProject()" style="white-space:nowrap;padding:8px 18px;border-radius:var(--radius-pill);border:none;background:<%= n.actionBg %>;color:<%= n.actionColor %>;font-size:0.82rem;font-weight:600;cursor:pointer;font-family:'Inter',sans-serif;transition:all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'"><%= n.action %> ‚Üí</button>
                <% } else { %>
                  <a href="#stage-<%= n.stage %>" style="white-space:nowrap;padding:8px 18px;border-radius:var(--radius-pill);background:<%= n.actionBg %>;color:<%= n.actionColor %>;font-size:0.82rem;font-weight:600;transition:all 0.2s;display:inline-block;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'"><%= n.action %> ‚Üí</a>
                <% } %>
              <% } %>
            </div>
          <% }) %>
        </div>

        <% const stageOrder = ['approved', 'proposal', 'design', 'session', 'new'];
           stageOrder.forEach(stage => {
             const stageProjects = projects.filter(p => p.stage === stage);
             if (stageProjects.length === 0) return;
             const cfg = stageConfig[stage];
        %>
        <div class="stage-section" id="stage-<%= stage %>">
            <div class="stage-header">
                <span style="font-size: 20px;"><%= cfg.icon %></span>
                <h3><%= cfg.label %></h3>
                <span class="stage-badge" style="background: <%= cfg.bg %>; color: <%= cfg.color %>; border: 1px solid <%= cfg.border %>;"><%= stageProjects.length %></span>
            </div>
            <% stageProjects.forEach(p => { %>
                <a href="/projects/<%= encodeId(p.id) %>" class="project-row">
                    <div>
                        <div class="project-name"><%= p.name %></div>
                        <div class="project-meta">
                            <% if (p.description) { %><%= p.description.substring(0, 80) %><%= p.description.length > 80 ? '...' : '' %> ¬∑ <% } %>
                            üí¨ <%= p.session_count || 0 %> session<%= (p.session_count || 0) === 1 ? '' : 's' %> ¬∑ üìé <%= p.file_count || 0 %> file<%= (p.file_count || 0) === 1 ? '' : 's' %> ¬∑ Updated <%= melbDate(p.updated_at) %>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <% if (stage === 'proposal') { %>
                            <span class="btn btn-sm" style="background: #8b5cf6; box-shadow: 0 0 12px rgba(139,92,246,0.3);">View Proposal</span>
                        <% } else if (stage === 'design') { %>
                            <span class="btn btn-sm" style="background: var(--accent); box-shadow: 0 0 12px var(--accent-glow);">View Design</span>
                        <% } else if (stage === 'approved') { %>
                            <span class="btn btn-sm" style="background: var(--accent-secondary); box-shadow: 0 0 12px rgba(0,158,126,0.3);">View Project</span>
                        <% } else { %>
                            <span class="btn btn-sm btn-success" onclick="event.preventDefault();event.stopPropagation();window.location.href='/projects/<%= encodeId(p.id) %>/session';"><%= (p.session_count || 0) > 0 ? 'üéôÔ∏è Continue' : 'üéôÔ∏è Start' %></span>
                        <% } %>
                    </div>
                </a>
            <% }) %>
        </div>
        <% }) %>

        <% if (typeof sharedProjects !== 'undefined' && sharedProjects.length > 0) { %>
        <div style="margin-top: 32px;">
            <div class="stage-header">
                <span style="font-size: 20px;">üîó</span>
                <h3>Shared with me</h3>
                <span class="stage-badge" style="background: rgba(17,153,250,0.12); color: var(--accent); border: 1px solid rgba(17,153,250,0.3);"><%= sharedProjects.length %></span>
            </div>
            <% sharedProjects.forEach(project => { %>
                <a href="/projects/<%= encodeId(project.id) %>" class="project-row" style="border-left: 3px solid var(--accent);">
                    <div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="project-name"><%= project.name %></span>
                            <span class="shared-label" style="background: <%= project.permission === 'admin' ? 'rgba(139,92,246,0.2)' : 'rgba(17,153,250,0.2)' %>; color: <%= project.permission === 'admin' ? '#8b5cf6' : '#1199fa' %>;"><%= project.permission %></span>
                        </div>
                        <div class="project-meta">
                            <% if (project.description) { %><%= project.description.substring(0, 80) %> ¬∑ <% } %>
                            Shared by <%= project.owner_name %> ¬∑ Updated <%= melbDate(project.updated_at) %>
                        </div>
                    </div>
                    <div style="display: flex; gap: 20px; font-size: 0.82rem; color: var(--text-muted);">
                        <span>üí¨ <%= project.session_count || 0 %></span>
                        <span>üìé <%= project.file_count || 0 %></span>
                    </div>
                </a>
            <% }) %>
        </div>
        <% } %>
    </main>

    <script>
    function toggleNewProject() {
        const form = document.getElementById('newProjectForm');
        const isHidden = form.style.display === 'none';
        form.style.display = isHidden ? 'block' : 'none';
        if (isHidden) {
            setTimeout(() => document.getElementById('newProjectName').focus(), 100);
        }
    }
    <% if (typeof isNewProject !== 'undefined' && isNewProject) { %>
    document.addEventListener('DOMContentLoaded', () => toggleNewProject());
    <% } %>
    </script>

<% } %>

<!-- ==================== FEATURE REQUEST MODAL ==================== -->
<div class="modal-overlay" id="featureModal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h3 style="color:var(--text-primary);font-weight:700;">üí° Submit Feedback</h3>
      <button onclick="document.getElementById('featureModal').style.display='none'" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted);">&times;</button>
    </div>
    <textarea id="featureText" rows="5" placeholder="Tell us what you'd like to see, or what could be better..." style="width:100%;padding:12px;border:1px solid var(--border-glass);border-radius:12px;font-size:0.88rem;font-family:'Inter',sans-serif;resize:vertical;background:rgba(5,13,26,0.6);color:var(--text-primary);"></textarea>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
      <button onclick="document.getElementById('featureModal').style.display='none'" style="padding:10px 24px;border:1px solid var(--border-glass);border-radius:var(--radius-pill);background:transparent;cursor:pointer;font-size:0.88rem;color:var(--text-secondary);font-family:'Inter',sans-serif;">Cancel</button>
      <button onclick="submitFeature()" style="padding:10px 24px;border:none;border-radius:var(--radius-pill);background:var(--accent);color:white;cursor:pointer;font-weight:600;font-size:0.88rem;box-shadow:0 0 16px var(--accent-glow);font-family:'Inter',sans-serif;">Submit</button>
    </div>
    <div id="featureStatus" style="margin-top:8px;font-size:0.82rem;"></div>
  </div>
</div>
<script>
async function submitFeature(){
  const text=document.getElementById('featureText').value.trim();
  if(!text)return;
  const st=document.getElementById('featureStatus');
  st.innerHTML='Submitting...';st.style.color='var(--text-muted)';
  try{
    const r=await fetch('/api/feature-request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,page:'dashboard'})});
    if(!r.ok)throw new Error('Failed');
    st.innerHTML='‚úÖ Thank you! Your feedback has been submitted.';st.style.color='#009e7e';
    document.getElementById('featureText').value='';
    setTimeout(()=>{document.getElementById('featureModal').style.display='none';st.innerHTML='';},2000);
  }catch(e){st.innerHTML='‚ùå Failed to submit. Please try again.';st.style.color='#ef4444';}
}
</script>

</body>
</html>